<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TV Decoder - Esperienza Bry Style</title>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #0a1428 0%, #1e3a5f 50%, #2d5aa0 100%);
      font-family: 'Inter', sans-serif;
      overflow: hidden;
      position: relative;
      height: 100vh;
    }

    /* Schermate di benvenuto e setup - Animazioni ridotte */
    .welcome-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1e4a72 0%, #0137686e 50%, #3b82f600 100%),
                  url('https://brymeteo.github.io/player/decoder/immagini/schermata-home-bry.png');
      background-size: cover;
      background-position: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      color: white;
    }

    .welcome-screen.hidden {
      display: none;
    }

    .welcome-container {
      text-align: center;
      max-width: 600px;
      width: 90%;
    }

    .welcome-title {
      font-size: 56px;
      font-weight: 300;
      margin-bottom: 20px;
      text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      color: white;
      letter-spacing: -1px;
    }

    .welcome-subtitle {
      font-size: 20px;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 60px;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      line-height: 1.5;
      font-weight: 400;
    }

    .start-btn {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      color: white;
      font-size: 18px;
      font-weight: 500;
      padding: 16px 40px;
      cursor: pointer;
      transition: all 0.2s ease;
      backdrop-filter: blur(10px);
      text-transform: none;
      letter-spacing: 0;
    }

    .start-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      border-color: rgba(255, 255, 255, 0.5);
      transform: translateY(-1px);
    }

    /* Schermata aggiornamento */
    .update-screen {
      background: linear-gradient(135deg, #1e4a72 0%, #1641a1 50%, #3a67cc 100%);
    }

    .update-container {
      text-align: center;
      max-width: 700px;
      width: 90%;
    }

    .update-progress {
      width: 100%;
      height: 6px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
      margin: 40px 0;
      overflow: hidden;
    }

    .update-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #ffffff, rgba(255, 255, 255, 0.8));
      border-radius: 3px;
      width: 0%;
      transition: width 0.3s ease;
    }

    .update-status {
      font-size: 19px;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 20px;
      font-weight: 400;
    }

    .update-warning {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      padding: 15px;
      margin-top: 30px;
      color: rgba(255, 255, 255, 0.9);
      font-size: 17px;
      backdrop-filter: blur(10px);
    }

    /* Schermata riavvio */
    .reboot-screen {
      background: #000;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .reboot-logo {
      width: 14%;
      height: auto;
      margin-bottom: -40px;
      position: relative;
    }

    .custom-logo {
      width: 14%;
      height: auto;
      margin-bottom: 40px;
      position: relative;
    }

    .reboot-text {
      font-size: 31px;
      color: white;
      text-align: center;
      margin-bottom: 20px;
      opacity: 0;
      animation: fadeIn 1s ease forwards;
    }

    @keyframes fadeIn {
      to { opacity: 1; }
    }

    .reboot-subtext {
      font-size: 26px;
      color: rgba(255, 255, 255, 0.7);
      text-align: center;
      opacity: 0;
      animation: fadeIn 1s ease 1s forwards;
    }

    /* Schermata di autenticazione PIN */
    .pin-auth-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #1e4a72 0%, #193675 50%, #2c4376 100%);
      background-size: cover;
      background-position: center;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      color: white;
    }

    .pin-auth-screen.hidden {
      display: none;
    }

    .pin-container {
      text-align: center;
      max-width: 500px;
      width: 90%;
    }

    .pin-title {
      font-size: 48px;
      font-weight: 300;
      margin-bottom: 20px;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      letter-spacing: -1px;
    }

    .pin-subtitle {
      font-size: 18px;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 60px;
      text-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
      font-weight: 400;
    }

    .pin-input-section {
      margin-bottom: 40px;
    }

    .pin-label {
      font-size: 16px;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 15px;
      display: block;
      font-weight: 400;
    }

    .pin-input-container {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 30px;
    }

    .pin-digit {
      width: 60px;
      height: 60px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      color: white;
      font-size: 24px;
      font-weight: 600;
      text-align: center;
      outline: none;
      transition: all 0.2s ease;
      backdrop-filter: blur(10px);
    }

    .pin-digit:focus {
      border-color: rgba(255, 255, 255, 0.8);
      background: rgba(255, 255, 255, 0.2);
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
    }

    .pin-digit.filled {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.6);
    }

    .pin-error {
      color: #ff6b6b;
      font-size: 14px;
      margin-top: 10px;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
    }

    .pin-success {
      color: #51cf66;
      font-size: 14px;
      margin-top: 10px;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
    }

    .pin-submit-btn {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      color: white;
      font-size: 16px;
      font-weight: 500;
      padding: 15px 40px;
      cursor: pointer;
      transition: all 0.2s ease;
      backdrop-filter: blur(10px);
      margin-top: 20px;
    }

    .pin-submit-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      border-color: rgba(255, 255, 255, 0.5);
      transform: translateY(-1px);
    }

    .pin-submit-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .pin-exit-btn {
      position: absolute;
      bottom: 40px;
      left: 40px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 25px;
      color: white;
      font-size: 14px;
      padding: 12px 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .pin-exit-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.5);
    }

    /* Schermata scadenza abbonamento */
    .subscription-expired {
    background: linear-gradient(135deg, rgb(19 62 139) 0%, rgb(11 61 119) 50%, rgb(2 68 138) 100%), url(https://brymeteo.github.io/player/decoder/immagini/schermata-home-bry.png);
}

    .subscription-expired .pin-title {
      color: #ffeb3b;
    }

    .subscription-expired .pin-subtitle {
      color: rgba(255, 235, 59, 0.8);
    }

    .expired-icon {
      font-size: 80px;
      margin-bottom: 30px;
      color: #ffeb3b;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
    }

    /* Schermata intro caricamento */
    .loading-intro {
      background: linear-gradient(135deg, #1e4a72 0%, #193573 50%, #193573 100%);
    }

    /* Stili per il testo di caricamento */
    .loading-text {
      font-size: 27px;
      color: white;
      text-align: center;
      margin-top: 30px;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .loading-text.visible {
      opacity: 1;
    }

    /* Pulsante Entra per fullscreen */
    .fullscreen-enter-btn {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      color: white;
      font-size: 18px;
      font-weight: 500;
      padding: 16px 40px;
      cursor: pointer;
      transition: all 0.2s ease;
      backdrop-filter: blur(10px);
      text-transform: none;
      letter-spacing: 0;
      margin-top: 30px;
      opacity: 0;
      transition: all 0.2s ease, opacity 0.5s ease-in-out;
    }

    .fullscreen-enter-btn.visible {
      opacity: 1;
    }

    .fullscreen-enter-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      border-color: rgba(255, 255, 255, 0.5);
      transform: translateY(-1px);
    }

    /* Player principale */
    .main-player {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      z-index: 100;
    }

    #iframe-player {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* Pulsante menu principale - MODIFICA: Inizialmente invisibile */
    .menu-trigger {
      position: fixed;
      left: 30px;
      top: 50%;
      transform: translateY(-50%);
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%);
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 24px;
      cursor: pointer;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      z-index: 300;
      box-shadow: 0 4px 20px rgba(0, 120, 212, 0.4);
    }

    .menu-trigger:hover {
      transform: translateY(-50%) scale(1.05);
      box-shadow: 0 6px 25px rgba(0, 120, 212, 0.6);
    }

    .menu-trigger.visible {
      opacity: 1;
      visibility: visible;
    }

    /* ===== NUOVI STILI PER LA SELEZIONE NUMERICA ===== */
    
    /* Banner informativo modalità numerica */
    .numeric-mode-banner {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%);
      color: white;
      padding: 15px 30px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      z-index: 2500;
      box-shadow: 0 4px 20px rgba(0, 120, 212, 0.4);
      opacity: 0;
      transform: translateX(-50%) translateY(-10px);
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      text-align: center;
      min-width: 400px;
    }

    .numeric-mode-banner.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .numeric-mode-banner .banner-icon {
      font-size: 20px;
      margin-right: 10px;
      vertical-align: middle;
    }

    .numeric-input-overlay {
    position: fixed;
    top: 63.9%;
    left: 14.9%;
    transform: translate(-50%, -50%);
    background: rgb(255 255 255 / 95%);
    color: #18597a;
    padding: 6px 1px;
    border-radius: 12px;
    font-size: 42px;
    font-weight: 600;
    z-index: 3000;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    opacity: 0;
    visibility: hidden;
    transition: all 0.2s 
ease;
    backdrop-filter: blur(10px);
    border: 2px solid rgba(0, 120, 212, 0.3);
    min-width: 150px;
    text-align: center;
    font-family: sans-serif;
}

    .numeric-input-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    /* Overlay di errore per canale non trovato */
    .channel-error-overlay {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #ff4444;
      color: white;
      padding: 20px 30px;
      border-radius: 12px;
      font-size: 24px;
      font-weight: 600;
      z-index: 3000;
      box-shadow: 0 8px 32px rgba(255, 68, 68, 0.4);
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s ease;
      text-align: center;
      min-width: 300px;
    }

    .channel-error-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    /* ===== NUOVO POPUP PER PROGRAMMAZIONE CANALE ===== */
    .schedule-popup {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 3000;
    }

    .schedule-popup.show {
      display: flex;
    }

    .schedule-popup-content {
      background: linear-gradient(135deg, #003d82 0%, #1e4a72 100%);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 16px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      text-align: center;
      color: white;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
    }

    .schedule-popup-title {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 15px;
      color: #ffd700;
    }

    .schedule-popup-subtitle {
      font-size: 16px;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 25px;
      line-height: 1.5;
    }

    .schedule-popup-program-info {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 25px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .schedule-popup-program-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .schedule-popup-program-time {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.8);
    }

    .schedule-popup-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-direction: column;
    }

    .schedule-popup-btn {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      color: white;
      font-size: 16px;
      font-weight: 500;
      padding: 12px 24px;
      cursor: pointer;
      transition: all 0.2s ease;
      backdrop-filter: blur(10px);
      min-width: 140px;
    }

    .schedule-popup-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      border-color: rgba(255, 255, 255, 0.5);
      transform: translateY(-1px);
    }

    .schedule-popup-btn.primary {
      background: linear-gradient(135deg, #ffd700 0%, #ffb300 100%);
      color: #000;
      border-color: #ffd700;
    }

    .schedule-popup-btn.primary:hover {
      background: linear-gradient(135deg, #ffed4e 0%, #ffd700 100%);
      box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
    }

    .schedule-popup-btn.focused {
      background: rgba(255, 255, 255, 0.3);
      border-color: #ffffff;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
    }

    .schedule-popup-btn.primary.focused {
      background: linear-gradient(135deg, #ffed4e 0%, #ffd700 100%);
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
    }

    /* Pannello principale stile Sky - Transizioni ridotte */
    .sky-panel {
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #003d82 0%, #122c3fe8 100%);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s ease, visibility 0.2s ease;
      display: flex;
      flex-direction: column;
      zoom: 110%;
    }

    .sky-panel.active {
      opacity: 1;
      visibility: visible;
    }

    /* Header Sky */
    .sky-header {
      background: linear-gradient(90deg, #001f3f 0%, #003d82 100%);
      padding: 20px 40px;
      border-bottom: 2px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .sky-logo {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .sky-logo img {
      height: 70px;
      width: auto;
      object-fit: contain;
    }

    .sky-logo-text {
      font-size: 24px;
      font-weight: 700;
      color: white;
      letter-spacing: 2px;
    }

    .sky-logo-subtitle {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.7);
      font-weight: 400;
      text-align: center;
      margin-top: -4px;
    }

    /* Info abbonamento nell'header */
    .subscription-info {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      background: rgba(255, 255, 255, 0.1);
      padding: 15px 20px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .user-name {
      font-size: 16px;
      font-weight: 600;
      color: white;
    }

    .days-remaining {
      font-size: 14px;
      color: #4fc3f7;
      font-weight: 500;
    }

    .days-remaining.warning {
      color: #ffeb3b;
    }

    .days-remaining.critical {
  color: #ff6b6b;
}


    .sky-nav {
      display: flex;
      gap: 30px;
    }

    .nav-item {
      padding: 12px 24px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 25px;
      color: white;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .nav-item:hover, .nav-item.active {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.4);
    }

    /* Contenuto principale */
    .sky-content {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    /* Sidebar categorie */
    .categories-sidebar {
    width: 300px;
    background: rgba(0, 0, 0, 0.3);
    border-right: 1px solid rgba(255, 255, 255, 0.1);
    overflow: auto;
}

/* Nasconde la scrollbar */
.categories-sidebar::-webkit-scrollbar {
    display: none;
}


    .category-item {
      padding: 20px 25px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .category-item:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .category-item.active {
      background: linear-gradient(90deg, rgba(0, 120, 212, 0.4) 0%, rgba(0, 120, 212, 0.2) 100%);
      border-left: 4px solid #0078d4;
    }

    .category-item.focused {
      background: rgba(255, 255, 255, 0.15);
      border-left: 4px solid #ffffff;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
    }

    .category-icon {
      width: 24px;
      height: 24px;
      filter: brightness(0) invert(1);
    }

    .category-name {
      font-weight: 500;
      font-size: 16px;
    }

    /* Lista canali principale */
    .channels-main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .channels-header {
      padding: 25px 30px;
      background: rgba(0, 0, 0, 0.2);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .channels-title {
      font-size: 24px;
      font-weight: 600;
      color: white;
      margin-bottom: 10px;
    }

    .channels-subtitle {
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
      line-height: 1.5;
    }

    .channels-grid {
      flex: 1;
      overflow-y: auto;
      padding: 0;
    }

    .channels-grid::-webkit-scrollbar {
      width: 8px;
    }

    .channels-grid::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.1);
    }

    .channels-grid::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 4px;
    }

    /* Elementi canale - Animazioni ridotte */
    .channel-item {
      display: flex;
      align-items: center;
      padding: 15px 30px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      color: white;
      cursor: pointer;
      transition: all 0.15s ease;
      position: relative;
    }

    .channel-item:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .channel-item.selected {
      background: linear-gradient(90deg, rgba(0, 120, 212, 0.3) 0%, rgba(0, 120, 212, 0.1) 100%);
      border-left: 4px solid #0078d4;
    }

    .channel-item.selected::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: #0078d4;
    }

    .channel-logo {
      height: 60px;
      object-fit: contain;
      margin-right: 20px;
      border-radius: 4px;
    }

    .channel-details {
      flex: 1;
    }

    .channel-name-main {
      font-size: 16px;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .channel-number-main {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.6);
      font-weight: 400;
    }

    .channel-status {
      padding: 4px 12px;
      background: rgba(0, 120, 212, 0.2);
      border: 1px solid rgba(0, 120, 212, 0.4);
      border-radius: 12px;
      font-size: 12px;
      color: #4fc3f7;
      font-weight: 500;
      margin-right: 10px;
    }

    .favorite-star {
      font-size: 20px;
      color: #ffd700;
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
    }

    .favorite-star:hover {
      transform: scale(1.1);
    }

    .favorite-star.empty {
      color: rgba(255, 255, 255, 0.3);
    }

    /* Controlli inferiori */
    .sky-controls {
      background: rgba(0, 0, 0, 0.4);
      padding: 20px 30px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .control-group {
      display: flex;
      gap: 15px;
    }

    .control-btn {
      padding: 12px 20px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      color: white;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .control-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.4);
    }

    .control-icon {
      width: 16px;
      height: 16px;
      filter: brightness(0) invert(1);
    }

    /* Hint di navigazione - MODIFICA: Aggiornato per includere le frecce */
    .navigation-hint {
      background: rgb(22 71 103 / 60%);
      color: white;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 12px;
      text-align: center;
    }

    /* Pulsante chiudi */
    .close-panel {
      position: absolute;
      top: 46px;
      right: 490px;
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      color: white;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      z-index: 1001;
    }

    .close-panel:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    /* Overlay vocale - Animazioni ridotte */
    .voice-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 61, 130, 0.95);
      backdrop-filter: blur(10px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .voice-container {
      text-align: center;
      color: white;
    }

    .voice-icon {
      width: 120px;
      height: 120px;
      background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 30px;
      box-shadow: 0 0 40px rgba(0, 120, 212, 0.5);
    }

    .voice-icon img {
      width: 60px;
      height: 60px;
      filter: brightness(0) invert(1);
    }

    .voice-text {
      font-size: 24px;
      font-weight: 500;
      margin-bottom: 10px;
    }

    .voice-subtitle {
      font-size: 16px;
      color: rgba(255, 255, 255, 0.7);
    }

    /* Fullscreen button */
    .fullscreen-btn {
      position: fixed;
      top: 48px;
      right: 600px;
      width: 50px;
      height: 50px;
      background: rgba(0, 0, 0, 0.7);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      color: white;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: all 0.2s ease;
      z-index: 1500;
    }

    .fullscreen-btn:hover {
      background: rgba(0, 0, 0, 0.9);
    }

    .fullscreen-btn.visible {
      opacity: 1;
    }

    /* Sistema notifiche modalità preferiti - Animazioni ridotte */
    .favorites-notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #0078d4 0%, #106ebe 100%);
      color: white;
      padding: 15px 30px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      z-index: 2500;
      box-shadow: 0 4px 20px rgba(0, 120, 212, 0.4);
      opacity: 0;
      transform: translateX(-50%) translateY(-10px);
      transition: all 0.2s ease;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      text-align: center;
      min-width: 300px;
    }

    .favorites-notification.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .favorites-notification.favorites-mode {
      background: linear-gradient(135deg, #ffd700 0%, #ffb300 100%);
      color: #000;
      box-shadow: 0 4px 20px rgba(255, 215, 0, 0.4);
    }

    .favorites-notification .notification-icon {
      font-size: 20px;
      margin-right: 10px;
      vertical-align: middle;
    }

    /* STILI MOSAICO - Animazioni ridotte */
    .mosaic-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #0a1428 0%, #1e3a5ff7 50%, #2d5aa02e 100%);
      z-index: 1500;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s ease, visibility 0.2s ease;
      display: flex;
      flex-direction: column;
    }

    .mosaic-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .mosaic-header {
      background: linear-gradient(90deg, #001f3f 0%, #003d82 100%);
      padding: 20px 40px;
      border-bottom: 2px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .mosaic-title {
      font-size: 28px;
      font-weight: 600;
      color: white;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .mosaic-close {
      width: 50px;
      height: 50px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      color: white;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .mosaic-close:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.05);
    }

    .mosaic-content {
      flex: 1;
      padding: 2%;
      overflow-y: auto;
    }

    .mosaic-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(20%, 1fr));
      column-gap: 2%;
      row-gap: 0.5%;
      max-width: 95%;
      margin: 0 auto;
    }

    .mosaic-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s ease;
      backdrop-filter: blur(10px);
      position: relative;
      min-height: 530px;
    }

    .mosaic-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(0, 120, 212, 0.3);
      border-color: rgba(0, 120, 212, 0.5);
    }

    .mosaic-card.selected {
      border-color: #0078d4;
      box-shadow: 0 0 20px rgba(0, 120, 212, 0.6);
      transform: translateY(-2px);
    }

    .mosaic-card-header {
      display: flex;
      align-items: center;
      padding: 4%;
      background: rgba(0, 0, 0, 0.3);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .mosaic-channel-logo {
      height: auto;
      max-height: 80px;
      object-fit: contain;
      border-radius: 6px;
      margin-right: 4%;
      background: rgba(255, 255, 255, 0.1);
      padding: 2%;
    }

    .mosaic-channel-info {
      flex: 1;
    }

    .mosaic-channel-name {
      font-size: 1.6em;
      font-weight: 600;
      color: white;
      margin-bottom: 0.3em;
    }

    .mosaic-channel-number {
      font-size: 1.1em;
      color: rgba(255, 255, 255, 0.7);
    }

    .mosaic-program-poster {
      width: 100%;
      height: 40%;
      min-height: 235px;
      object-fit: cover;
      background: linear-gradient(135deg, #1e3a5f 0%, #2d5aa0 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(255, 255, 255, 0.5);
      font-size: 0.9em;
    }

    .mosaic-program-info {
      padding: 4%;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .mosaic-program-title {
      font-size: 1.5em;
      font-weight: 600;
      color: white;
      margin-bottom: 0.5em;
      line-height: 1.3;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      flex-grow: 1;
    }

    .mosaic-program-time {
      font-size: 1.2em;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 0.7em;
    }

    .mosaic-progress-container {
      margin-top: auto;
    }

    .mosaic-progress-bar {
      width: 100%;
      height: 9px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 2px;
      overflow: hidden;
    }

    .mosaic-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #0078d4 0%, #4fc3f7 100%);
      border-radius: 2px;
      transition: width 0.3s ease;
    }

    .mosaic-progress-text {
      font-size: 1.0em;
      color: rgba(255, 255, 255, 0.6);
      margin-top: 0.3em;
      text-align: center;
    }

    .mosaic-controls {
      background: rgba(0, 0, 0, 0.4);
      padding: 20px 40px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .mosaic-hint {
      background: rgba(22, 71, 103, 0.6);
      color: white;
      padding: 12px 25px;
      border-radius: 8px;
      font-size: 14px;
      text-align: center;
    }

    /* Indicatore di caricamento per il mosaico */
    .mosaic-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      z-index: 10;
    }

    .mosaic-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255, 255, 255, 0.2);
      border-top: 4px solid #0078d4;
      border-radius: 50%;
      animation: mosaicSpin 1s linear infinite;
    }

    @keyframes mosaicSpin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .mosaic-loading-text {
      color: white;
      font-size: 18px;
      font-weight: 500;
      text-align: center;
    }

    .mosaic-content.loading {
      position: relative;
    }

    .mosaic-content.loading .mosaic-grid {
      opacity: 0.3;
      pointer-events: none;
    }

    /* ===== STILI MOSAICO FILTRATO (TASTO 7) ===== */
    .filtered-mosaic-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #0a1428 0%, #1e3a5ff7 50%, #2d5aa02e 100%);
      z-index: 1600;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s ease, visibility 0.2s ease;
      display: flex;
      flex-direction: column;
    }

    .filtered-mosaic-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .filtered-mosaic-header {
      background: linear-gradient(90deg, #001f3f 0%, #003d82 100%);
      padding: 20px 40px;
      border-bottom: 2px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .filtered-mosaic-title {
      font-size: 28px;
      font-weight: 600;
      color: white;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .filtered-mosaic-close {
      width: 50px;
      height: 50px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      color: white;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .filtered-mosaic-close:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.05);
    }

    .filtered-mosaic-content {
      flex: 1;
      display: flex;
      overflow: hidden;
    }

    /* Sidebar filtri per mosaico */
    .filtered-mosaic-sidebar {
      width: 300px;
      background: rgba(0, 0, 0, 0.4);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .filtered-mosaic-sidebar-header {
      padding: 25px;
      background: rgba(0, 0, 0, 0.3);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .filtered-mosaic-sidebar-title {
      font-size: 20px;
      font-weight: 600;
      color: white;
      margin-bottom: 10px;
    }

    .filtered-mosaic-sidebar-subtitle {
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
      line-height: 1.4;
    }

    .filtered-category-item {
      padding: 18px 25px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      color: white;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 15px;
      position: relative;
    }

    .filtered-category-item:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .filtered-category-item.active {
      background: linear-gradient(90deg, rgba(0, 120, 212, 0.4) 0%, rgba(0, 120, 212, 0.2) 100%);
      border-left: 4px solid #0078d4;
    }

    .filtered-category-item.focused {
      background: rgba(255, 255, 255, 0.15);
      border-left: 4px solid #ffffff;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
    }

    .filtered-category-icon {
    width: 28px;
    height: 28px;
    filter: brightness(0) invert(1);
    flex-shrink: 0;
}

    .filtered-category-name {
    font-weight: 500;
    font-size: 19px;
    flex: 1;
}

    .filtered-category-count {
    background: rgba(255, 255, 255, 0.2);
    color: rgba(255, 255, 255, 0.9);
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 15px;
    font-weight: 500;
    min-width: 24px;
    text-align: center;
}

    /* Area principale del mosaico filtrato */
    .filtered-mosaic-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .filtered-mosaic-main-header {
      padding: 25px 30px;
      background: rgba(0, 0, 0, 0.2);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .filtered-mosaic-main-title {
      font-size: 24px;
      font-weight: 600;
      color: white;
      margin-bottom: 8px;
    }

    .filtered-mosaic-main-subtitle {
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
      line-height: 1.5;
    }

    /* ===== NUOVI STILI PER LA FASCIA ORARIA ===== */
    .time-navigation {
      display: flex;
      align-items: center;
      gap: 15px;
      background: rgba(255, 255, 255, 0.1);
      padding: 12px 20px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .time-nav-btn {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 6px;
      color: white;
      font-size: 14px;
      font-weight: 500;
      padding: 8px 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .time-nav-btn:hover {
      background: rgba(255, 255, 255, 0.25);
      border-color: rgba(255, 255, 255, 0.5);
    }

    .time-nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .time-nav-btn.focused {
      background: rgba(255, 255, 255, 0.3);
      border-color: #ffffff;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
    }

    .current-time-display {
      font-size: 16px;
      font-weight: 600;
      color: white;
      min-width: 120px;
      text-align: center;
    }

    .time-indicator {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.7);
      margin-top: 2px;
    }

    .filtered-mosaic-grid-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    .filtered-mosaic-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 2fr));
    gap: 20px;
    max-width: 100%;
}

    .filtered-mosaic-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s ease;
      backdrop-filter: blur(10px);
      position: relative;
      min-height: 450px;
      display: flex;
      flex-direction: column;
    }

    .filtered-mosaic-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 30px rgba(0, 120, 212, 0.3);
      border-color: rgba(0, 120, 212, 0.5);
    }

    .filtered-mosaic-card.selected {
    border-color: #ffffff;
    box-shadow: 0 0 20px rgb(255 255 255 / 60%);
    transform: translateY(-2px);
}

    /* ===== NUOVO STILE PER PROGRAMMI FUTURI ===== */
    .filtered-mosaic-card.future-program {
      border-color: #ffd700;
      
    }

    .filtered-mosaic-card.future-program:hover {
      border-color: #ffed4e;
      box-shadow: 0 10px 30px rgba(255, 215, 0, 0.6);
    }

    .filtered-mosaic-card.future-program .filtered-mosaic-program-time {
      color: #ffd700;
      font-weight: 600;
    }

    .filtered-mosaic-card-header {
      display: flex;
      align-items: center;
      padding: 15px;
      background: rgba(0, 0, 0, 0.3);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .filtered-mosaic-channel-logo {
    /* height: 60px; */
    width: 130px;
    object-fit: contain;
    border-radius: 6px;
    margin-right: 15px;
    background: rgba(255, 255, 255, 0.1);
    padding: 8px;
    flex-shrink: 0;
}

    .filtered-mosaic-channel-info {
      flex: 1;
      min-width: 0;
    }

    .filtered-mosaic-channel-name {
    font-size: 22px;
    font-weight: 600;
    color: white;
    margin-bottom: 4px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

    .filtered-mosaic-channel-number {
    font-size: 18px;
    color: rgba(255, 255, 255, 0.7);
}

    .filtered-mosaic-program-poster {
      width: 100%;
      height: 200px;
      object-fit: cover;
      background: linear-gradient(135deg, #1e3a5f 0%, #2d5aa0 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(255, 255, 255, 0.5);
      font-size: 14px;
    }

    .filtered-mosaic-program-info {
      padding: 15px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .filtered-mosaic-program-title {
    font-size: 24px;
    font-weight: 600;
    color: white;
    margin-bottom: 8px;
    line-height: 1.3;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    flex-grow: 1;
}

    .filtered-mosaic-program-time {
    font-size: 20px;
    color: rgba(255, 255, 255, 0.7);
    margin-bottom: 12px;
}

    .filtered-mosaic-progress-container {
      margin-top: auto;
    }

    .filtered-mosaic-progress-bar {
    width: 100%;
    height: 10px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 3px;
    overflow: hidden;
    margin-bottom: 8px;
}

    .filtered-mosaic-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #0078d4 0%, #4fc3f7 100%);
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    .filtered-mosaic-progress-text {
    font-size: 17px;
    color: rgba(255, 255, 255, 0.6);
    text-align: center;
}

    .filtered-mosaic-controls {
      background: rgba(0, 0, 0, 0.4);
      padding: 20px 40px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .filtered-mosaic-hint {
      background: rgba(22, 71, 103, 0.6);
      color: white;
      padding: 12px 25px;
      border-radius: 8px;
      font-size: 14px;
      text-align: center;
    }

    /* Indicatore di caricamento per il mosaico filtrato */
    .filtered-mosaic-loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      z-index: 10;
    }

    .filtered-mosaic-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255, 255, 255, 0.2);
      border-top: 4px solid #0078d4;
      border-radius: 50%;
      animation: filteredMosaicSpin 1s linear infinite;
    }

    @keyframes filteredMosaicSpin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .filtered-mosaic-loading-text {
      color: white;
      font-size: 18px;
      font-weight: 500;
      text-align: center;
    }

    .filtered-mosaic-grid-container.loading {
      position: relative;
    }

    .filtered-mosaic-grid-container.loading .filtered-mosaic-grid {
      opacity: 0.3;
      pointer-events: none;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sky-content {
        flex-direction: column;
      }
      
      .categories-sidebar {
        width: 100%;
        height: 200px;
        overflow-x: auto;
        overflow-y: hidden;
        display: flex;
      }
      
      .category-item {
        min-width: 150px;
        border-right: 1px solid rgba(255, 255, 255, 0.1);
        border-bottom: none;
      }
      
      .sky-nav {
        display: none;
      }
      
      .sky-header {
        padding: 15px 20px;
      }
      
      .channels-header, .channel-item, .sky-controls {
        padding-left: 20px;
        padding-right: 20px;
      }

      .pin-container, .welcome-container, .update-container {
        padding: 20px;
      }

      .pin-title, .welcome-title {
        font-size: 36px;
      }

      .pin-digit {
        width: 50px;
        height: 50px;
        font-size: 20px;
      }

      .subscription-info {
        padding: 10px 15px;
      }

      .user-name {
        font-size: 14px;
      }

      .days-remaining {
        font-size: 12px;
      }

      .mosaic-grid {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        padding: 0 15px;
      }

      .mosaic-header, .mosaic-controls {
        padding: 15px 20px;
      }

      /* Responsive per mosaico filtrato */
      .filtered-mosaic-content {
        flex-direction: column;
      }
      
      .filtered-mosaic-sidebar {
        width: 100%;
        height: 200px;
        overflow-x: auto;
        overflow-y: hidden;
        display: flex;
        flex-direction: row;
      }
      
      .filtered-category-item {
        min-width: 200px;
        border-right: 1px solid rgba(255, 255, 255, 0.1);
        border-bottom: none;
        flex-shrink: 0;
      }
      
      .filtered-mosaic-grid {
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
      }
      
      .filtered-mosaic-header, .filtered-mosaic-controls {
        padding: 15px 20px;
      }

      /* Responsive per overlay numerici */
      .numeric-mode-banner {
        min-width: 300px;
        font-size: 14px;
        padding: 12px 20px;
      }

      .numeric-input-overlay {
        font-size: 36px;
        padding: 15px 25px;
        min-width: 150px;
      }

      .channel-error-overlay {
        font-size: 18px;
        padding: 15px 20px;
        min-width: 250px;
      }

      /* Responsive per popup programmazione */
      .schedule-popup-content {
        padding: 20px;
        max-width: 400px;
      }

      .schedule-popup-title {
        font-size: 20px;
      }

      .schedule-popup-buttons {
        flex-direction: column;
      }

      .schedule-popup-btn {
        min-width: auto;
      }

      /* Responsive per navigazione temporale */
      .time-navigation {
        flex-direction: column;
        gap: 10px;
        padding: 15px;
      }

      .current-time-display {
        min-width: auto;
      }
    }

    /* Indicatore di caricamento */
    .loading-indicator {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 18px;
      z-index: 1001;
    }

    /* Contatore utenti online - Stile nascosto */
    .online-counter {
      position: fixed;
      top: -100px;
      left: -100px;
      width: 1px;
      height: 1px;
      opacity: 0;
      pointer-events: none;
      z-index: -1;
      font-size: 1px;
      color: transparent;
    }

    /* Statistiche canali - Stile nascosto */
    .channel-stats {
      position: absolute;
      top: -1000px;
      left: -1000px;
      width: 1px;
      height: 1px;
      opacity: 0;
      pointer-events: none;
      z-index: -1;
    }

  </style>
</head>
<body>

  <!-- Contatore utenti online nascosto -->
  <div class="online-counter" id="online-counter">0</div>
  
  <!-- Statistiche canali nascoste -->
  <div class="channel-stats" id="channel-stats"></div>

  <!-- ===== NUOVI ELEMENTI PER LA SELEZIONE NUMERICA ===== -->
  
  <!-- Banner modalità numerica -->
  <div class="numeric-mode-banner" id="numeric-mode-banner">
    <span class="banner-icon">🔢</span>
    <span>Modalità selezione numerica attiva - Digita il numero del canale</span>
  </div>

  <!-- Overlay per la digitazione dei numeri -->
  <div class="numeric-input-overlay" id="numeric-input-overlay">
    <span id="numeric-display">---</span>
  </div>

  <!-- Overlay di errore per canale non trovato -->
  <div class="channel-error-overlay" id="channel-error-overlay">
    <span>Canale non trovato</span>
  </div>

  <!-- ===== NUOVO POPUP PER PROGRAMMAZIONE CANALE ===== -->
  <div class="schedule-popup" id="schedule-popup">
    <div class="schedule-popup-content">
      <div class="schedule-popup-title">Programma Futuro Selezionato</div>
      <div class="schedule-popup-subtitle">Questo programma inizierà in futuro. Cosa desideri fare?</div>
      
      <div class="schedule-popup-program-info" id="schedule-popup-program-info">
        <div class="schedule-popup-program-title" id="schedule-popup-program-title">Nome Programma</div>
        <div class="schedule-popup-program-time" id="schedule-popup-program-time">Orario</div>
      </div>
      
      <div class="schedule-popup-buttons">
        <button class="schedule-popup-btn primary" id="schedule-btn">
          📅 Programma Cambio Canale
        </button>
        <button class="schedule-popup-btn" id="watch-now-btn">
          ▶️ Guarda Ora
        </button>
        <button class="schedule-popup-btn" id="cancel-schedule-btn">
          ❌ Annulla
        </button>
      </div>
    </div>
  </div>

  <!-- Schermata di benvenuto iniziale -->
  <div class="welcome-screen" id="welcome-screen">
    <div class="welcome-container">
      <h1 class="welcome-title">Benvenuto in Bry OS</h1>
      <p class="welcome-subtitle">Il sistema operativo per il tuo decoder digitale di nuova generazione</p>
      <button class="start-btn" id="start-btn">Inizia</button>
    </div>
  </div>

  <!-- Schermata aggiornamento software -->
  <div class="welcome-screen update-screen hidden" id="update-screen">
    <div class="update-container">
      <h1 class="welcome-title">Aggiornamento Software</h1>
      <p class="welcome-subtitle">Stiamo aggiornando il tuo decoder con le ultime funzionalità</p>
      
      <div class="update-progress">
        <div class="update-progress-bar" id="update-progress-bar"></div>
      </div>
      
      <div class="update-status" id="update-status">Inizializzazione...</div>
      
      <div class="update-warning">
        ⚠️ Non chiudere la pagina fino al completamento dell'operazione
      </div>
    </div>
  </div>

  <!-- Schermata riavvio -->
  <div class="welcome-screen reboot-screen hidden" id="reboot-screen">
    <img src="https://i.ibb.co/wFgnHn3m/bry-logo-ufficiale5.png" alt="Logo" class="custom-logo">
    <div class="reboot-text hidden" id="loading-text">Caricamento in corso...</div>
    <div class="reboot-subtext hidden" id="optimization-text">Ottimizzazione del decoder e aggiornamento software</div>
  </div>

  <!-- Schermata benvenuto post-riavvio -->
  <div class="welcome-screen post-reboot-screen hidden" id="post-reboot-screen">
    <div class="welcome-container">
      <h1 class="welcome-title">Benvenuto in Bry OS</h1>
      <p class="welcome-subtitle">Sistema aggiornato con successo. Pronto per l'utilizzo.</p>
      <button class="start-btn" id="post-reboot-start-btn">Inizia</button>
    </div>
  </div>

  <!-- Schermata intro caricamento -->
  <div class="welcome-screen loading-intro hidden" id="loading-intro">
    <img src="https://i.ibb.co/wFgnHn3m/bry-logo-ufficiale5.png" alt="Logo" class="reboot-logo">
    <br><br>
    <div class="loading-text" id="loading-intro-text">Caricamento in corso...</div>
    <button class="fullscreen-enter-btn" id="fullscreen-enter-btn">Entra</button>
  </div>

  <!-- Schermata di autenticazione PIN -->
  <div class="pin-auth-screen hidden" id="pin-auth-screen">
    <div class="pin-container">
      <div class="expired-icon" id="expired-icon" style="display: none;">⚠️</div>
      <h1 class="pin-title" id="pin-title">Inserisci il tuo PIN</h1>
      <p class="pin-subtitle" id="pin-subtitle">Recupera il PIN dal tuo account: https://brytv.webnode.it/area/bryid</p>
      
      <div class="pin-input-section">
        <label class="pin-label">Inserisci il tuo PIN da 5 cifre</label>
        <div class="pin-input-container">
          <input type="password" class="pin-digit" maxlength="1" data-index="0">
          <input type="password" class="pin-digit" maxlength="1" data-index="1">
          <input type="password" class="pin-digit" maxlength="1" data-index="2">
          <input type="password" class="pin-digit" maxlength="1" data-index="3">
          <input type="password" class="pin-digit" maxlength="1" data-index="4">
        </div>
        <div id="pin-error" class="pin-error" style="display: none;"></div>
        <div id="pin-success" class="pin-success" style="display: none;"></div>
      </div>

      <button class="pin-submit-btn" id="pin-submit-btn" disabled>Conferma PIN</button>
    </div>
    
    <button class="pin-exit-btn" onclick="window.close()">
      <span>←</span>
      <span>Premi per uscire dal Mio Account e chiudere il decoder</span>
    </button>
  </div>

  <!-- Player principale -->
  <div class="main-player">
    <iframe id="iframe-player" src="" allowfullscreen></iframe>
    <div class="loading-indicator" id="loading-indicator" style="display: none;"></div>
  </div>

  <!-- Pulsante menu -->
  <button class="menu-trigger" id="menu-trigger">☰</button>

  <!-- Pulsante fullscreen -->
  <button class="fullscreen-btn" id="fullscreen-btn">⛶</button>

  <!-- Pannello principale Sky -->
  <div class="sky-panel" id="sky-panel">
    <button class="close-panel" id="close-panel">×</button>
    
    <div class="sky-header">
      <div class="sky-logo">
        <img src="https://i.ibb.co/wFgnHn3m/bry-logo-ufficiale5.png" alt="Sky Decoder Logo">
        <div class="sky-logo-subtitle">Decoder Bry View Os Digitale</div>
      </div>

      <!-- Info abbonamento -->
      <div class="subscription-info">
        <div class="user-name" id="user-name">Utente Premium</div>
        <div class="days-remaining" id="days-remaining">30 giorni rimanenti</div>
      </div>

      <div class="sky-nav">
        <div class="nav-item" id="mosaic-nav-btn">Mosaico</div>
        <div class="nav-item">On Demand</div>
      </div>
    </div>

    <div class="sky-content">
      <div class="categories-sidebar">
        <div class="category-item" data-category="tutti">
          <img class="category-icon" src="https://images-2.rakuten.tv/storage/live-channel-category/icon_img/5b32c853-642f-4065-a0f2-668d4b5e369f-live_channel_category-1644409517.png" alt="Tutti">
          <span class="category-name">Tutti i Canali</span>
        </div>
        <div class="category-item" data-category="nazionali">
          <img class="category-icon" src="https://i.ibb.co/443bkqh/Featured-Copy.png" alt="Nazionali">
          <span class="category-name">Nazionali</span>
        </div>
        <div class="category-item" data-category="show">
          <img class="category-icon" src="https://i.ibb.co/B3YhYn1/svg-Image-Url-1636912584809.png" alt="Show">
          <span class="category-name">Show & Serie</span>
        </div>
        <div class="category-item" data-category="generali">
          <img class="category-icon" src="https://images-1.rakuten.tv/storage/live-channel-category/icon_img/565cb4c0-89f6-450e-9536-08ac90ded10c-live_channel_category-1644403535.png" alt="Generali">
          <span class="category-name">Generali</span>
        </div>
        <div class="category-item" data-category="sport">
          <img class="category-icon" src="https://images-0.rakuten.tv/storage/live-channel-category/icon_img/3b138108-343f-4b09-8a74-3af0f400242f-live_channel_category-1644403549.png" alt="Sport">
          <span class="category-name">Sport</span>
        </div>
        <div class="category-item" data-category="cinema">
          <img class="category-icon" src="https://images-2.rakuten.tv/storage/live-channel-category/icon_img/aea198b1-bcd3-43c7-93f8-bc3828d111ec-live_channel_category-1644403493.png" alt="Cinema">
          <span class="category-name">Cinema</span>
        </div>
        <div class="category-item" data-category="documentari">
          <img class="category-icon" src="https://images-0.rakuten.tv/storage/live-channel-category/icon_img/29980e21-8ed7-4295-bb34-47a81733f3ff-live_channel_category-1644403705.png" alt="Documentari">
          <span class="category-name">Documentari</span>
        </div>
        <div class="category-item" data-category="cucina">
          <img class="category-icon" src="https://images-0.rakuten.tv/storage/live-channel-category/icon_img/1efcc183-53ea-4d2e-be52-984d5d46e8f6-live_channel_category-1644403582.png" alt="cucina">
          <span class="category-name">Cucina</span>
        </div>
        <div class="category-item" data-category="news">
          <img class="category-icon" src="https://images-0.rakuten.tv/storage/live-channel-category/icon_img/d206f902-c713-42db-b472-b9442f2dbb28-live_channel_category-1644403719.png" alt="News">
          <span class="category-name">News & Meteo</span>
        </div>
        <div class="category-item" data-category="bambini">
          <img class="category-icon" src="https://images-2.rakuten.tv/storage/live-channel-category/icon_img/92e98439-8c9b-4d43-a9d6-3d7e9ea1f62e-live_channel_category-1644403620.png" alt="Bambini">
          <span class="category-name">Bambini</span>
        </div>
        <div class="category-item" data-category="musica">
          <img class="category-icon" src="https://images-1.rakuten.tv/storage/live-channel-category/icon_img/dddd10c5-89f0-4a50-8f19-dbd46e0ee2cb-live_channel_category-1644403607.png" alt="Musica">
          <span class="category-name">Musica & Radio</span>
        </div>
        <div class="category-item" data-category="preferiti">
          <img class="category-icon" src="https://www.rakuten.tv/static/media/Heart.a811332e.svg" alt="Preferiti">
          <span class="category-name">Preferiti</span>
        </div>
      </div>

      <div class="channels-main">
        <div class="channels-header">
          <div class="channels-title">TUTTI I CANALI</div>
          <div class="channels-subtitle">Seleziona un canale dalla lista per iniziare la visione. Usa le frecce per navigare o il comando vocale per una ricerca rapida.</div>
        </div>

        <div class="channels-grid" id="channels-grid">
          <!-- Canali Nazionali -->
          <div class="channel-item selected" data-channel="video1.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/101-Rai1.html" data-number="101" data-category="nazionali" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="rai-1">
            <img src="https://api.superguidatv.it/v1/channels/217/logo?width=320&theme=dark" alt="Rai 1" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Rai 1 HD</div>
              <div class="channel-number-main">Canale 101</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>

          <div class="channel-item" data-channel="video2.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/102-Rai2.html" data-number="102" data-category="nazionali" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="rai-2">
            <img src="https://api.superguidatv.it/v1/channels/218/logo?width=320&theme=dark" alt="Rai 2" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Rai 2 HD</div>
              <div class="channel-number-main">Canale 102</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>

          <div class="channel-item" data-channel="video3.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/103-Rai3.html" data-number="103" data-category="nazionali" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="rai-3">
            <img src="https://api.superguidatv.it/v1/channels/219/logo?width=320&theme=dark" alt="Rai 3" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Rai 3 HD</div>
              <div class="channel-number-main">Canale 103</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>

          <div class="channel-item" data-channel="video4.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/104-Rete4.html" data-number="104" data-category="nazionali" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="rete-4">
            <img src="https://api.superguidatv.it/v1/channels/189/logo?width=320&theme=dark" alt="Rete 4" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Rete 4 HD</div>
              <div class="channel-number-main">Canale 104</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>

          <div class="channel-item" data-channel="video5.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/105-Canale5.html" data-number="105" data-category="nazionali" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="canale-5">
            <img src="https://api.superguidatv.it/v1/channels/187/logo?width=320&theme=dark" alt="Canale 5" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Canale 5 HD</div>
              <div class="channel-number-main">Canale 105</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>

          <div class="channel-item" data-channel="video6.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/106-Italia1.html" data-number="106" data-category="nazionali" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="italia-1">
            <img src="https://api.superguidatv.it/v1/channels/188/logo?width=320&theme=dark" alt="Italia 1" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Italia 1 HD</div>
              <div class="channel-number-main">Canale 106</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>

          <div class="channel-item" data-channel="video7.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/107-La7.html" data-number="107" data-category="nazionali" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="la7">
            <img src="https://api.superguidatv.it/v1/channels/253/logo?width=320&theme=dark" alt="La7" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">La7 HD</div>
              <div class="channel-number-main">Canale 107</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>

          <!-- Show & Serie -->
          <div class="channel-item" data-channel="video8.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/108-Flix.html" data-number="108" data-category="show" data-epg-url="https://brymeteo.github.io/player/Guida%20TV/tv/guidatv-flix.json">
            <img src="https://i.ibb.co/k6zC0xN/logo.png" alt="Flix" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Flix HD</div>
              <div class="channel-number-main">Canale 108</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>

          <div class="channel-item" data-channel="video9.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/109-Flix-Animation.html" data-number="109" data-category="show" data-epg-url="https://brymeteo.github.io/player/Guida%20TV/tv/guidatv-flix-animation.json">
            <img src="https://i.ibb.co/35YbR8bp/logo.png" alt="Flix Animation" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Flix Animation HD</div>
              <div class="channel-number-main">Canale 109</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>

          <!-- Generali -->
          
          
            <div class="channel-item" data-channel="video10.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/117-Bry-Natura.html" data-number="117" data-category="generali" data-epg-url="https://brymeteo.github.io/player/Guida%20TV/tv/guidatv-bry-natura.json">
            <img src="https://i.ibb.co/hxG8SmN/logo-1.png" alt="Bry Natura" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Bry Natura HD</div>
              <div class="channel-number-main">Canale 117</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
              <div class="channel-item" data-channel="video11.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/118-Geographic.html" data-number="118" data-category="generali" data-epg-url="https://brymeteo.github.io/player/Guida%20TV/tv/guidatv-geographic.json">
            <img src="https://i.ibb.co/26Nr6s0/logo-1.png" alt="Geographic" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Geographic HD</div>
              <div class="channel-number-main">Canale 118</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          <div class="channel-item" data-channel="video12.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/119-Tv8.html" data-number="119" data-category="generali" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="Tv8">
            <img src="https://api.superguidatv.it/v1/channels/237/logo?width=320&theme=dark" alt="TV8" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">TV8 HD</div>
              <div class="channel-number-main">Canale 119</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
          
          
          
          
          

          <div class="channel-item" data-channel="video13.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/120-Nove.html" data-number="120" data-category="generali" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="nove">
            <img src="https://api.superguidatv.it/v1/channels/238/logo?width=320&theme=dark" alt="Nove" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Nove HD</div>
              <div class="channel-number-main">Canale 120</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
                  <div class="channel-item" data-channel="video14.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/121-Gambero-rosso.html" data-number="121" data-category="cucina" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="gambero-rosso">
            <img src="https://i.ibb.co/7NQhbNQb/logo.webp" alt="Gambero Rosso" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Gambero Rosso HD</div>
              <div class="channel-number-main">Canale 121</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          

          <div class="channel-item" data-channel="video15.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/122-20Mediaset.html" data-number="122" data-category="generali" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="20-mediaset">
            <img src="https://api.superguidatv.it/v1/channels/443/logo?width=320&theme=dark" alt="20 Mediaset" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">20 Mediaset HD</div>
              <div class="channel-number-main">Canale 122</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
           <div class="channel-item" data-channel="video16.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/123-Rai4.html" data-number="123" data-category="generali" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="rai-4">
            <img src="https://api.superguidatv.it/v1/channels/220/logo?width=320&theme=dark" alt="Rai 4" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Rai 4 HD</div>
              <div class="channel-number-main">Canale 123</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
           <div class="channel-item" data-channel="video17.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/124-Raipremium.html" data-number="124" data-category="generali" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="rai-premium">
            <img src="https://api.superguidatv.it/v1/channels/225/logo?width=320&theme=dark" alt="Rai Premium" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Rai Premium HD</div>
              <div class="channel-number-main">Canale 124</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
           <div class="channel-item" data-channel="video18.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/125-27Twentyseven.html" data-number="125" data-category="generali" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="mediaset-27">
            <img src="https://api.superguidatv.it/v1/channels/601/logo?width=320&theme=dark" alt="27 Twentyseven" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">27 Twentyseven HD</div>
              <div class="channel-number-main">Canale 125</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          <div class="channel-item" data-channel="video19.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/126-La5.html" data-number="126" data-category="generali" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="la-5">
            <img src="https://api.superguidatv.it/v1/channels/190/logo?width=320&theme=dark" alt="La 5" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">La5 HD</div>
              <div class="channel-number-main">Canale 126</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
          <div class="channel-item" data-channel="video20.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/127-Realtime.html" data-number="127" data-category="generali" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="real-time">
            <img src="https://api.superguidatv.it/v1/channels/255/logo?width=320&theme=dark" alt="Real Time" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Real Time HD</div>
              <div class="channel-number-main">Canale 127</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
            <div class="channel-item" data-channel="video21.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/128-La7cinema.html" data-number="128" data-category="generali" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="la7-cinema">
            <img src="https://i.ibb.co/Nnx23KsD/logo.png" alt="La7-cinema" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">La7 Cinema HD</div>
              <div class="channel-number-main">Canale 128</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
          <div class="channel-item" data-channel="video22.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/129-MediasetExtra.html" data-number="129" data-category="generali" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="mediaset-extra">
            <img src="https://api.superguidatv.it/v1/channels/194/logo?width=320&theme=dark" alt="Mediaset Extra" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Mediaset Extra HD</div>
              <div class="channel-number-main">Canale 129</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
          
          <div class="channel-item" data-channel="video23.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/130-Grandefratello-regia1.html" data-number="130" data-category="generali" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="mediaset-extr">
            <img src="https://i.ibb.co/rMDZ4JW/logo.png" alt="Mediaset Extra" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Regia 1 GF HD</div>
              <div class="channel-number-main">Canale 130</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
          <div class="channel-item" data-channel="video24.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/131-Grandefratello-regia2.html" data-number="131" data-category="generali" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="mediaset-extr">
            <img src="https://i.ibb.co/T4HHVZG/logo.png" alt="Mediaset Extra" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Regia 2 GF HD</div>
              <div class="channel-number-main">Canale 131</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
          <div class="channel-item" data-channel="video25.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/132-Topcrime.html" data-number="132" data-category="generali" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="topcrime">
            <img src="https://api.superguidatv.it/v1/channels/193/logo?width=320&theme=dark" alt="Top Crime" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Top Crime HD</div>
              <div class="channel-number-main">Canale 132</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
          <div class="channel-item" data-channel="video26.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/133-Discovery.html" data-number="133" data-category="generali" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="discovery">
            <img src="https://i.ibb.co/cXsgXBHr/logo.png" alt="Discovery" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Discovery HD</div>
              <div class="channel-number-main">Canale 133</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
          <div class="channel-item" data-channel="video27.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/134-Dmax.html" data-number="134" data-category="generali" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="dmax">
            <img src="https://api.superguidatv.it/v1/channels/256/logo?width=320&theme=dark" alt="Dmax" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Dmax HD</div>
              <div class="channel-number-main">Canale 134</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
          <div class="channel-item" data-channel="video28.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/135-Italia2.html" data-number="135" data-category="generali" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="mediaset-italia-due">
            <img src="https://api.superguidatv.it/v1/channels/191/logo?width=320&theme=dark" alt="Mediaset Italia Due" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Mediaset Italia Due HD</div>
              <div class="channel-number-main">Canale 135</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
           <div class="channel-item" data-channel="video29.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/136-Rai4k.html" data-number="136" data-category="generali" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="rai-4k">
            <img src="https://i.ibb.co/cN3HXvg/logo.png" alt="Rai 4K" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Rai 4K HD</div>
              <div class="channel-number-main">Canale 136</div>
            </div>
            <div class="channel-status">HD/4K</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
           <div class="channel-item" data-channel="video30.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/137-Giallo.html" data-number="137" data-category="generali" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="giallo">
            <img src="https://i.ibb.co/YZTNyP4/logo.png" alt="Giallo" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Giallo HD</div>
              <div class="channel-number-main">Canale 137</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
          <div class="channel-item" data-channel="video31.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/138-Cielo.html" data-number="138" data-category="generali" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="cielo">
            <img src="https://api.superguidatv.it/v1/channels/239/logo?width=320&theme=dark" alt="Cielo" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Cielo HD</div>
              <div class="channel-number-main">Canale 138</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
          
           <div class="channel-item" data-channel="video32.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/139-FoodNetwork.html" data-number="139" data-category="cucina" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="foodnetwork">
            <img src="https://i.ibb.co/LJT1d90/logo.png" alt="Food Network" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Food Network HD</div>
              <div class="channel-number-main">Canale 139</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
           <div class="channel-item" data-channel="video33.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/140-HGTV.html" data-number="140" data-category="generali" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="home-and-garden-tv">
            <img src="https://i.ibb.co/1GN3qnt/logo.png" alt="Home And Garden Tv" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Home And Garden Tv HD</div>
              <div class="channel-number-main">Canale 140</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
          <div class="channel-item" data-channel="video34.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/141-TV2000.html" data-number="141" data-category="generali" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="tv2000">
            <img src="https://i.ibb.co/8dBBCBN/logo.png" alt="Tv 2000" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Tv 2000 HD</div>
              <div class="channel-number-main">Canale 141</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
          
          <div class="channel-item" data-channel="video35.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/144-mr.bean.html" data-number="144" data-category="generali" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="mr-bean">
            <img src="https://i.ibb.co/4s3C61T/logo-1-1.png" alt="Mr Bean" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Mr.Bean HD</div>
              <div class="channel-number-main">Canale 144</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
          

          <!-- Sport -->
          <div class="channel-item" data-channel="video36.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/150-Brysport24.html" data-number="150" data-category="sport" data-epg-url="https://example.com/api/epg/brysport.json" data-epg-id="mr-bean">
            <img src="https://i.ibb.co/x5v83XD/logo.png" alt="Bry Sport" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Bry Sport 24 HD</div>
              <div class="channel-number-main">Canale 150</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>

          <div class="channel-item" data-channel="video37.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/152-Sportitalia.html" data-number="152" data-category="sport" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="sportitalia">
            <img src="https://i.ibb.co/qsKy4tb/logo.png" alt="Sport Italia" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Sport Italia HD</div>
              <div class="channel-number-main">Canale 152</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>

          <!-- Cinema -->
          
          <div class="channel-item" data-channel="video38.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/200-Premiere-Cinema.html" data-number="200" data-category="cinema" data-epg-url="https://brymeteo.github.io/player/Guida%20TV/tv/guidatv-premiere-cinema.json" data-epg-id="premiere-cinema">
            <img src="https://i.ibb.co/S62L7GM/logo-1.png" alt="Premiere Cinema" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Premiere Cinema HD</div>
              <div class="channel-number-main">Canale 200</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
            <div class="channel-item" data-channel="video46.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/215-Rakuten-azione.html" data-number="215" data-category="cinema" data-epg-url="https://brymeteo.github.io/player/Guida%20TV/tv/guidatv-rakuten.json" data-epg-id="rakuten">
            <img src="https://i.ibb.co/9W48qM4/logo-1.png" alt="Rakuten Azione" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Rakuten Azione HD</div>
              <div class="channel-number-main">Canale 215</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
           <div class="channel-item" data-channel="video47.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/216-Rakuten-commedia.html" data-number="216" data-category="cinema" data-epg-url="https://brymeteo.github.io/player/Guida%20TV/tv/guidatv-rakuten.json" data-epg-id="rakuten">
            <img src="https://i.ibb.co/3RMsYQZ/logo-1.png" alt="Rakuten Commedia" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Rakuten Commedia HD</div>
              <div class="channel-number-main">Canale 216</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
          
           <div class="channel-item" data-channel="video48.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/217-Rakuten-dramma.html" data-number="217" data-category="cinema" data-epg-url="https://brymeteo.github.io/player/Guida%20TV/tv/guidatv-rakuten.json" data-epg-id="rakuten">
            <img src="https://i.ibb.co/tYLjxbJ/logo-1.png" alt="Rakuten Drama" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Rakuten Drama HD</div>
              <div class="channel-number-main">Canale 217</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
           <div class="channel-item" data-channel="video49.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/218-777Rakuten-film-top.html" data-number="218" data-category="cinema" data-epg-url="https://brymeteo.github.io/player/Guida%20TV/tv/guidatv-rakuten.json" data-epg-id="rakuten">
            <img src="https://i.ibb.co/tYLjxbJ/logo-1.png" alt="Rakuten Film Top" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Rakuten Film Top HD</div>
              <div class="channel-number-main">Canale 218</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          <div class="channel-item" data-channel="video50.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/219-Rakuten-family.html" data-number="219" data-category="cinema" data-epg-url="https://brymeteo.github.io/player/Guida%20TV/tv/guidatv-rakuten.json" data-epg-id="rakuten">
            <img src="https://i.ibb.co/9VVgs1H/logo-1.png" alt="Rakuten Family" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Rakuten Family HD</div>
              <div class="channel-number-main">Canale 219</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
     

          <div class="channel-item" data-channel="video51.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/220-Iris.html" data-number="220" data-category="cinema" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="iris">
            <img src="https://api.superguidatv.it/v1/channels/192/logo?width=320&theme=dark" alt="Iris" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Iris HD</div>
              <div class="channel-number-main">Canale 220</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
          <div class="channel-item" data-channel="video52.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/221-Cine34.html" data-number="221" data-category="cinema" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="cine-34">
            <img src="https://api.superguidatv.it/v1/channels/574/logo?width=320&theme=dark" alt="Cine 34" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Cine 34 HD</div>
              <div class="channel-number-main">Canale 221</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          <div class="channel-item" data-channel="video53.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/222-RaiMovie.html" data-number="222" data-category="cinema" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="rai-movie">
            <img src="https://api.superguidatv.it/v1/channels/229/logo?width=320&theme=dark" alt="Rai movie" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Rai movie HD</div>
              <div class="channel-number-main">Canale 222</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
          
          <div class="channel-item" data-channel="video54.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/223-Duri-a-Morire.html" data-number="223" data-category="cinema" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="duri-a-morire">
            <img src="https://i.ibb.co/ynPH9L1C/logo-1.png" alt="Duri a Morire" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Duri a Morire HD</div>
              <div class="channel-number-main">Canale 223</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          

          <!-- Documentari -->
          <div class="channel-item" data-channel="video55.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/300-Focus.html" data-number="300" data-category="documentari" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="focus">
            <img src="https://api.superguidatv.it/v1/channels/249/logo?width=320&theme=dark" alt="Focus" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Focus HD</div>
              <div class="channel-number-main">Canale 300</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
          <div class="channel-item" data-channel="video56.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/301-Geographic.html" data-number="301" data-category="documentari" data-epg-url="https://brymeteo.github.io/player/Guida%20TV/tv/guidatv-geographic.json" data-epg-id="geographic">
            <img src="https://i.ibb.co/26Nr6s0/logo-1.png" alt="Geographic" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Geographic HD</div>
              <div class="channel-number-main">Canale 301</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
           <div class="channel-item" data-channel="video57.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/302-Bry-Natura.html" data-number="302" data-category="documentari" data-epg-url="https://brymeteo.github.io/player/Guida%20TV/tv/guidatv-bry-natura.json">
            <img src="https://i.ibb.co/hxG8SmN/logo-1.png" alt="Bry Natura" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Bry Natura HD</div>
              <div class="channel-number-main">Canale 302</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
            <div class="channel-item" data-channel="video59.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/304-FoodNetwork.html" data-number="304" data-category="documentari" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="foodnetwork">
            <img src="https://i.ibb.co/LJT1d90/logo.png" alt="Food Network" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Food Network HD</div>
              <div class="channel-number-main">Canale 304</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
          
          
          
           <div class="channel-item" data-channel="video60.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/305-HGTV.html" data-number="305" data-category="documentari" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="home-and-garden-tv">
            <img src="https://i.ibb.co/1GN3qnt/logo.png" alt="Home And Garden Tv" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Home And Garden Tv HD</div>
              <div class="channel-number-main">Canale 305</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
           <div class="channel-item" data-channel="video61.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/306-Motortrend.html" data-number="306" data-category="documentari" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="motor-trend">
            <img src="https://api.superguidatv.it/v1/channels/444/logo?width=320" alt="Motor Trend" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Motor Trend HD</div>
              <div class="channel-number-main">Canale 306</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
          <div class="channel-item" data-channel="video62.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/307-Gambero-rosso.html" data-number="307" data-category="documentari" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="gambero-rosso">
            <img src="https://i.ibb.co/7NQhbNQb/logo.webp" alt="Gambero Rosso" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Gambero Rosso HD</div>
              <div class="channel-number-main">Canale 307</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          

          <!-- News -->
          <div class="channel-item" data-channel="video64.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/400-Skytg24.html" data-number="400" data-category="news" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="sky-tg24">
            <img src="https://api.superguidatv.it/v1/channels/240/logo?width=320" alt="Sky TG24" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Sky TG24 HD</div>
              <div class="channel-number-main">Canale 400</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
           <div class="channel-item" data-channel="video65.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/401-Tgcom24.html" data-number="401" data-category="news" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="tgcom24">
            <img src="https://api.superguidatv.it/v1/channels/197/logo?width=320" alt="Tgcom 24" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Tgcom 24 HD</div>
              <div class="channel-number-main">Canale 401</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          <div class="channel-item" data-channel="video66.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/402-Rainews24.html" data-number="402" data-category="news" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="rai-news-24">
            <img src="https://api.superguidatv.it/v1/channels/222/logo?width=320" alt="Rai News 24" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Rai News 24 HD</div>
              <div class="channel-number-main">Canale 402</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
            <div class="channel-item" data-channel="video67.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/403-Euronews.html" data-number="403" data-category="news" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="euronews">
            <img src="https://i.ibb.co/ZzwYhFGN/logo.webp" alt="Euronews" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Euronews HD</div>
              <div class="channel-number-main">Canale 403</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
          <div class="channel-item" data-channel="video68.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/404-Sicilia242.html" data-number="404" data-category="news" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="sicilia-242">
            <img src="https://i.ibb.co/7x2cr40j/logo.webp" alt="Sicilia 242" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Sicilia 242 HD</div>
              <div class="channel-number-main">Canale 404</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          

          <div class="channel-item" data-channel="video69.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/405-BryMeteo24.html" data-number="405" data-category="news" data-epg-url="https://brymeteo.github.io/player/Guida%20TV/tv/guidatv-brymeteo24.json"  data-epg-id="brymeteo24">
            <img src="https://i.ibb.co/RN70PcL/logo-1.png" alt="Bry Meteo" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Bry Meteo 24 HD</div>
              <div class="channel-number-main">Canale 405</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>

          <!-- Bambini -->
          <div class="channel-item" data-channel="video70.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/501-Boing.html" data-number="501" data-category="bambini" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="boing">
            <img src="https://api.superguidatv.it/v1/channels/195/logo?width=320" alt="Boing" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Boing HD</div>
              <div class="channel-number-main">Canale 501</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>

<div class="channel-item" data-channel="video71.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/502-K2.html" data-number="502" data-category="bambini" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="k2">
            <img src="https://api.superguidatv.it/v1/channels/245/logo?width=320" alt="K2" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">K2 HD</div>
              <div class="channel-number-main">Canale 502</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
          <div class="channel-item" data-channel="video72.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/503-Raigulp.html" data-number="503" data-category="bambini" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="rai-gulp">
            <img src="https://api.superguidatv.it/v1/channels/228/logo?width=320" alt="Rai Gulp" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Rai Gulp HD</div>
              <div class="channel-number-main">Canale 503</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
           <div class="channel-item" data-channel="video73.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/504-Raiyoyo.html" data-number="504" data-category="bambini" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="rai-yoyo">
            <img src="https://api.superguidatv.it/v1/channels/227/logo?width=320" alt="Rai Yoyo" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Rai Yoyo HD</div>
              <div class="channel-number-main">Canale 504</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          

<div class="channel-item" data-channel="video74.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/505-Fresbee.html" data-number="505" data-category="bambini" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="frisbee">
            <img src="https://api.superguidatv.it/v1/channels/246/logo?width=320" alt="Frisbee" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Frisbee HD</div>
              <div class="channel-number-main">Canale 505</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>



<div class="channel-item" data-channel="video75.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/506-Cartoonito.html" data-number="506" data-category="bambini" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="cartoonito">
            <img src="https://i.ibb.co/Yt6t6cM/logo-1.png" alt="Cartoonito" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Cartoonito HD</div>
              <div class="channel-number-main">Canale 506</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>




<div class="channel-item" data-channel="video76.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/507-Super.html" data-number="507" data-category="bambini" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="super">
            <img src="https://api.superguidatv.it/v1/channels/247/logo?width=320" alt="Super" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Super HD</div>
              <div class="channel-number-main">Canale 507</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>



<div class="channel-item" data-channel="video77.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/508-PlayJunior.html" data-number="508" data-category="bambini" data-epg-url="https://brymeteo.github.io/player/Guida%20TV/tv/guidatv-play-junior.json" data-epg-id="play-junior">
            <img src="https://i.ibb.co/hZcLBDK/logo-1-1.png" alt="Play Junior" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Play Junior HD</div>
              <div class="channel-number-main">Canale 508</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>


<div class="channel-item" data-channel="video78.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/509-PlayJunior+1.html" data-number="509" data-category="bambini" data-epg-url="https://brymeteo.github.io/player/Guida%20TV/tv/guidatv-play-junior-1.json" data-epg-id="play-junior-1">
            <img src="https://i.ibb.co/BsB0mPM/logo-1-1.png" alt="Play Junior +1" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Play Junior +1 HD</div>
              <div class="channel-number-main">Canale 509</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>


<div class="channel-item" data-channel="video79.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/510-Playchannel.html" data-number="510" data-category="bambini" data-epg-url="https://brymeteo.github.io/player/Guida%20TV/tv/guidatv-play-channel.json" data-epg-id="play-channel">
            <img src="https://i.ibb.co/KrwBn2P/logo-1.png" alt="Play Channel" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Play Channel HD</div>
              <div class="channel-number-main">Canale 510</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>



<div class="channel-item" data-channel="video80.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/511-Playchannel+1.html" data-number="511" data-category="bambini" data-epg-url="https://brymeteo.github.io/player/Guida%20TV/tv/guidatv-play-channel-1.json" data-epg-id="play-channel-1">
            <img src="https://i.ibb.co/dw2fqpP8/logo-1.png" alt="Play Channel +1" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Play Channel +1 HD</div>
              <div class="channel-number-main">Canale 511</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>



<div class="channel-item" data-channel="video81.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/512-Mrbean.html" data-number="512" data-category="bambini" data-epg-url="https://brymeteo.github.io/player/Guida%20TV/tv/guidatv-mr-bean.json" data-epg-id="mr-bean">
            <img src="https://i.ibb.co/pWbyF3L/logo-1.png" alt="Mr.Bean Animated" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Mr.Bean Animated HD</div>
              <div class="channel-number-main">Canale 512</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>






          <!-- Musica -->
          <div class="channel-item" data-channel="video82.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/600-DeejayTV.html" data-number="600" data-category="musica" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="deejay-tv">
            <img src="https://api.superguidatv.it/v1/channels/162/logo?width=320" alt="Deejay TV" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Deejay TV HD</div>
              <div class="channel-number-main">Canale 600</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          <div class="channel-item" data-channel="video83.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/601-Rtl1025.html" data-number="601" data-category="musica" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="rtl-102.5-tv">
            <img src="https://api.superguidatv.it/v1/channels/243/logo?width=320" alt="Rtl 102.5" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Rtl 102.5 HD</div>
              <div class="channel-number-main">Canale 601</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
           <div class="channel-item" data-channel="video84.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/602-Radioitalia.html" data-number="602" data-category="musica" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="radioitaliatv">
            <img src="https://i.ibb.co/gm6gY0H/logo-1.png" alt="Radio Italia" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Radio Italia HD</div>
              <div class="channel-number-main">Canale 602</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
          <div class="channel-item" data-channel="video85.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/603-R101.html" data-number="603" data-category="musica" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="r101">
            <img src="https://api.superguidatv.it/v1/channels/463/logo?width=320" alt="R101" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">R101 HD</div>
              <div class="channel-number-main">Canale 603</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          <div class="channel-item" data-channel="video86.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/604-Rds.html" data-number="604" data-category="musica" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="rds">
            <img src="https://i.ibb.co/zJCyW5m/logo-1.png" alt="RDS" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">RDS HD</div>
              <div class="channel-number-main">Canale 604</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          <div class="channel-item" data-channel="video87.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/605-BryMusic.html" data-number="605" data-category="musica" data-epg-url="https://brymeteo.github.io/player/Guida%20TV/tv/guidatv-bry-music.json" data-epg-id="bry-music">
            <img src="https://i.ibb.co/LCh1QRK/logo-1.png" alt="Bry Music" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Bry Music HD</div>
              <div class="channel-number-main">Canale 605</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
          <div class="channel-item" data-channel="video88.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/606-BryMusic-Anni90.html" data-number="606" data-category="musica" data-epg-url="https://brymeteo.github.io/player/Guida%20TV/tv/guidatv-bry-music-anni-90.json" data-epg-id="bry-music-anni90">
            <img src="https://i.ibb.co/V0xHKHKR/logo.webp" alt="Bry Music" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Bry Music Anni 90 HD</div>
              <div class="channel-number-main">Canale 606</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
          <div class="channel-item" data-channel="video89.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/607-Radio-M2o.html" data-number="607" data-category="musica" data-epg-url="https://brymeteo.github.io/player/Guida%20TV/tv/guidatv-m20.json" data-epg-id="m20">
            <img src="https://i.ibb.co/JCpnFhw/logo-1.png" alt="Radio M2o" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Radio M2o HD</div>
              <div class="channel-number-main">Canale 607</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
          <div class="channel-item" data-channel="video90.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/608-Radio-Freccia.html" data-number="608" data-category="musica" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="radiofreccia">
            <img src="https://i.ibb.co/SVjZvd0/logo-1.png" alt="Radio Freccia" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Radio Freccia HD</div>
              <div class="channel-number-main">Canale 608</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
          
          <div class="channel-item" data-channel="video91.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/609-Radio-Bruno.html" data-number="609" data-category="musica" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="radiobruno">
            <img src="https://i.ibb.co/sbyfV5n/logo-1.png" alt="Radio Bruno" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Radio Bruno HD</div>
              <div class="channel-number-main">Canale 609</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
          <div class="channel-item" data-channel="video92.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/610-Radio-Studio+.html" data-number="610" data-category="musica" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="radiostudio">
            <img src="https://i.ibb.co/PGQM1wY/logo.png" alt="Radio Studio" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Radio Studio+ HD</div>
              <div class="channel-number-main">Canale 610</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          
          <div class="channel-item" data-channel="video93.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/700-Tris.html" data-number="700" data-category="Altri" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="tris">
            <img src="https://i.ibb.co/tpCR78Hm/logo.webp" alt="Tris" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Tris Siracusa HD</div>
              <div class="channel-number-main">Canale 700</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          
          <div class="channel-item" data-channel="video94.mp4" data-url="https://brymeteo.github.io/player/canali-tv-nazionali/canali-zapping/versione-nuova/404-Sicilia242.html" data-number="701" data-category="Altri" data-epg-url="https://brymeteo.github.io/tv/dati_programmi.json" data-epg-id="sicilia-242">
            <img src="https://i.ibb.co/7x2cr40j/logo.webp" alt="Sicilia 242" class="channel-logo">
            <div class="channel-details">
              <div class="channel-name-main">Sicilia 242 HD</div>
              <div class="channel-number-main">Canale 701</div>
            </div>
            <div class="channel-status">HD</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
          
          

          <!-- Canale di configurazione -->
          <div class="channel-item" data-channel="video0.mp4" data-url="https://brymeteo.github.io/player/decoder/immagini/cartello-configurazione-canali-completata.html" data-number="100" data-category="nazionali">
           
            <div class="channel-details">
              <div class="channel-name-main">Configurazione Completata</div>
              <div class="channel-number-main">Canale 100</div>
            </div>
            <div class="channel-status">INFO</div>
            <div class="favorite-star empty" onclick="toggleFavorite(this)">☆</div>
          </div>
        </div>
      </div>
    </div>

    <div class="sky-controls">
      <div class="control-group">
        <button class="control-btn" id="scroll-up-btn">
          <span>▲</span>
          <span>Su</span>
        </button>
        <button class="control-btn" id="scroll-down-btn">
          <span>▼</span>
          <span>Giù</span>
        </button>
      </div>
      
      <div class="navigation-hint">
        <div>← → Categorie | ↑ Modalità numerica | ← → Naviga canali | INVIO Seleziona | ESC Chiudi | 9 Menu | 0 Voce | 6 Mosaico | 7 Filtri</div>
      </div>
      
      <div class="control-group">
        <button class="control-btn" id="restart-btn">
          <img src="https://i.ibb.co/whc8jGxJ/Black-Rewind-Button-Transparent.png" alt="Restart" class="control-icon">
          <span>Restart</span>
        </button>
        <button class="control-btn" id="voice-btn">
          <img src="https://i.ibb.co/zW5pkG33/microphone-retro-icon-icons-com-67975.png" alt="Microfono" class="control-icon">
          <span>Voce</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Overlay Mosaico -->
  <div class="mosaic-overlay" id="mosaic-overlay">
    <div class="mosaic-header">
      <div class="mosaic-title">
      <div class="sky-logo">
        <img src="https://i.ibb.co/wFgnHn3m/bry-logo-ufficiale5.png" alt="Sky Decoder Logo">
        
      </div>
       Mosaico Canali TV
      </div>
      <button class="mosaic-close" id="mosaic-close">×</button>
    </div>
    
   <div class="mosaic-content" id="mosaic-content">
  <!-- Indicatore di caricamento -->
  <div class="mosaic-loading" id="mosaic-loading" style="display: none;">
    <div class="mosaic-spinner"></div>
    <div class="mosaic-loading-text">Caricamento canali in corso...</div>
  </div>
  
  <div class="mosaic-grid" id="mosaic-grid">
    <!-- Le card del mosaico verranno generate dinamicamente -->
  </div>
</div>

    
    <div class="mosaic-controls">
      <div class="mosaic-hint">
        ← → ↑ ↓ Naviga tra i canali | INVIO Seleziona canale | ESC Chiudi mosaico | 6 Chiudi
      </div>
    </div>
  </div>

  <!-- Overlay Mosaico Filtrato (TASTO 7) -->
  <div class="filtered-mosaic-overlay" id="filtered-mosaic-overlay">
    <div class="filtered-mosaic-header">
      <div class="filtered-mosaic-title">
        <div class="sky-logo">
          <img src="https://i.ibb.co/wFgnHn3m/bry-logo-ufficiale5.png" alt="Sky Decoder Logo">
        </div>
        Mosaico Filtrato per Categoria
      </div>
      <button class="filtered-mosaic-close" id="filtered-mosaic-close">×</button>
    </div>
    
    <div class="filtered-mosaic-content">
      <!-- Sidebar filtri -->
      <div class="filtered-mosaic-sidebar">
        <div class="filtered-mosaic-sidebar-header">
          <div class="filtered-mosaic-sidebar-title">Filtra per Categoria</div>
          
        </div>
        
        <div class="filtered-category-item active focused" data-filter-category="tutti">
          <img class="filtered-category-icon" src="https://images-2.rakuten.tv/storage/live-channel-category/icon_img/5b32c853-642f-4065-a0f2-668d4b5e369f-live_channel_category-1644409517.png" alt="Tutti">
          <span class="filtered-category-name">Tutti i Canali</span>
          <span class="filtered-category-count" id="count-tutti">0</span>
        </div>
        
        <div class="filtered-category-item" data-filter-category="nazionali">
          <img class="filtered-category-icon" src="https://i.ibb.co/443bkqh/Featured-Copy.png" alt="Nazionali">
          <span class="filtered-category-name">Nazionali</span>
          <span class="filtered-category-count" id="count-nazionali">0</span>
        </div>
        
        <div class="filtered-category-item" data-filter-category="show">
          <img class="filtered-category-icon" src="https://i.ibb.co/B3YhYn1/svg-Image-Url-1636912584809.png" alt="Show">
          <span class="filtered-category-name">Show & Serie</span>
          <span class="filtered-category-count" id="count-show">0</span>
        </div>
        
        <div class="filtered-category-item" data-filter-category="generali">
          <img class="filtered-category-icon" src="https://images-1.rakuten.tv/storage/live-channel-category/icon_img/565cb4c0-89f6-450e-9536-08ac90ded10c-live_channel_category-1644403535.png" alt="Generali">
          <span class="filtered-category-name">Generali</span>
          <span class="filtered-category-count" id="count-generali">0</span>
        </div>
        
        <div class="filtered-category-item" data-filter-category="sport">
          <img class="filtered-category-icon" src="https://images-0.rakuten.tv/storage/live-channel-category/icon_img/3b138108-343f-4b09-8a74-3af0f400242f-live_channel_category-1644403549.png" alt="Sport">
          <span class="filtered-category-name">Sport</span>
          <span class="filtered-category-count" id="count-sport">0</span>
        </div>
        
        <div class="filtered-category-item" data-filter-category="cinema">
          <img class="filtered-category-icon" src="https://images-2.rakuten.tv/storage/live-channel-category/icon_img/aea198b1-bcd3-43c7-93f8-bc3828d111ec-live_channel_category-1644403493.png" alt="Cinema">
          <span class="filtered-category-name">Cinema</span>
          <span class="filtered-category-count" id="count-cinema">0</span>
        </div>
        
        <div class="filtered-category-item" data-filter-category="documentari">
          <img class="filtered-category-icon" src="https://images-0.rakuten.tv/storage/live-channel-category/icon_img/29980e21-8ed7-4295-bb34-47a81733f3ff-live_channel_category-1644403705.png" alt="Documentari">
          <span class="filtered-category-name">Documentari</span>
          <span class="filtered-category-count" id="count-documentari">0</span>
        </div>
        
        <div class="filtered-category-item" data-filter-category="cucina">
          <img class="filtered-category-icon" src="https://images-0.rakuten.tv/storage/live-channel-category/icon_img/1efcc183-53ea-4d2e-be52-984d5d46e8f6-live_channel_category-1644403582.png" alt="Cucina">
          <span class="filtered-category-name">Cucina</span>
          <span class="filtered-category-count" id="count-cucina">0</span>
        </div>
        
        <div class="filtered-category-item" data-filter-category="news">
          <img class="filtered-category-icon" src="https://images-0.rakuten.tv/storage/live-channel-category/icon_img/d206f902-c713-42db-b472-b9442f2dbb28-live_channel_category-1644403719.png" alt="News">
          <span class="filtered-category-name">News & Meteo</span>
          <span class="filtered-category-count" id="count-news">0</span>
        </div>
        
        <div class="filtered-category-item" data-filter-category="bambini">
          <img class="filtered-category-icon" src="https://images-2.rakuten.tv/storage/live-channel-category/icon_img/92e98439-8c9b-4d43-a9d6-3d7e9ea1f62e-live_channel_category-1644403620.png" alt="Bambini">
          <span class="filtered-category-name">Bambini</span>
          <span class="filtered-category-count" id="count-bambini">0</span>
        </div>
        
        <div class="filtered-category-item" data-filter-category="musica">
          <img class="filtered-category-icon" src="https://images-1.rakuten.tv/storage/live-channel-category/icon_img/dddd10c5-89f0-4a50-8f19-dbd46e0ee2cb-live_channel_category-1644403607.png" alt="Musica">
          <span class="filtered-category-name">Musica & Radio</span>
          <span class="filtered-category-count" id="count-musica">0</span>
        </div>
        
        <div class="filtered-category-item" data-filter-category="preferiti">
          <img class="filtered-category-icon" src="https://www.rakuten.tv/static/media/Heart.a811332e.svg" alt="Preferiti">
          <span class="filtered-category-name">Preferiti</span>
          <span class="filtered-category-count" id="count-preferiti">0</span>
        </div>
      </div>
      
      <!-- Area principale -->
      <div class="filtered-mosaic-main">
        <div class="filtered-mosaic-main-header">
          <div>
            <div class="filtered-mosaic-main-title" id="filtered-mosaic-category-title">TUTTI I CANALI</div>
            <div class="filtered-mosaic-main-subtitle" id="filtered-mosaic-category-subtitle">Visualizzazione di tutti i canali disponibili</div>
          </div>
          
          <!-- ===== NUOVA FASCIA ORARIA ===== -->
          <div class="time-navigation" id="time-navigation">
            <button class="time-nav-btn" id="time-prev-btn">
              <span>◀</span>
              <span>Precedente</span>
            </button>
            
            <div>
              <div class="current-time-display" id="current-time-display">Ora Corrente</div>
              <div class="time-indicator" id="time-indicator">Programmi in corso</div>
            </div>
            
            <button class="time-nav-btn" id="time-next-btn">
              <span>Successivo</span>
              <span>▶</span>
            </button>
          </div>
        </div>
        
        <div class="filtered-mosaic-grid-container" id="filtered-mosaic-grid-container">
          <!-- Indicatore di caricamento -->
          <div class="filtered-mosaic-loading" id="filtered-mosaic-loading" style="display: none;">
            <div class="filtered-mosaic-spinner"></div>
            <div class="filtered-mosaic-loading-text">Caricamento canali filtrati...</div>
          </div>
          
          <div class="filtered-mosaic-grid" id="filtered-mosaic-grid">
            <!-- Le card filtrate verranno generate dinamicamente -->
          </div>
        </div>
      </div>
    </div>
    
    <div class="filtered-mosaic-controls">
      <div class="filtered-mosaic-hint">
        ← → Naviga categorie/tempo | ↑ ↓ Naviga canali | INVIO Seleziona | ESC Chiudi | 7 Chiudi
      </div>
    </div>
  </div>

  <!-- Overlay vocale -->
  <div class="voice-overlay" id="voice-overlay">
    <div class="voice-container">
      <div class="voice-icon">
        <img src="https://i.ibb.co/zW5pkG33/microphone-retro-icon-icons-com-67975.png" alt="Microfono">
      </div>
      <div class="voice-text" id="voice-text">Pronuncia il nome del canale o il numero</div>
      <div class="voice-subtitle">Comando vocale attivo...</div>
    </div>
  </div>

  <!-- Notifica modalità preferiti -->
  <div class="favorites-notification" id="favorites-notification">
    <span class="notification-icon" id="notification-icon">⭐</span>
    <span id="notification-text">Modalità Preferiti Attivata</span>
  </div>

<script>
    // Configurazione Firebase - SOSTITUISCI CON I TUOI DATI
    const firebaseConfig = {
  apiKey: "AIzaSyCrx2AN1BxR2jkaf5_c3gV5DaOYMEla3V4",
  authDomain: "utenti-bry.firebaseapp.com",
  projectId: "utenti-bry",
  storageBucket: "utenti-bry.firebasestorage.app",
  messagingSenderId: "239646123816",
  appId: "1:239646123816:web:eba4f3ba59f60c23a7121d"
};

    // Inizializza Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ===== SISTEMA DI TRACCIAMENTO UTENTI ONLINE =====
    class OnlineUsersTracker {
      constructor() {
        this.sessionId = this.generateSessionId();
        this.userId = null;
        this.userName = null;
        this.currentChannel = null;
        this.sessionStartTime = Date.now();
        this.heartbeatInterval = null;
        this.channelStatsInterval = null;
        this.isActive = false;
        
        // Bind dei metodi
        this.handleVisibilityChange = this.handleVisibilityChange.bind(this);
        this.handleBeforeUnload = this.handleBeforeUnload.bind(this);
        
        this.init();
      }

      generateSessionId() {
        return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      }

      init() {
        // Event listeners per gestire la chiusura della pagina
        document.addEventListener('visibilitychange', this.handleVisibilityChange);
        window.addEventListener('beforeunload', this.handleBeforeUnload);
        window.addEventListener('unload', this.handleBeforeUnload);
        
        console.log('🔍 Sistema di tracciamento utenti inizializzato');
      }

      async startTracking(userData) {
        try {
          this.userId = userData.streamingPin;
          this.userName = userData.userName || 'Utente Premium';
          this.isActive = true;

          console.log('📊 Avvio tracciamento per utente:', this.userName);

          // Registra la sessione utente
          await this.registerUserSession();
          
          // Avvia heartbeat ogni 30 secondi
          this.startHeartbeat();
          
          // Avvia tracciamento statistiche canali ogni 10 secondi
          this.startChannelStatsTracking();
          
          // Aggiorna il contatore iniziale
          await this.updateOnlineCounter();

        } catch (error) {
          console.error('❌ Errore durante l\'avvio del tracciamento:', error);
        }
      }

      async registerUserSession() {
        try {
          const sessionData = {
            sessionId: this.sessionId,
            userId: this.userId,
            userName: this.userName,
            startTime: firebase.firestore.FieldValue.serverTimestamp(),
            lastHeartbeat: firebase.firestore.FieldValue.serverTimestamp(),
            currentChannel: this.currentChannel,
            isActive: true,
            userAgent: navigator.userAgent,
            platform: navigator.platform,
            language: navigator.language
          };

          await db.collection('onlineUsers').doc(this.sessionId).set(sessionData);
          console.log('✅ Sessione utente registrata:', this.sessionId);

        } catch (error) {
          console.error('❌ Errore registrazione sessione:', error);
        }
      }

      startHeartbeat() {
        this.heartbeatInterval = setInterval(async () => {
          if (this.isActive && !document.hidden) {
            try {
              await db.collection('onlineUsers').doc(this.sessionId).update({
                lastHeartbeat: firebase.firestore.FieldValue.serverTimestamp(),
                currentChannel: this.currentChannel,
                isActive: true
              });
              
              // Aggiorna il contatore
              await this.updateOnlineCounter();
              
            } catch (error) {
              console.error('❌ Errore heartbeat:', error);
            }
          }
        }, 30000); // Ogni 30 secondi
      }

      startChannelStatsTracking() {
        this.channelStatsInterval = setInterval(async () => {
          if (this.isActive && this.currentChannel && !document.hidden) {
            await this.trackChannelView();
          }
        }, 10000); // Ogni 10 secondi
      }

      async trackChannelView() {
        if (!this.currentChannel) return;

        try {
          const channelStatsRef = db.collection('channelStats').doc(this.currentChannel);
          const viewData = {
            channelNumber: this.currentChannel,
            userId: this.userId,
            userName: this.userName,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            sessionId: this.sessionId
          };

          // Aggiorna le statistiche del canale
          await channelStatsRef.set({
            channelNumber: this.currentChannel,
            totalViews: firebase.firestore.FieldValue.increment(1),
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
            currentViewers: firebase.firestore.FieldValue.increment(1)
          }, { merge: true });

          // Registra la visualizzazione individuale
          await db.collection('channelViews').add(viewData);

          console.log('📺 Tracciata visualizzazione canale:', this.currentChannel);

        } catch (error) {
          console.error('❌ Errore tracciamento canale:', error);
        }
      }

      async updateOnlineCounter() {
        try {
          // Pulisci le sessioni scadute (più di 2 minuti senza heartbeat)
          const cutoffTime = new Date(Date.now() - 2 * 60 * 1000);
          const expiredSessions = await db.collection('onlineUsers')
            .where('lastHeartbeat', '<', cutoffTime)
            .get();

          // Rimuovi le sessioni scadute
          const batch = db.batch();
          expiredSessions.forEach(doc => {
            batch.delete(doc.ref);
          });
          
          if (!expiredSessions.empty) {
            await batch.commit();
            console.log('🧹 Rimosse', expiredSessions.size, 'sessioni scadute');
          }

          // Conta gli utenti online attivi
          const activeUsers = await db.collection('onlineUsers')
            .where('isActive', '==', true)
            .get();

          const onlineCount = activeUsers.size;
          
          // Aggiorna il contatore nascosto
          document.getElementById('online-counter').textContent = onlineCount;
          
          console.log('👥 Utenti online:', onlineCount);

        } catch (error) {
          console.error('❌ Errore aggiornamento contatore:', error);
        }
      }

      async getChannelStats() {
        try {
          const stats = await db.collection('channelStats')
            .orderBy('totalViews', 'desc')
            .limit(10)
            .get();

          const channelStats = [];
          stats.forEach(doc => {
            channelStats.push({
              channel: doc.data().channelNumber,
              views: doc.data().totalViews,
              currentViewers: doc.data().currentViewers || 0
            });
          });

          // Aggiorna le statistiche nascoste
          const statsElement = document.getElementById('channel-stats');
          statsElement.innerHTML = JSON.stringify(channelStats);

          console.log('📊 Statistiche canali più visti:', channelStats);
          return channelStats;

        } catch (error) {
          console.error('❌ Errore recupero statistiche:', error);
          return [];
        }
      }

      updateCurrentChannel(channelNumber) {
        const previousChannel = this.currentChannel;
        this.currentChannel = channelNumber;
        
        console.log('📺 Cambio canale:', previousChannel, '→', channelNumber);
        
        // Traccia immediatamente il nuovo canale
        if (this.isActive) {
          this.trackChannelView();
        }
      }

      handleVisibilityChange() {
        if (document.hidden) {
          console.log('👁️ Pagina nascosta - pausa tracciamento');
          this.pauseTracking();
        } else {
          console.log('👁️ Pagina visibile - riprendi tracciamento');
          this.resumeTracking();
        }
      }

      async pauseTracking() {
        if (this.isActive) {
          try {
            await db.collection('onlineUsers').doc(this.sessionId).update({
              isActive: false,
              lastHeartbeat: firebase.firestore.FieldValue.serverTimestamp()
            });
          } catch (error) {
            console.error('❌ Errore pausa tracciamento:', error);
          }
        }
      }

      async resumeTracking() {
        if (this.userId) {
          this.isActive = true;
          try {
            await db.collection('onlineUsers').doc(this.sessionId).update({
              isActive: true,
              lastHeartbeat: firebase.firestore.FieldValue.serverTimestamp()
            });
          } catch (error) {
            console.error('❌ Errore ripresa tracciamento:', error);
          }
        }
      }

      async handleBeforeUnload() {
        if (this.isActive) {
          try {
            // Usa sendBeacon per inviare dati anche durante la chiusura
            const data = JSON.stringify({
              sessionId: this.sessionId,
              action: 'disconnect'
            });
            
            // Prova con sendBeacon se disponibile
            if (navigator.sendBeacon) {
              navigator.sendBeacon('/api/disconnect', data);
            }
            
            // Rimuovi la sessione da Firebase
            await db.collection('onlineUsers').doc(this.sessionId).delete();
            console.log('👋 Sessione utente rimossa alla chiusura');
            
          } catch (error) {
            console.error('❌ Errore durante la chiusura:', error);
          }
        }
      }

      stopTracking() {
        this.isActive = false;
        
        if (this.heartbeatInterval) {
          clearInterval(this.heartbeatInterval);
          this.heartbeatInterval = null;
        }
        
        if (this.channelStatsInterval) {
          clearInterval(this.channelStatsInterval);
          this.channelStatsInterval = null;
        }
        
        // Rimuovi la sessione
        if (this.sessionId) {
          db.collection('onlineUsers').doc(this.sessionId).delete()
            .then(() => console.log('👋 Tracciamento fermato e sessione rimossa'))
            .catch(error => console.error('❌ Errore rimozione sessione:', error));
        }
      }

      // Metodo per ottenere statistiche in tempo reale
      async getRealTimeStats() {
        try {
          const [onlineUsers, channelStats] = await Promise.all([
            this.updateOnlineCounter(),
            this.getChannelStats()
          ]);

          return {
            onlineUsers: parseInt(document.getElementById('online-counter').textContent) || 0,
            topChannels: channelStats
          };
        } catch (error) {
          console.error('❌ Errore statistiche real-time:', error);
          return { onlineUsers: 0, topChannels: [] };
        }
      }
    }

    // Inizializza il tracker
    const onlineTracker = new OnlineUsersTracker();

    // Variabile globale per tracciare se si sta inserendo il PIN
    let isPinInputActive = false;

    // ===== NUOVO SISTEMA DI SELEZIONE NUMERICA CANALI =====
    class NumericChannelSelector {
      constructor() {
        this.isActive = false;
        this.currentInput = '';
        this.inputTimeout = null;
        this.maxDigits = 3; // Massimo 3 cifre per i numeri di canale
        this.inputDelay = 1500; // 1.5 secondi di attesa dopo l'ultimo numero digitato
        
        this.banner = document.getElementById('numeric-mode-banner');
        this.overlay = document.getElementById('numeric-input-overlay');
        this.display = document.getElementById('numeric-display');
        this.errorOverlay = document.getElementById('channel-error-overlay');
        
        this.init();
      }

      init() {
        console.log('🔢 Sistema selezione numerica inizializzato');
      }

      toggleMode() {
        if (this.isActive) {
          this.deactivate();
        } else {
          this.activate();
        }
      }

      activate() {
        this.isActive = true;
        this.currentInput = '';
        this.updateDisplay();
        
        // Mostra il banner informativo
        this.banner.classList.add('show');
        
        console.log('🔢 Modalità selezione numerica ATTIVATA');
        
        // Nascondi il banner dopo 3 secondi
        setTimeout(() => {
          if (this.isActive) {
            this.banner.classList.remove('show');
          }
        }, 3000);
      }

      deactivate() {
        this.isActive = false;
        this.currentInput = '';
        
        // Nascondi tutti gli overlay
        this.banner.classList.remove('show');
        this.overlay.classList.remove('show');
        this.errorOverlay.classList.remove('show');
        
        // Cancella eventuali timeout
        if (this.inputTimeout) {
          clearTimeout(this.inputTimeout);
          this.inputTimeout = null;
        }
        
        console.log('🔢 Modalità selezione numerica DISATTIVATA');
      }

      addDigit(digit) {
        if (!this.isActive) return false;
        
        // Verifica che sia un numero valido
        if (!/^[0-9]$/.test(digit)) return false;
        
        // Verifica che non superi il massimo di cifre
        if (this.currentInput.length >= this.maxDigits) return false;
        
        // Aggiungi la cifra
        this.currentInput += digit;
        this.updateDisplay();
        
        // Mostra l'overlay con il numero
        this.overlay.classList.add('show');
        
        // Cancella il timeout precedente
        if (this.inputTimeout) {
          clearTimeout(this.inputTimeout);
        }
        
        // Imposta un nuovo timeout per il cambio canale
        this.inputTimeout = setTimeout(() => {
          this.processChannelChange();
        }, this.inputDelay);
        
        console.log('🔢 Cifra aggiunta:', digit, '- Input corrente:', this.currentInput);
        return true;
      }

      updateDisplay() {
        if (!this.currentInput) {
          this.display.textContent = '---';
          return;
        }
        
        // Crea la visualizzazione con le linee
        let displayText = '';
        for (let i = 0; i < 3; i++) {
          if (i < this.currentInput.length) {
            displayText += this.currentInput[i];
          } else {
            displayText += '-';
          }
          if (i < 2) displayText += ' ';
        }
        
        this.display.textContent = displayText;
      }

      processChannelChange() {
        if (!this.currentInput) return;
        
        const channelNumber = this.currentInput;
        console.log('🔢 Tentativo cambio canale:', channelNumber);
        
        // Cerca il canale
        const channel = document.querySelector(`[data-number="${channelNumber}"]`);
        
        if (channel) {
          // Canale trovato - cambia canale
          console.log('✅ Canale trovato:', channelNumber);
          
          // Nascondi l'overlay di input
          this.overlay.classList.remove('show');
          
          // Cambia il canale
          const channels = document.querySelectorAll('.channel-item');
          const index = Array.from(channels).indexOf(channel);
          selectChannel(index);
          changeVideo(index);
          
          // Disattiva la modalità numerica
          this.deactivate();
          
        } else {
          // Canale non trovato - mostra errore
          console.log('❌ Canale non trovato:', channelNumber);
          this.showError();
        }
      }

      showError() {
        // Nascondi l'overlay di input
        this.overlay.classList.remove('show');
        
        // Mostra l'overlay di errore
        this.errorOverlay.classList.add('show');
        
        // Nascondi l'errore dopo 2 secondi
        setTimeout(() => {
          this.errorOverlay.classList.remove('show');
          
          // Reset dell'input
          this.currentInput = '';
          this.updateDisplay();
          
          // Se la modalità è ancora attiva, mostra di nuovo l'overlay di input
          if (this.isActive) {
            setTimeout(() => {
              this.overlay.classList.add('show');
            }, 300);
          }
        }, 2000);
      }

      // Metodo per verificare se un numero è valido in tempo reale
      isValidChannelStart(input) {
        if (!input) return true;
        
        const channels = document.querySelectorAll('.channel-item');
        for (let channel of channels) {
          const channelNumber = channel.dataset.number;
          if (channelNumber && channelNumber.startsWith(input)) {
            return true;
          }
        }
        return false;
      }

      // Metodo per cancellare l'ultimo numero
      backspace() {
        if (!this.isActive || !this.currentInput) return false;
        
        this.currentInput = this.currentInput.slice(0, -1);
        this.updateDisplay();
        
        // Cancella il timeout se presente
        if (this.inputTimeout) {
          clearTimeout(this.inputTimeout);
          this.inputTimeout = null;
        }
        
        // Se c'è ancora input, riavvia il timeout
        if (this.currentInput) {
          this.inputTimeout = setTimeout(() => {
            this.processChannelChange();
          }, this.inputDelay);
        }
        
        console.log('🔢 Backspace - Input corrente:', this.currentInput);
        return true;
      }

      // Metodo per forzare il cambio canale immediato
      forceChannelChange() {
        if (!this.isActive || !this.currentInput) return false;
        
        if (this.inputTimeout) {
          clearTimeout(this.inputTimeout);
          this.inputTimeout = null;
        }
        
        this.processChannelChange();
        return true;
      }
    }

    // Inizializza il sistema di selezione numerica
    const numericSelector = new NumericChannelSelector();

    // ===== SISTEMA SETUP INIZIALE =====
    class SetupSystem {
      constructor() {
        this.currentStep = 0;
        this.init();
      }

      init() {
        // Controlla se il setup è già stato completato
        const setupCompleted = localStorage.getItem('setupCompleted');
        if (setupCompleted) {
          this.showLoadingIntro();
        } else {
          this.startSetup();
        }
      }

      startSetup() {
        // Mostra schermata di benvenuto iniziale
        document.getElementById('start-btn').addEventListener('click', () => {
          this.enterFullscreen();
          this.showUpdateScreen();
        });
      }

      enterFullscreen() {
        if (document.documentElement.requestFullscreen) {
          document.documentElement.requestFullscreen().catch(err => {
            console.log(`Errore fullscreen: ${err.message}`);
          });
        }
      }

      showUpdateScreen() {
        document.getElementById('welcome-screen').classList.add('hidden');
        document.getElementById('update-screen').classList.remove('hidden');
        
        this.simulateUpdate();
      }

      simulateUpdate() {
        const progressBar = document.getElementById('update-progress-bar');
        const statusText = document.getElementById('update-status');
        
        const updateSteps = [
          { progress: 10, text: 'Scaricamento canali nazionali...', duration: 30000 },
          { progress: 25, text: 'Aggiornamento database canali...', duration: 45000 },
          { progress: 40, text: 'Configurazione decoder...', duration: 60000 },
          { progress: 60, text: 'Installazione codec video...', duration: 40000 },
          { progress: 80, text: 'Ottimizzazione sistema...', duration: 35000 },
          { progress: 95, text: 'Finalizzazione aggiornamenti...', duration: 30000 },
          { progress: 100, text: 'Aggiornamento completato!', duration: 10000 }
        ];

        let currentStepIndex = 0;
        
        const updateStep = () => {
          if (currentStepIndex < updateSteps.length) {
            const step = updateSteps[currentStepIndex];
            progressBar.style.width = step.progress + '%';
            statusText.textContent = step.text;
            
            setTimeout(() => {
              currentStepIndex++;
              updateStep();
            }, step.duration);
          } else {
            // Procedi automaticamente al riavvio
            setTimeout(() => {
              this.showRebootScreen();
            }, 2000);
          }
        };

        updateStep();
      }

      showRebootScreen() {
        document.getElementById('update-screen').classList.add('hidden');
        document.getElementById('reboot-screen').classList.remove('hidden');
        
        // Dopo 20 secondi mostra "Caricamento in corso..."
        setTimeout(() => {
          document.getElementById('loading-text').classList.remove('hidden');
        }, 20000);
        
        // Dopo altri 20 secondi mostra "Ottimizzazione..."
        setTimeout(() => {
          document.getElementById('optimization-text').classList.remove('hidden');
        }, 40000);
        
        // Dopo 2 minuti totali mostra schermata post-riavvio
        setTimeout(() => {
          this.showPostRebootScreen();
        }, 120000);
      }

      showPostRebootScreen() {
        document.getElementById('reboot-screen').classList.add('hidden');
        document.getElementById('post-reboot-screen').classList.remove('hidden');
        
        document.getElementById('post-reboot-start-btn').addEventListener('click', () => {
          this.enterFullscreen();
          this.completeSetup();
        });
      }

      showLoadingIntro() {
        // Mostra intro di caricamento
        document.getElementById('welcome-screen').classList.add('hidden');
        document.getElementById('loading-intro').classList.remove('hidden');
        
        // Mostra "Caricamento in corso..." con fade-in dopo un breve ritardo
        setTimeout(() => {
          const loadingText = document.getElementById('loading-intro-text');
          loadingText.classList.add('visible');
        }, 1000);
        
        // Dopo 10 secondi cambia il testo in "Caricamento completato"
        setTimeout(() => {
          const loadingText = document.getElementById('loading-intro-text');
          loadingText.classList.remove('visible');
          
          setTimeout(() => {
            loadingText.textContent = 'Caricamento completato';
            loadingText.classList.add('visible');
            
            // Mostra il pulsante "Entra" subito dopo
            setTimeout(() => {
              const enterBtn = document.getElementById('fullscreen-enter-btn');
              enterBtn.classList.add('visible');
              
              // Rimuovi eventuali event listener precedenti e aggiungi quello nuovo
              enterBtn.replaceWith(enterBtn.cloneNode(true));
              const newEnterBtn = document.getElementById('fullscreen-enter-btn');
              newEnterBtn.addEventListener('click', () => {
                this.enterFullscreen();
                document.getElementById('loading-intro').classList.add('hidden');
                this.checkPinAuth();
              });
            }, 500);
          }, 500);
        }, 10000);
      }

      completeSetup() {
        localStorage.setItem('setupCompleted', 'true');
        document.getElementById('post-reboot-screen').classList.add('hidden');
        this.checkPinAuth();
      }

      checkPinAuth() {
        // Controlla se il PIN è valido
        const authData = JSON.parse(localStorage.getItem('pinAuthData') || '{}');
        
        if (!authData.authenticated || !authData.expiryDate || Date.now() > authData.expiryDate) {
          pinAuth.showAuthScreen(authData.expiryDate && Date.now() > authData.expiryDate);
        } else {
          pinAuth.hideAuthScreen();
          // Avvia l'applicazione principale
          this.startMainApp(authData);

        }
      }

      async startMainApp(authData = null) {
  // ✅ CORREZIONE: Avvia il tracciamento utenti online anche per PIN già memorizzato
  if (authData && authData.streamingPin) {
    try {
      await onlineTracker.startTracking({
        streamingPin: authData.streamingPin,
        userName: authData.userName || 'Utente Premium'
      });
      console.log('✅ Tracciamento utenti avviato per PIN memorizzato');
    } catch (error) {
      console.error('❌ Errore avvio tracciamento per PIN memorizzato:', error);
    }
  }
  
  // Inizializza l'applicazione principale
  setTimeout(() => {

          loadFavorites();
          
          const savedCategory = localStorage.getItem('currentCategory') || 'tutti';
          const categoryIndex = Array.from(categories).findIndex(cat => cat.dataset.category === savedCategory);
          if (categoryIndex !== -1) {
            selectedCategoryIndex = categoryIndex;
          }
          filterChannelsByCategory(savedCategory);
          
          const savedChannel = localStorage.getItem('selectedChannel');
          if (savedChannel) {
            const selectedChannel = document.querySelector(`[data-number="${savedChannel}"]`);
            if (selectedChannel) {
              const index = Array.from(channels).indexOf(selectedChannel);
              selectChannel(index);
              changeVideo(index);
            }
          } else {
            const defaultChannel = document.querySelector('[data-number="100"]');
            if (defaultChannel) {
              const index = Array.from(channels).indexOf(defaultChannel);
              selectChannel(index);
              changeVideo(index);
            }
          }
        }, 100);
      }
    }

    // ===== SISTEMA AUTENTICAZIONE PIN CON FIREBASE =====
    class PinAuthSystem {
      constructor() {
        this.validityDays = 30;
        this.currentUserData = null; // Memorizza i dati dell'utente corrente
        this.init();
      }

      init() {
        this.setupPinInputs();
        this.updateSubscriptionInfo();
        this.startPeriodicCheck();
      }

      setupPinInputs() {
        const pinInputs = document.querySelectorAll('.pin-digit');
        const submitBtn = document.getElementById('pin-submit-btn');

        pinInputs.forEach((input, index) => {
          input.addEventListener('focus', () => {
            isPinInputActive = true;
          });

          input.addEventListener('blur', () => {
            // Controlla se tutti gli input PIN hanno perso il focus
            setTimeout(() => {
              const anyPinFocused = Array.from(pinInputs).some(inp => inp === document.activeElement);
              if (!anyPinFocused) {
                isPinInputActive = false;
              }
            }, 10);
          });

          input.addEventListener('input', (e) => {
            if (e.target.value.length === 1) {
              e.target.classList.add('filled');
              if (index < pinInputs.length - 1) {
                pinInputs[index + 1].focus();
              }
            } else {
              e.target.classList.remove('filled');
            }
            this.checkPinComplete();
          });

          input.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace' && !e.target.value && index > 0) {
              pinInputs[index - 1].focus();
              pinInputs[index - 1].value = '';
              pinInputs[index - 1].classList.remove('filled');
            }
          });
        });

        submitBtn.addEventListener('click', () => this.validatePin());

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' && !submitBtn.disabled && isPinInputActive) {
            this.validatePin();
          }
        });
      }

      checkPinComplete() {
        const pinInputs = document.querySelectorAll('.pin-digit');
        const submitBtn = document.getElementById('pin-submit-btn');

        const pinComplete = Array.from(pinInputs).every(input => input.value.length === 1);
        submitBtn.disabled = !pinComplete;
      }

      async validatePin() {
        const pinInputs = document.querySelectorAll('.pin-digit');
        const enteredPin = Array.from(pinInputs).map(input => input.value).join('');

        this.clearMessages();
        this.showSuccess('Verifica PIN in corso...');

        try {
          // Cerca l'utente nel database Firestore
          const usersRef = db.collection('users');
          const querySnapshot = await usersRef.where('streamingPin', '==', enteredPin).get();

          if (querySnapshot.empty) {
            this.showError('pin-error', 'PIN non trovato nel database. Verifica il PIN o contatta il supporto.');
            this.clearInputs();
            return;
          }

          // Prendi il primo documento trovato
          const userDoc = querySnapshot.docs[0];
          const userData = userDoc.data();

          console.log('Dati utente trovati:', userData);

          // Memorizza i dati dell'utente corrente
          this.currentUserData = {
            ...userData,
            docId: userDoc.id
          };

          // Verifica la data di scadenza
          const subscriptionEnd = userData.subscriptionEnd;
          let expiryDate;

          if (subscriptionEnd) {
            // Gestisci diversi formati di data
            if (typeof subscriptionEnd === 'string') {
              expiryDate = new Date(subscriptionEnd);
            } else if (subscriptionEnd.toDate) {
              // Timestamp Firestore
              expiryDate = subscriptionEnd.toDate();
            } else {
              expiryDate = new Date(subscriptionEnd);
            }

            // Verifica se l'abbonamento è scaduto
            if (expiryDate < new Date()) {
              this.showError('pin-error', 'Abbonamento scaduto. Rinnova il tuo abbonamento per continuare.');
              this.clearInputs();
              
              // Mostra schermata di scadenza
              setTimeout(() => {
                this.showAuthScreen(true);
              }, 2000);
              return;
            }
          }

          // Verifica se l'abbonamento è attivo
          if (userData.subscriptionActivated !== true || userData.packageStatus !== 'active') {
            this.showError('pin-error', 'Abbonamento non attivo. Contatta il supporto per assistenza.');
            this.clearInputs();
            return;
          }

          // PIN valido e abbonamento attivo
          this.showSuccess('PIN corretto! Accesso consentito...');
          this.saveAuthData(userData, expiryDate);
          
          // ✅ AVVIA IL TRACCIAMENTO UTENTI ONLINE
          await onlineTracker.startTracking({
            streamingPin: userData.streamingPin,
            userName: userData.name || 'Utente Premium'
          });
          
          setTimeout(() => {
            this.hideAuthScreen();
            setupSystem.startMainApp();
          }, 1500);

        } catch (error) {
          console.error('Errore durante la verifica del PIN:', error);
          this.showError('pin-error', 'Errore di connessione. Verifica la connessione internet e riprova.');
          this.clearInputs();
        }
      }

      // Funzione per verificare periodicamente i dati su Firestore
      async checkFirestoreData() {
        const authData = JSON.parse(localStorage.getItem('pinAuthData') || '{}');
        
        if (!authData.authenticated || !authData.streamingPin) {
          return; // Non c'è un utente autenticato
        }

        try {
          console.log('Controllo periodico Firestore per PIN:', authData.streamingPin);
          
          // Cerca l'utente nel database con il PIN salvato
          const usersRef = db.collection('users');
          const querySnapshot = await usersRef.where('streamingPin', '==', authData.streamingPin).get();

          if (querySnapshot.empty) {
            // PIN non trovato più nel database
            console.log('PIN non più presente nel database');
            this.handlePinChanged();
            return;
          }

          const userDoc = querySnapshot.docs[0];
          const currentUserData = userDoc.data();

          // Confronta i dati attuali con quelli salvati
          const hasChanges = this.compareUserData(authData, currentUserData);
          
          if (hasChanges.pinChanged) {
            console.log('PIN cambiato nel database');
            this.handlePinChanged();
            return;
          }

          if (hasChanges.subscriptionChanged) {
            console.log('Stato abbonamento cambiato');
            this.handleSubscriptionChanged(currentUserData);
            return;
          }

          // Aggiorna i dati locali con quelli più recenti
          this.updateLocalData(currentUserData);
          this.updateSubscriptionInfo();

        } catch (error) {
          console.error('Errore durante il controllo Firestore:', error);
        }
      }

      // Confronta i dati dell'utente per rilevare cambiamenti
      compareUserData(localData, firestoreData) {
        const changes = {
          pinChanged: false,
          subscriptionChanged: false
        };

        // Controlla se il PIN è cambiato
        if (localData.streamingPin !== firestoreData.streamingPin) {
          changes.pinChanged = true;
        }

        // Controlla se lo stato dell'abbonamento è cambiato
        if (localData.subscriptionActivated !== firestoreData.subscriptionActivated ||
            localData.packageStatus !== firestoreData.packageStatus) {
          changes.subscriptionChanged = true;
        }

        // Controlla se la data di scadenza è cambiata
        const localExpiry = new Date(localData.subscriptionEnd || localData.expiryDate);
        const firestoreExpiry = new Date(firestoreData.subscriptionEnd);
        
        if (Math.abs(localExpiry.getTime() - firestoreExpiry.getTime()) > 60000) { // Differenza > 1 minuto
          changes.subscriptionChanged = true;
        }

        return changes;
      }

      // Gestisce il caso in cui il PIN è stato modificato
      handlePinChanged() {
        // Ferma il tracciamento
        onlineTracker.stopTracking();
        
        // Rimuovi i dati di autenticazione
        localStorage.removeItem('pinAuthData');
        
        // Mostra schermata di autenticazione con messaggio specifico
        this.showAuthScreen(false, 'PIN_CHANGED');
      }

      // Gestisce il caso in cui l'abbonamento è cambiato
      handleSubscriptionChanged(userData) {
        // Verifica se l'abbonamento è ora inattivo
        if (userData.subscriptionActivated !== true || userData.packageStatus !== 'active') {
          // Ferma il tracciamento
          onlineTracker.stopTracking();
          
          localStorage.removeItem('pinAuthData');
          this.showAuthScreen(false, 'SUBSCRIPTION_INACTIVE');
          return;
        }

        // Verifica se l'abbonamento è scaduto
        const subscriptionEnd = userData.subscriptionEnd;
        let expiryDate;

        if (subscriptionEnd) {
          if (typeof subscriptionEnd === 'string') {
            expiryDate = new Date(subscriptionEnd);
          } else if (subscriptionEnd.toDate) {
            expiryDate = subscriptionEnd.toDate();
          } else {
            expiryDate = new Date(subscriptionEnd);
          }

          if (expiryDate < new Date()) {
            // Ferma il tracciamento
            onlineTracker.stopTracking();
            
            localStorage.removeItem('pinAuthData');
            this.showAuthScreen(true);
            return;
          }
        }

        // Aggiorna i dati locali
        this.updateLocalData(userData);
      }

      // Aggiorna i dati locali con quelli di Firestore
      updateLocalData(userData) {
        const authData = JSON.parse(localStorage.getItem('pinAuthData') || '{}');
        
        // Calcola la nuova data di scadenza
        let expiryDate;
        if (userData.subscriptionEnd) {
          if (typeof userData.subscriptionEnd === 'string') {
            expiryDate = new Date(userData.subscriptionEnd);
          } else if (userData.subscriptionEnd.toDate) {
            expiryDate = userData.subscriptionEnd.toDate();
          } else {
            expiryDate = new Date(userData.subscriptionEnd);
          }
        }

        const updatedAuthData = {
          ...authData,
          userName: userData.name || 'Utente Premium',
          clientId: userData.clientId || '',
          packageName: userData.package || userData.packageName || 'BRY Basic',
          streamingPin: userData.streamingPin,
          subscriptionActivated: userData.subscriptionActivated,
          packageStatus: userData.packageStatus,
          subscriptionEnd: userData.subscriptionEnd,
          expiryDate: expiryDate ? expiryDate.getTime() : authData.expiryDate
        };

        localStorage.setItem('pinAuthData', JSON.stringify(updatedAuthData));
      }

      showError(elementId, message) {
        const errorElement = document.getElementById(elementId);
        errorElement.textContent = message;
        errorElement.style.display = 'block';
        
        // Nascondi il messaggio di successo se presente
        document.getElementById('pin-success').style.display = 'none';
      }

      showSuccess(message) {
        const successElement = document.getElementById('pin-success');
        successElement.textContent = message;
        successElement.style.display = 'block';
        
        // Nascondi il messaggio di errore se presente
        document.getElementById('pin-error').style.display = 'none';
      }

      clearMessages() {
        document.getElementById('pin-error').style.display = 'none';
        document.getElementById('pin-success').style.display = 'none';
      }

      clearInputs() {
        const allInputs = document.querySelectorAll('.pin-digit');
        allInputs.forEach(input => {
          input.value = '';
          input.classList.remove('filled');
        });
        document.querySelectorAll('.pin-digit')[0].focus();
        document.getElementById('pin-submit-btn').disabled = true;
      }

      saveAuthData(userData, expiryDate) {
        const authData = {
          authenticated: true,
          timestamp: Date.now(),
          expiryDate: expiryDate ? expiryDate.getTime() : Date.now() + (this.validityDays * 24 * 60 * 60 * 1000),
          userName: userData.name || 'Utente Premium',
          clientId: userData.clientId || '',
          packageName: userData.package || userData.packageName || 'BRY Basic',
          streamingPin: userData.streamingPin,
          subscriptionActivated: userData.subscriptionActivated,
          packageStatus: userData.packageStatus,
          subscriptionEnd: userData.subscriptionEnd
        };
        localStorage.setItem('pinAuthData', JSON.stringify(authData));
      }

      showAuthScreen(isExpired = false, reason = null) {
        isPinInputActive = true;
        const authScreen = document.getElementById('pin-auth-screen');
        const expiredIcon = document.getElementById('expired-icon');
        const title = document.getElementById('pin-title');
        const subtitle = document.getElementById('pin-subtitle');

        // Reset delle classi
        authScreen.classList.remove('subscription-expired');

        if (isExpired) {
          authScreen.classList.add('subscription-expired');
          expiredIcon.style.display = 'block';
          title.textContent = 'Abbonamento Scaduto';
          subtitle.textContent = 'Il tuo abbonamento è scaduto. Per continuare, vai su https://brytv.webnode.it/area/bryid e rinnova il tuo abbonamento per ricevere un nuovo PIN.';
        } else if (reason === 'PIN_CHANGED') {
          expiredIcon.style.display = 'block';
          title.textContent = 'PIN Modificato';
          subtitle.textContent = 'Il tuo PIN è stato modificato. Inserisci il nuovo PIN per continuare. Recupera il PIN dal tuo account: https://brytv.webnode.it/area/bryid';
        } else if (reason === 'SUBSCRIPTION_INACTIVE') {
          expiredIcon.style.display = 'block';
          title.textContent = 'Abbonamento Non Attivo';
          subtitle.textContent = 'Il tuo abbonamento non è attivo. Per continuare, vai su https://brytv.webnode.it/area/bryid e completa l\'acquisto dell\'abbonamento.';
        } else {
          expiredIcon.style.display = 'none';
          title.textContent = 'Inserisci il tuo PIN';
          subtitle.textContent = 'Recupera il PIN dal tuo account: https://brytv.webnode.it/area/bryid';
        }

        authScreen.classList.remove('hidden');
        
        // Sintonizza sul canale 100 se necessario
        if (isExpired || reason) {
          setTimeout(() => {
            const configChannel = document.querySelector('[data-number="100"]');
            if (configChannel) {
              const index = Array.from(channels).indexOf(configChannel);
              selectChannel(index);
              changeVideo(index);
            }
          }, 100);
        }
        
        setTimeout(() => {
          document.querySelectorAll('.pin-digit')[0].focus();
        }, 100);
      }

      hideAuthScreen() {
        isPinInputActive = false;
        document.getElementById('pin-auth-screen').classList.add('hidden');
      }

      updateSubscriptionInfo() {
        const authData = JSON.parse(localStorage.getItem('pinAuthData') || '{}');
        
        if (!authData.authenticated || !authData.expiryDate) {
          return;
        }

        const userNameElement = document.getElementById('user-name');
        const daysRemainingElement = document.getElementById('days-remaining');

        userNameElement.textContent = authData.userName || 'Utente Premium';

        const now = new Date();
        const expiryDate = new Date(authData.expiryDate);
        
        // Calcolo preciso dei giorni e ore rimanenti
        const timeRemaining = expiryDate.getTime() - now.getTime();
        const daysRemaining = Math.floor(timeRemaining / (24 * 60 * 60 * 1000));
        const hoursRemaining = Math.floor((timeRemaining % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));

        if (timeRemaining > 0) {
          if (daysRemaining > 0) {
            daysRemainingElement.textContent = `${daysRemaining} giorni e ${hoursRemaining} ore rimanenti`;
          } else if (hoursRemaining > 0) {
            daysRemainingElement.textContent = `${hoursRemaining} ore rimanenti`;
          } else {
            const minutesRemaining = Math.floor((timeRemaining % (60 * 60 * 1000)) / (60 * 1000));
            daysRemainingElement.textContent = `${minutesRemaining} minuti rimanenti`;
          }
          
          daysRemainingElement.classList.remove('warning', 'critical');
          if (daysRemaining <= 0 && hoursRemaining <= 24) {
            daysRemainingElement.classList.add('critical');
          } else if (daysRemaining <= 3) {
            daysRemainingElement.classList.add('critical');
          } else if (daysRemaining <= 7) {
            daysRemainingElement.classList.add('warning');
          }
        } else {
          daysRemainingElement.textContent = 'Abbonamento scaduto';
          daysRemainingElement.classList.add('critical');
        }
      }

      startPeriodicCheck() {
        // Controllo ogni minuto per verificare i dati su Firestore
        setInterval(() => {
          this.checkFirestoreData();
        }, 60 * 1000); // 60 secondi

        // Controllo ogni 30 secondi per aggiornare l'interfaccia
        setInterval(() => {
          this.updateSubscriptionInfo();
        }, 30 * 1000); // 30 secondi

        // Primo controllo dopo 5 secondi dall'avvio
        setTimeout(() => {
          this.checkFirestoreData();
        }, 5000);
      }
    }

  // ===== SISTEMA MOSAICO EPG CORRETTO - CARICAMENTO UNICO =====
class MosaicSystem {
  constructor() {
    this.isActive = false;
    this.selectedCardIndex = 0;
    this.mosaicCards = [];
    this.epgData = new Map(); // Cache per i dati EPG
    this.updateInterval = null;
    this.epgLoaded = false; // Flag per tracciare se i dati sono stati caricati
    this.init();
  }

  init() {
    // Event listeners per attivazione mosaico
    document.getElementById('mosaic-nav-btn').addEventListener('click', () => this.toggleMosaic());
    document.getElementById('mosaic-close').addEventListener('click', () => this.closeMosaic());
    
    // 🚀 MODIFICA PRINCIPALE: Carica i dati EPG UNA SOLA VOLTA all'avvio
    this.loadEPGDataOnce();
    
    // 🚫 RIMOSSO: Non avviare più aggiornamenti periodici automatici
    // this.startPeriodicUpdate();
  }

  // 🆕 NUOVO METODO: Carica i dati EPG una sola volta
  async loadEPGDataOnce() {
    if (this.epgLoaded) {
      console.log('✅ Dati EPG già caricati, utilizzo cache esistente');
      return;
    }

    try {
      console.log('🔄 Caricamento UNICO dei dati EPG...');
      await this.loadEPGData();
      this.epgLoaded = true;
      console.log('✅ Dati EPG caricati con successo e memorizzati permanentemente');
    } catch (error) {
      console.error('❌ Errore durante il caricamento EPG:', error);
    }
  }

  async toggleMosaic() {
    if (this.isActive) {
      this.closeMosaic();
    } else {
      await this.openMosaic();
    }
  }

  async openMosaic() {
    this.isActive = true;
    document.getElementById('mosaic-overlay').classList.add('active');
    
    // 🚀 MODIFICA: Mostra indicatore solo se i dati non sono ancora stati caricati
    if (!this.epgLoaded) {
      this.showLoading(true);
      await this.loadEPGDataOnce();
      this.showLoading(false);
    }
    
    try {
      // Genera le card con i dati disponibili
      this.generateMosaicCards();
      
      // Seleziona la prima card
      this.selectedCardIndex = 0;
      this.updateCardSelection();
      
      // 🚀 MODIFICA: Avvia solo aggiornamento delle barre di progresso (non ricarica dati)
      this.startProgressUpdates();
      
    } catch (error) {
      console.error('Errore durante il caricamento del mosaico:', error);
    }
  }

  showLoading(show) {
    const loadingElement = document.getElementById('mosaic-loading');
    const contentElement = document.getElementById('mosaic-content');
    
    if (show) {
      loadingElement.style.display = 'flex';
      contentElement.classList.add('loading');
    } else {
      loadingElement.style.display = 'none';
      contentElement.classList.remove('loading');
    }
  }

  closeMosaic() {
    this.isActive = false;
    document.getElementById('mosaic-overlay').classList.remove('active');
    
    // Ferma gli aggiornamenti
    this.stopProgressUpdates();
  }
  
  async loadEPGData() {
    const channels = document.querySelectorAll('.channel-item');
    
    for (const channel of channels) {
      const channelNumber = channel.dataset.number;
      const epgUrl = channel.dataset.epgUrl;
      const epgId = channel.dataset.epgId;
      
      // 🚀 MODIFICA: Non sovrascrivere i dati se già esistono
      if (epgUrl && !this.epgData.has(channelNumber)) {
        try {
          console.log(`Caricamento EPG per canale ${channelNumber} da ${epgUrl}`);
          
          const response = await fetch(epgUrl);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const data = await response.json();
          
          // Gestisci diversi formati di risposta
          let channelData = null;
          
          if (Array.isArray(data)) {
            // Formato array di canali - cerca per epgId
            channelData = data.find(ch => ch.id === epgId);
          } else if (data.id) {
            // Formato singolo canale
            channelData = data;
          }
          
          if (channelData && channelData.programs) {
            this.epgData.set(channelNumber, channelData);
            console.log(`✅ EPG caricato per canale ${channelNumber}:`, channelData);
          } else {
            console.warn(`⚠️ Nessun programma trovato per canale ${channelNumber}, uso fallback`);
            // Usa dati di fallback
            this.epgData.set(channelNumber, this.getFallbackEPGData(channelNumber));
          }
          
        } catch (error) {
          console.error(`❌ Errore caricamento EPG per canale ${channelNumber}:`, error);
          // Usa dati di fallback in caso di errore
          this.epgData.set(channelNumber, this.getFallbackEPGData(channelNumber));
        }
      } else if (!epgUrl) {
        // Nessun URL EPG specificato, usa dati di fallback
        if (!this.epgData.has(channelNumber)) {
          this.epgData.set(channelNumber, this.getFallbackEPGData(channelNumber));
        }
      }
    }
  }

  getFallbackEPGData(channelNumber) {
    // Dati di fallback quando l'EPG non è disponibile
    const now = new Date();
    const startTime = new Date(now.getTime() - (30 * 60 * 1000)); // 30 minuti fa
    const endTime = new Date(now.getTime() + (90 * 60 * 1000)); // 90 minuti da ora
    
    return {
      id: `channel-${channelNumber}`,
      name: `Canale ${channelNumber}`,
      logo: '',
      programs: [{
        start: startTime.toISOString(),
        end: endTime.toISOString(),
        title: 'Programmazione in corso',
        description: 'Informazioni sul programma non disponibili',
        poster: '',
        channel: `channel-${channelNumber}`
      }]
    };
  }

  // 🔧 CORREZIONE: Sottrai 1 ora dai dati EPG solo per canali che non sono flix-animation
  getCurrentProgram(channelData, channelNumber = null) {
    if (!channelData || !channelData.programs) return null;

    const now = new Date();
    
    // 📺 Lista completa dei canali flix-animation (30 canali + quello originale)
    const flixAnimationChannels = [
      '109', '108', '110', '111', '112', '113', '114', '115', '116', '117',
      '118', '200', '201', '202', '203', '204', '205', '206', '207', '302', '303',
      '308', '405', '508', '509', '510', '511', '512', '605', '606', '150'
    ];
    
    const isFlixAnimation = flixAnimationChannels.includes(channelNumber) || 
                           (channelData.id && channelData.id.includes('flix-animation'));

    return channelData.programs.find(program => {
      const startTime = new Date(program.start);
      const endTime = new Date(program.end);

      // 💡 CORREZIONE: Per flix-animation aggiungi 2 ore (UTC+2), per altri sottrai 1 ora
      if (isFlixAnimation) {
        startTime.setHours(startTime.getHours() - 2);
        endTime.setHours(endTime.getHours() - 2);
      } else {
        startTime.setHours(startTime.getHours() - 1);
        endTime.setHours(endTime.getHours() - 1);
      }

      return now >= startTime && now <= endTime;
    });
  }

  // 🔧 CORREZIONE: Calcola il progresso con l'ora corretta
  calculateProgress(program, channelNumber = null) {
    if (!program) return 0;
    
    const now = new Date();
    const startTime = new Date(program.start);
    const endTime = new Date(program.end);
    
    // 📺 Lista completa dei canali flix-animation (30 canali + quello originale)
    const flixAnimationChannels = [
      '109', '108', '110', '111', '112', '113', '114', '115', '116', '117',
      '118', '200', '201', '202', '203', '204', '205', '206', '207', '302', '303',
      '308', '405', '508', '509', '510', '511', '512', '605', '606', '150'
    ];
    
    const isFlixAnimation = flixAnimationChannels.includes(channelNumber);
    
    // 💡 CORREZIONE: Per flix-animation aggiungi 2 ore (UTC+2), per altri sottrai 1 ora
    if (isFlixAnimation) {
      startTime.setHours(startTime.getHours() - 2);
      endTime.setHours(endTime.getHours() - 2);
    } else {
      startTime.setHours(startTime.getHours() - 1);
      endTime.setHours(endTime.getHours() - 1);
    }
    
    if (now < startTime) return 0;
    if (now > endTime) return 100;
    
    const totalDuration = endTime.getTime() - startTime.getTime();
    const elapsed = now.getTime() - startTime.getTime();
    
    return Math.round((elapsed / totalDuration) * 100);
  }

  // 🔧 CORREZIONE: Formatta l'ora sottraendo 1 ora solo se necessario
  formatTime(dateString, channelNumber = null) {
    const date = new Date(dateString);
    
    // 📺 Lista completa dei canali flix-animation (30 canali + quello originale)
    const flixAnimationChannels = [
      '109', '108', '110', '111', '112', '113', '114', '115', '116', '117',
      '118', '200', '201', '202', '203', '204', '205', '206', '207', '302', '303',
      '308', '405', '508', '509', '510', '511', '512', '605', '606', '150'
    ];
    
    const isFlixAnimation = flixAnimationChannels.includes(channelNumber);
    
    // 💡 CORREZIONE: Per flix-animation aggiungi 2 ore (UTC+2), per altri sottrai 1 ora
    if (isFlixAnimation) {
      date.setHours(date.getHours() - 2);
    } else {
      date.setHours(date.getHours() - 1);
    }
    
    return date.toLocaleTimeString('it-IT', {
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  generateMosaicCards() {
    const mosaicGrid = document.getElementById('mosaic-grid');
    
    // Mostra un messaggio se non ci sono canali
    if (this.epgData.size === 0) {
      mosaicGrid.innerHTML = '<div style="color: white; text-align: center; padding: 50px; font-size: 18px;">Nessun canale disponibile</div>';
      return;
    }
    
    mosaicGrid.innerHTML = '';
    this.mosaicCards = [];
      
    const channels = document.querySelectorAll('.channel-item');
    
    channels.forEach((channel, index) => {
      const channelNumber = channel.dataset.number;
      const channelName = channel.querySelector('.channel-name-main').textContent;
      const channelLogo = channel.querySelector('.channel-logo').src;
      
      // Salta il canale di configurazione
      if (channelNumber === '100') return;
      
      const channelData = this.epgData.get(channelNumber);
      const currentProgram = this.getCurrentProgram(channelData, channelNumber);
      
      const card = document.createElement('div');
      card.className = 'mosaic-card';
      card.dataset.channelNumber = channelNumber;
      card.dataset.channelIndex = index;
      
      const progress = this.calculateProgress(currentProgram, channelNumber);
      const progressText = currentProgram ? 
        `${this.formatTime(currentProgram.start, channelNumber)} - ${this.formatTime(currentProgram.end, channelNumber)}` :
        'Orario non disponibile';
      
      card.innerHTML = `
        <div class="mosaic-card-header">
          <img src="${channelLogo}" alt="${channelName}" class="mosaic-channel-logo" 
               onerror="this.style.display='none'">
          <div class="mosaic-channel-info">
            <div class="mosaic-channel-name">${channelName}</div>
            <div class="mosaic-channel-number">Canale ${channelNumber}</div>
          </div>
        </div>
        
        <div class="mosaic-program-poster">
          ${currentProgram && currentProgram.poster ? 
            `<img src="${currentProgram.poster}" alt="Poster programma" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.parentElement.innerHTML='<div style=\\'display: flex; align-items: center; justify-content: center; height: 100%; color: rgba(255,255,255,0.5); font-size: 14px;\\'>Immagine non disponibile</div>'">` :
            '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: rgba(255,255,255,0.5); font-size: 14px;">Immagine non disponibile</div>'
          }
        </div>
        
        <div class="mosaic-program-info">
          <div class="mosaic-program-title">
            ${currentProgram ? currentProgram.title : 'Programma non disponibile'}
          </div>
          <div class="mosaic-program-time">${progressText}</div>
          
          <div class="mosaic-progress-container">
            <div class="mosaic-progress-bar">
              <div class="mosaic-progress-fill" style="width: ${progress}%"></div>
            </div>
            <div class="mosaic-progress-text">${progress}% completato</div>
          </div>
        </div>
      `;
      
      // Event listener per selezione canale
      card.addEventListener('click', () => {
        this.selectChannel(channelNumber);
      });
      
      mosaicGrid.appendChild(card);
      this.mosaicCards.push(card);
    });
  }

  updateCardSelection() {
    // Assicurati che l'indice sia valido
    if (this.selectedCardIndex < 0) {
      this.selectedCardIndex = 0;
    } else if (this.selectedCardIndex >= this.mosaicCards.length) {
      this.selectedCardIndex = this.mosaicCards.length - 1;
    }

    

    this.mosaicCards.forEach((card, index) => {
      card.classList.toggle('selected', index === this.selectedCardIndex);
    });
    
    // Scroll alla card selezionata con controllo di validità
    if (this.mosaicCards[this.selectedCardIndex]) {
      this.mosaicCards[this.selectedCardIndex].scrollIntoView({
        behavior: 'smooth',
        block: 'center',
        inline: 'center'
      });
    }
  }

  selectChannel(channelNumber) {
    // Chiudi il mosaico
    this.closeMosaic();
    
    // Seleziona il canale
    const channel = document.querySelector(`[data-number="${channelNumber}"]`);
    if (channel) {
      const channels = document.querySelectorAll('.channel-item');
      const index = Array.from(channels).indexOf(channel);
      selectChannel(index);
      changeVideo(index);
    }
  }

  // 🔧 CORREZIONE PRINCIPALE: Calcolo preciso delle colonne per fullscreen
  navigateMosaic(direction) {
    if (!this.isActive || this.mosaicCards.length === 0) return;
    
    // 💡 CORREZIONE: Calcolo più preciso delle colonne
    const mosaicGrid = document.getElementById('mosaic-grid');
    const gridRect = mosaicGrid.getBoundingClientRect();
    
    // Ottieni le dimensioni effettive di una card
    const firstCard = this.mosaicCards[0];
    if (!firstCard) return;
    
    const cardRect = firstCard.getBoundingClientRect();
    const cardWidth = cardRect.width;
    
    // Calcola il gap tra le card dal CSS
    const gridStyle = window.getComputedStyle(mosaicGrid);
    const gap = parseInt(gridStyle.gap) || 20; // Default 20px se non specificato
    
    // Calcola il numero di colonne basandosi sulle dimensioni reali
    const availableWidth = gridRect.width;
    const cols = Math.floor((availableWidth + gap) / (cardWidth + gap));
    
    console.log(`🔍 Debug navigazione:`, {
      availableWidth,
      cardWidth,
      gap,
      cols,
      totalCards: this.mosaicCards.length,
      currentIndex: this.selectedCardIndex
    });
    
    const rows = Math.ceil(this.mosaicCards.length / cols);
    
    const currentRow = Math.floor(this.selectedCardIndex / cols);
    const currentCol = this.selectedCardIndex % cols;
    
    let newIndex = this.selectedCardIndex;
    
    switch (direction) {
      case 'left':
        if (currentCol > 0) {
          // Muovi a sinistra nella stessa riga
          newIndex = this.selectedCardIndex - 1;
        } else {
          // Se siamo all'inizio della riga, vai alla fine della riga precedente
          if (currentRow > 0) {
            const prevRowLastIndex = Math.min(this.mosaicCards.length - 1, (currentRow * cols) - 1);
            newIndex = prevRowLastIndex;
          } else {
            // Se siamo nella prima riga, vai all'ultima card dell'ultima riga
            newIndex = this.mosaicCards.length - 1;
          }
        }
        break;
        
      case 'right':
        if (currentCol < cols - 1 && this.selectedCardIndex + 1 < this.mosaicCards.length) {
          // Muovi a destra nella stessa riga
          newIndex = this.selectedCardIndex + 1;
        } else {
          // Se siamo alla fine della riga, vai all'inizio della riga successiva
          if (currentRow < rows - 1) {
            newIndex = (currentRow + 1) * cols;
            // Assicurati che l'indice non superi il numero di card
            if (newIndex >= this.mosaicCards.length) {
              newIndex = this.mosaicCards.length - 1;
            }
          } else {
            // Se siamo nell'ultima riga, vai alla prima card
            newIndex = 0;
          }
        }
        break;
        
      case 'up':
        if (currentRow > 0) {
          // Muovi su nella stessa colonna
          newIndex = Math.max(0, this.selectedCardIndex - cols);
        } else {
          // 🔧 CORREZIONE: Se siamo nella prima riga, vai all'ultima riga nella stessa colonna
          const lastRowStartIndex = (rows - 1) * cols;
          const targetIndex = lastRowStartIndex + currentCol;
          // Se l'indice target supera il numero di card, vai all'ultima card disponibile
          if (targetIndex >= this.mosaicCards.length) {
            newIndex = this.mosaicCards.length - 1;
          } else {
            newIndex = targetIndex;
          }
        }
        break;
        
      case 'down':
        if (currentRow < rows - 1) {
          // Muovi giù nella stessa colonna
          const targetIndex = this.selectedCardIndex + cols;
          if (targetIndex < this.mosaicCards.length) {
            newIndex = targetIndex;
          } else {
            // Se non c'è una card nella riga successiva nella stessa colonna, vai all'ultima card disponibile
            newIndex = this.mosaicCards.length - 1;
          }
        } else {
          // 🔧 CORREZIONE: Se siamo nell'ultima riga, vai alla prima riga nella stessa colonna
          newIndex = currentCol;
          // Assicurati che l'indice sia valido
          if (newIndex >= this.mosaicCards.length) {
            newIndex = 0;
          }
        }
        break;
    }
    
    // Assicurati che il nuovo indice sia sempre valido
    newIndex = Math.max(0, Math.min(this.mosaicCards.length - 1, newIndex));
    
    console.log(`🎯 Navigazione ${direction}: da ${this.selectedCardIndex} a ${newIndex}`);
    
    if (newIndex !== this.selectedCardIndex) {
      this.selectedCardIndex = newIndex;
      this.updateCardSelection();
    }
  }

  selectCurrentCard() {
    if (this.mosaicCards[this.selectedCardIndex]) {
      const channelNumber = this.mosaicCards[this.selectedCardIndex].dataset.channelNumber;
      this.selectChannel(channelNumber);
    }
  }

  startProgressUpdates() {
    // 🚀 MODIFICA: Aggiorna solo le barre di progresso, NON ricarica i dati EPG
    this.updateInterval = setInterval(() => {
      if (this.isActive) {
        this.updateProgressBars();
      }
    }, 30000); // Aggiorna ogni 30 secondi
  }

  stopProgressUpdates() {
    if (this.updateInterval) {
      clearInterval(this.updateInterval);
      this.updateInterval = null;
    }
  }

  updateProgressBars() {
    // 🚀 MODIFICA: Aggiorna solo le barre di progresso usando i dati EPG esistenti
    this.mosaicCards.forEach(card => {
      const channelNumber = card.dataset.channelNumber;
      const channelData = this.epgData.get(channelNumber);
      const currentProgram = this.getCurrentProgram(channelData, channelNumber);
      
      if (currentProgram) {
        const progress = this.calculateProgress(currentProgram, channelNumber);
        const progressFill = card.querySelector('.mosaic-progress-fill');
        const progressText = card.querySelector('.mosaic-progress-text');
        
        if (progressFill) {
          progressFill.style.width = progress + '%';
        }
        if (progressText) {
          progressText.textContent = progress + '% completato';
        }
      }
    });
  }

  // 🚫 RIMOSSO: Non più necessario l'aggiornamento periodico automatico
  // startPeriodicUpdate() { ... }

  // 🆕 NUOVO METODO: Forza il ricaricamento manuale dei dati EPG (se necessario)
  async forceReloadEPG() {
    console.log('🔄 Ricaricamento manuale dei dati EPG...');
    this.epgData.clear();
    this.epgLoaded = false;
    await this.loadEPGDataOnce();
    
    
    if (this.isActive) {
      this.generateMosaicCards();
      this.updateCardSelection();
      console.log('✅ Mosaico aggiornato con nuovi dati EPG');
    }
  }
}

// ===== SISTEMA MOSAICO FILTRATO CON NAVIGAZIONE TEMPORALE (TASTO 7) =====
class FilteredMosaicSystem {
  constructor() {
    this.isActive = false;
    this.selectedCategoryIndex = 0;
    this.selectedCardIndex = 0;
    this.selectedPopupButtonIndex = 0; // ✅ NUOVO: Indice per navigazione popup
    this.navigationMode = 'categories'; // 'categories', 'cards', 'time', 'popup'
    this.filteredCards = [];
    this.currentFilter = 'tutti';
    this.epgData = new Map(); // Cache per i dati EPG
    this.updateInterval = null;
    this.epgLoaded = false; // Flag per tracciare se i dati sono stati caricati
    
    // ===== NUOVE PROPRIETÀ PER NAVIGAZIONE TEMPORALE =====
    this.currentTimeOffset = 0; // Offset in ore dalla ora corrente (0 = ora corrente, 1 = +1 ora, -1 = -1 ora)
    this.maxTimeOffset = 12; // Massimo 12 ore nel futuro
    this.minTimeOffset = -6; // Massimo 6 ore nel passato
    this.scheduledChannels = new Map(); // Mappa dei canali programmati
    
    this.init();
  }

  init() {
    // Event listeners
    document.getElementById('filtered-mosaic-close').addEventListener('click', () => this.closeMosaic());
    
    // Setup categorie
    this.setupCategories();
    
    // ===== NUOVI EVENT LISTENERS PER NAVIGAZIONE TEMPORALE =====
    document.getElementById('time-prev-btn').addEventListener('click', () => this.navigateTime(-1));
    document.getElementById('time-next-btn').addEventListener('click', () => this.navigateTime(1));
    
    // Setup popup programmazione
    this.setupSchedulePopup();
    
    // 🚀 MODIFICA PRINCIPALE: Carica i dati EPG UNA SOLA VOLTA all'avvio
    this.loadEPGDataOnce();
    
    // Carica i canali programmati salvati
    this.loadScheduledChannels();
    this.startScheduleChecker();
  }

  setupCategories() {
    const categoryItems = document.querySelectorAll('.filtered-category-item');
    
    categoryItems.forEach((item, index) => {
      item.addEventListener('click', () => {
        this.selectedCategoryIndex = index;
        this.selectCategory(item.dataset.filterCategory);
      });
    });
  }

  // ===== NUOVI METODI PER NAVIGAZIONE TEMPORALE =====
  
  navigateTime(direction) {
    const newOffset = this.currentTimeOffset + direction;
    
    // Verifica i limiti
    if (newOffset > this.maxTimeOffset || newOffset < this.minTimeOffset) {
      return;
    }
    
    this.currentTimeOffset = newOffset;
    this.updateTimeDisplay();
    this.generateFilteredCards(this.currentFilter);
    this.updateCardSelection();
    
    console.log('🕒 Navigazione temporale:', direction > 0 ? 'futuro' : 'passato', '- Offset:', this.currentTimeOffset);
  }

  updateTimeDisplay() {
    const currentTimeDisplay = document.getElementById('current-time-display');
    const timeIndicator = document.getElementById('time-indicator');
    const prevBtn = document.getElementById('time-prev-btn');
    const nextBtn = document.getElementById('time-next-btn');
    
    const now = new Date();
    const targetTime = new Date(now.getTime() + (this.currentTimeOffset * 60 * 60 * 1000));
    
    // Formatta l'ora
    const timeString = targetTime.toLocaleTimeString('it-IT', {
      hour: '2-digit',
      minute: '2-digit'
    });
    
    currentTimeDisplay.textContent = timeString;
    
    // Aggiorna l'indicatore
    if (this.currentTimeOffset === 0) {
      timeIndicator.textContent = 'Programmi in corso';
    } else if (this.currentTimeOffset > 0) {
      timeIndicator.textContent = `Programmi tra ${this.currentTimeOffset} ora${this.currentTimeOffset > 1 ? 'e' : ''}`;
    } else {
      timeIndicator.textContent = `Programmi di ${Math.abs(this.currentTimeOffset)} ora${Math.abs(this.currentTimeOffset) > 1 ? 'e' : ''} fa`;
    }
    
    // Aggiorna lo stato dei pulsanti
    prevBtn.disabled = this.currentTimeOffset <= this.minTimeOffset;
    nextBtn.disabled = this.currentTimeOffset >= this.maxTimeOffset;
    
    // ✅ NUOVO: Aggiorna focus sui pulsanti temporali se in modalità time
    if (this.navigationMode === 'time') {
      this.updateTimeButtonSelection();
    }
  }

  // ✅ NUOVO: Aggiorna la selezione dei pulsanti temporali
  updateTimeButtonSelection() {
    const prevBtn = document.getElementById('time-prev-btn');
    const nextBtn = document.getElementById('time-next-btn');
    
    // Rimuovi focus da entrambi
    prevBtn.classList.remove('focused');
    nextBtn.classList.remove('focused');
    
    // Non aggiungere focus se siamo ai limiti
    // Il focus verrà gestito dalla navigazione
  }

  // Ottieni il programma per un orario specifico
  getProgramAtTime(channelData, channelNumber, timeOffset) {
    if (!channelData || !channelData.programs) return null;

    const targetTime = new Date(Date.now() + (timeOffset * 60 * 60 * 1000));
    
    const flixAnimationChannels = [
      '109', '108', '110', '111', '112', '113', '114', '115', '116', '117',
      '118', '200', '201', '202', '203', '204', '205', '206', '207', '302', '303',
      '308', '405', '508', '509', '510', '511', '512', '605', '606', '150'
    ];
    
    const isFlixAnimation = flixAnimationChannels.includes(channelNumber) || 
                           (channelData.id && channelData.id.includes('flix-animation'));

    return channelData.programs.find(program => {
      const startTime = new Date(program.start);
      const endTime = new Date(program.end);

      if (isFlixAnimation) {
        startTime.setHours(startTime.getHours() - 2);
        endTime.setHours(endTime.getHours() - 2);
      } else {
        startTime.setHours(startTime.getHours() - 1);
        endTime.setHours(endTime.getHours() - 1);
      }

      return targetTime >= startTime && targetTime <= endTime;
    });
  }

  // Verifica se un programma è futuro
  isProgramFuture(program, channelNumber) {
    if (!program) return false;
    
    const now = new Date();
    const startTime = new Date(program.start);
    
    const flixAnimationChannels = [
      '109', '108', '110', '111', '112', '113', '114', '115', '116', '117',
      '118', '200', '201', '202', '203', '204', '205', '206', '207', '302', '303',
      '308', '405', '508', '509', '510', '511', '512', '605', '606', '150'
    ];
    
    const isFlixAnimation = flixAnimationChannels.includes(channelNumber);
    
    if (isFlixAnimation) {
      startTime.setHours(startTime.getHours() - 2);
    } else {
      startTime.setHours(startTime.getHours() - 1);
    }
    
    return startTime > now;
  }

  // ✅ NUOVO: Setup del popup di programmazione con navigazione
  setupSchedulePopup() {
    const popup = document.getElementById('schedule-popup');
    const scheduleBtn = document.getElementById('schedule-btn');
    const watchNowBtn = document.getElementById('watch-now-btn');
    const cancelBtn = document.getElementById('cancel-schedule-btn');
    
    // Array dei pulsanti per la navigazione
    this.popupButtons = [scheduleBtn, watchNowBtn, cancelBtn];
    
    scheduleBtn.addEventListener('click', () => {
      this.scheduleChannelChange();
      this.hideSchedulePopup();
    });
    
    watchNowBtn.addEventListener('click', () => {
      this.watchChannelNow();
      this.hideSchedulePopup();
    });
    
    cancelBtn.addEventListener('click', () => {
      this.hideSchedulePopup();
    });
    
    // Chiudi popup cliccando fuori
    popup.addEventListener('click', (e) => {
      if (e.target === popup) {
        this.hideSchedulePopup();
      }
    });
  }

  // ✅ MODIFICATO: Mostra il popup di programmazione con navigazione
  showSchedulePopup(channelNumber, program) {
    const popup = document.getElementById('schedule-popup');
    const programTitle = document.getElementById('schedule-popup-program-title');
    const programTime = document.getElementById('schedule-popup-program-time');
    
    // Memorizza i dati per l'azione
    popup.dataset.channelNumber = channelNumber;
    popup.dataset.programData = JSON.stringify(program);
    
    // Aggiorna le informazioni del programma
    programTitle.textContent = program.title;
    programTime.textContent = `${this.formatTime(program.start, channelNumber)} - ${this.formatTime(program.end, channelNumber)}`;
    
    // Imposta modalità navigazione popup
    this.navigationMode = 'popup';
    this.selectedPopupButtonIndex = 0;
    this.updatePopupButtonSelection();
    
    // Mostra il popup
    popup.classList.add('show');
  }

  // ✅ NUOVO: Nascondi popup e torna alla navigazione precedente
  hideSchedulePopup() {
    const popup = document.getElementById('schedule-popup');
    popup.classList.remove('show');
    
    // Torna alla navigazione delle card
    this.navigationMode = 'cards';
    this.updateCardSelection();
  }

  // ✅ NUOVO: Aggiorna la selezione dei pulsanti nel popup
  updatePopupButtonSelection() {
    // Assicurati che l'indice sia valido
    if (this.selectedPopupButtonIndex < 0) {
      this.selectedPopupButtonIndex = 0;
    } else if (this.selectedPopupButtonIndex >= this.popupButtons.length) {
      this.selectedPopupButtonIndex = this.popupButtons.length - 1;
    }

    this.popupButtons.forEach((button, index) => {
      button.classList.toggle('focused', index === this.selectedPopupButtonIndex);
    });
  }

  // ✅ NUOVO: Naviga tra i pulsanti del popup
  navigatePopupButtons(direction) {
    switch (direction) {
      case 'up':
        if (this.selectedPopupButtonIndex > 0) {
          this.selectedPopupButtonIndex--;
        } else {
          this.selectedPopupButtonIndex = this.popupButtons.length - 1;
        }
        break;
        
      case 'down':
        if (this.selectedPopupButtonIndex < this.popupButtons.length - 1) {
          this.selectedPopupButtonIndex++;
        } else {
          this.selectedPopupButtonIndex = 0;
        }
        break;
    }
    
    this.updatePopupButtonSelection();
  }

  // ✅ NUOVO: Seleziona il pulsante corrente nel popup
  selectCurrentPopupButton() {
    if (this.popupButtons[this.selectedPopupButtonIndex]) {
      this.popupButtons[this.selectedPopupButtonIndex].click();
    }
  }

  // Programma il cambio canale
  scheduleChannelChange() {
    const popup = document.getElementById('schedule-popup');
    const channelNumber = popup.dataset.channelNumber;
    const program = JSON.parse(popup.dataset.programData);
    
    // Salva la programmazione
    this.scheduledChannels.set(channelNumber, {
      program: program,
      scheduledAt: Date.now(),
      channelNumber: channelNumber
    });
    
    this.saveScheduledChannels();
    
    // Mostra notifica
    this.showScheduleNotification(`Cambio canale programmato per ${this.formatTime(program.start, channelNumber)}`);
    
    console.log('📅 Canale programmato:', channelNumber, 'per', this.formatTime(program.start, channelNumber));
  }

  // Guarda il canale ora
  watchChannelNow() {
    const popup = document.getElementById('schedule-popup');
    const channelNumber = popup.dataset.channelNumber;
    
    // Chiudi il mosaico e cambia canale
    this.closeMosaic();
    
    const channel = document.querySelector(`[data-number="${channelNumber}"]`);
    if (channel) {
      const channels = document.querySelectorAll('.channel-item');
      const index = Array.from(channels).indexOf(channel);
      selectChannel(index);
      changeVideo(index);
    }
  }

  // Mostra notifica di programmazione
  showScheduleNotification(message) {
    const notification = document.getElementById('favorites-notification');
    const notificationText = document.getElementById('notification-text');
    const notificationIcon = document.getElementById('notification-icon');
    
    // Rimuovi eventuali timeout precedenti
    if (window.scheduleNotificationTimeout) {
      clearTimeout(window.scheduleNotificationTimeout);
    }
    
    // Imposta il messaggio e l'icona
    notificationIcon.textContent = '📅';
    notificationText.textContent = message;
    notification.classList.remove('favorites-mode');
    notification.classList.add('show');
    
    // Nascondi dopo 4 secondi
    window.scheduleNotificationTimeout = setTimeout(() => {
      notification.classList.remove('show');
    }, 4000);
  }

  // Salva i canali programmati
  saveScheduledChannels() {
    const scheduledData = Array.from(this.scheduledChannels.entries());
    localStorage.setItem('scheduledChannels', JSON.stringify(scheduledData));
  }

  // Carica i canali programmati
  loadScheduledChannels() {
    try {
      const savedData = localStorage.getItem('scheduledChannels');
      if (savedData) {
        const scheduledData = JSON.parse(savedData);
        this.scheduledChannels = new Map(scheduledData);
        
        // Avvia il controllo periodico per i canali programmati
        this.startScheduleChecker();
      }
    } catch (error) {
      console.error('Errore caricamento canali programmati:', error);
    }
  }

  // Controllo periodico per i canali programmati
  startScheduleChecker() {
    setInterval(() => {
      this.checkScheduledChannels();
    }, 30000); // Controlla ogni 30 secondi
  }

  // Verifica se è ora di cambiare canale
  checkScheduledChannels() {
    const now = new Date();
    
    this.scheduledChannels.forEach((scheduledData, channelNumber) => {
      const program = scheduledData.program;
      const startTime = new Date(program.start);
      
      // Applica la correzione oraria
      const flixAnimationChannels = [
        '109', '108', '110', '111', '112', '113', '114', '115', '116', '117',
        '118', '200', '201', '202', '203', '204', '205', '206', '207', '302', '303',
        '308', '405', '508', '509', '510', '511', '512', '605', '606', '150'
      ];
      
      const isFlixAnimation = flixAnimationChannels.includes(channelNumber);
      
      if (isFlixAnimation) {
        startTime.setHours(startTime.getHours() - 2);
      } else {
        startTime.setHours(startTime.getHours() - 1);
      }
      
      // Se è ora di cambiare canale (con tolleranza di 3 minuto)
      const timeDiff = Math.abs(now.getTime() - startTime.getTime());
      if (timeDiff <= 180000) { // 3 minuti di tolleranza
        console.log('🔔 È ora di cambiare canale:', channelNumber);
        
        // Cambia canale
        const channel = document.querySelector(`[data-number="${channelNumber}"]`);
        if (channel) {
          const channels = document.querySelectorAll('.channel-item');
          const index = Array.from(channels).indexOf(channel);
          selectChannel(index);
          changeVideo(index);
          
          // Mostra notifica
          this.showScheduleNotification(`Cambio automatico su canale ${channelNumber}`);
          
          // Rimuovi dalla programmazione
          this.scheduledChannels.delete(channelNumber);
          this.saveScheduledChannels();
        }
      }
    });
  }

  // 🆕 NUOVO METODO: Carica i dati EPG una sola volta
  async loadEPGDataOnce() {
    if (this.epgLoaded) {
      console.log('✅ Dati EPG già caricati per mosaico filtrato, utilizzo cache esistente');
      return;
    }

    try {
      console.log('🔄 Caricamento UNICO dei dati EPG per mosaico filtrato...');
      await this.loadEPGData();
      this.epgLoaded = true;
      console.log('✅ Dati EPG caricati con successo per mosaico filtrato');
    } catch (error) {
      console.error('❌ Errore caricamento EPG mosaico filtrato:', error);
    }
  }

  async loadEPGData() {
    const channels = document.querySelectorAll('.channel-item');
    
    for (const channel of channels) {
      const channelNumber = channel.dataset.number;
      const epgUrl = channel.dataset.epgUrl;
      const epgId = channel.dataset.epgId;
      
      // 🚀 MODIFICA: Non sovrascrivere i dati se già esistono
      if (epgUrl && !this.epgData.has(channelNumber)) {
        try {
          const response = await fetch(epgUrl);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const data = await response.json();
          
          let channelData = null;
          
          if (Array.isArray(data)) {
            channelData = data.find(ch => ch.id === epgId);
          } else if (data.id) {
            channelData = data;
          }
          
          if (channelData && channelData.programs) {
            this.epgData.set(channelNumber, channelData);
          } else {
            this.epgData.set(channelNumber, this.getFallbackEPGData(channelNumber));
          }
          
        } catch (error) {
          console.error(`Errore caricamento EPG per canale ${channelNumber}:`, error);
          this.epgData.set(channelNumber, this.getFallbackEPGData(channelNumber));
        }
      } else if (!epgUrl && !this.epgData.has(channelNumber)) {
        this.epgData.set(channelNumber, this.getFallbackEPGData(channelNumber));
      }
    }
  }

  getFallbackEPGData(channelNumber) {
    const now = new Date();
    const startTime = new Date(now.getTime() - (30 * 60 * 1000));
    const endTime = new Date(now.getTime() + (90 * 60 * 1000));
    
    return {
      id: `channel-${channelNumber}`,
      name: `Canale ${channelNumber}`,
      logo: '',
      programs: [{
        start: startTime.toISOString(),
        end: endTime.toISOString(),
        title: 'Programmazione in corso',
        description: 'Informazioni sul programma non disponibili',
        poster: '',
        channel: `channel-${channelNumber}`
      }]
    };
  }

  getCurrentProgram(channelData, channelNumber = null) {
    if (!channelData || !channelData.programs) return null;

    const now = new Date();
    
    const flixAnimationChannels = [
      '109', '108', '110', '111', '112', '113', '114', '115', '116', '117',
      '118', '200', '201', '202', '203', '204', '205', '206', '207', '302', '303',
      '308', '405', '508', '509', '510', '511', '512', '605', '606', '150'
    ];
    
    const isFlixAnimation = flixAnimationChannels.includes(channelNumber) || 
                           (channelData.id && channelData.id.includes('flix-animation'));

    return channelData.programs.find(program => {
      const startTime = new Date(program.start);
      const endTime = new Date(program.end);

      if (isFlixAnimation) {
        startTime.setHours(startTime.getHours() - 2);
        endTime.setHours(endTime.getHours() - 2);
      } else {
        startTime.setHours(startTime.getHours() - 1);
        endTime.setHours(endTime.getHours() - 1);
      }

      return now >= startTime && now <= endTime;
    });
  }

  calculateProgress(program, channelNumber = null) {
    if (!program) return 0;
    
    const now = new Date();
    const startTime = new Date(program.start);
    const endTime = new Date(program.end);
    
    const flixAnimationChannels = [
      '109', '108', '110', '111', '112', '113', '114', '115', '116', '117',
      '118', '200', '201', '202', '203', '204', '205', '206', '207', '302', '303',
      '308', '405', '508', '509', '510', '511', '512', '605', '606', '150'
    ];
    
    const isFlixAnimation = flixAnimationChannels.includes(channelNumber);
    
    if (isFlixAnimation) {
      startTime.setHours(startTime.getHours() - 2);
      endTime.setHours(endTime.getHours() - 2);
    } else {
      startTime.setHours(startTime.getHours() - 1);
      endTime.setHours(endTime.getHours() - 1);
    }
    
    if (now < startTime) return 0;
    if (now > endTime) return 100;
    
    const totalDuration = endTime.getTime() - startTime.getTime();
    const elapsed = now.getTime() - startTime.getTime();
    
    return Math.round((elapsed / totalDuration) * 100);
  }

  formatTime(dateString, channelNumber = null) {
    const date = new Date(dateString);
    
    const flixAnimationChannels = [
      '109', '108', '110', '111', '112', '113', '114', '115', '116', '117',
      '118', '200', '201', '202', '203', '204', '205', '206', '207', '302', '303',
      '308', '405', '508', '509', '510', '511', '512', '605', '606', '150'
    ];
    
    const isFlixAnimation = flixAnimationChannels.includes(channelNumber);
    
    if (isFlixAnimation) {
      date.setHours(date.getHours() - 2);
    } else {
      date.setHours(date.getHours() - 1);
    }
    
    return date.toLocaleTimeString('it-IT', {
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  async toggleMosaic() {
    if (this.isActive) {
      this.closeMosaic();
    } else {
      await this.openMosaic();
    }
  }

  async openMosaic() {
    this.isActive = true;
    document.getElementById('filtered-mosaic-overlay').classList.add('active');
    
    // 🚀 MODIFICA: Mostra indicatore solo se i dati non sono ancora stati caricati
    if (!this.epgLoaded) {
      this.showLoading(true);
      await this.loadEPGDataOnce();
      this.showLoading(false);
    }
    
    try {
      // Aggiorna i contatori delle categorie
      this.updateCategoryCounts();
      
      // Inizializza la visualizzazione temporale
      this.currentTimeOffset = 0;
      this.updateTimeDisplay();
      
      // Carica la categoria salvata o default
      const savedCategory = localStorage.getItem('filteredMosaicCategory') || 'tutti';
      this.selectCategory(savedCategory);
      
      // Imposta la navigazione iniziale sulle categorie
      this.navigationMode = 'categories';
      this.updateCategorySelection();
      
      // 🚀 MODIFICA: Avvia solo aggiornamento delle barre di progresso
      this.startProgressUpdates();
      
    } catch (error) {
      console.error('Errore apertura mosaico filtrato:', error);
    }
  }

  closeMosaic() {
    this.isActive = false;
    document.getElementById('filtered-mosaic-overlay').classList.remove('active');
    
    // Ferma gli aggiornamenti
    this.stopProgressUpdates();
    
    // Nascondi il popup se aperto
    this.hideSchedulePopup();
  }

  showLoading(show) {
    const loadingElement = document.getElementById('filtered-mosaic-loading');
    const containerElement = document.getElementById('filtered-mosaic-grid-container');
    
    if (show) {
      loadingElement.style.display = 'flex';
      containerElement.classList.add('loading');
    } else {
      loadingElement.style.display = 'none';
      containerElement.classList.remove('loading');
    }
  }

  updateCategoryCounts() {
    const channels = document.querySelectorAll('.channel-item');
    const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
    
    const counts = {
      tutti: 0,
      nazionali: 0,
      show: 0,
      generali: 0,
      sport: 0,
      cinema: 0,
      documentari: 0,
      cucina: 0,
      news: 0,
      bambini: 0,
      musica: 0,
      preferiti: favorites.length
    };

    channels.forEach(channel => {
      const category = channel.dataset.category;
      const channelNumber = channel.dataset.number;
      
      // Salta il canale di configurazione
      if (channelNumber === '100') return;
      
      counts.tutti++;
      if (counts[category] !== undefined) {
        counts[category]++;
      }
    });

    // Aggiorna i contatori nell'interfaccia
    Object.keys(counts).forEach(category => {
      const countElement = document.getElementById(`count-${category}`);
      if (countElement) {
        countElement.textContent = counts[category];
      }
    });
  }

  selectCategory(categoryName) {
    this.currentFilter = categoryName;
    
    // Salva la categoria selezionata
    localStorage.setItem('filteredMosaicCategory', categoryName);
    
    // Aggiorna l'interfaccia delle categorie
    const categoryItems = document.querySelectorAll('.filtered-category-item');
    categoryItems.forEach(item => {
      item.classList.remove('active');
      if (item.dataset.filterCategory === categoryName) {
        item.classList.add('active');
      }
    });
    
    // Aggiorna il titolo
    this.updateCategoryTitle(categoryName);
    
    // Genera le card filtrate
    this.generateFilteredCards(categoryName);
    
    // Reset selezione card
    this.selectedCardIndex = 0;
    this.navigationMode = 'cards';
    this.updateCardSelection();
  }

  updateCategoryTitle(categoryName) {
    const titles = {
      'tutti': 'TUTTI I CANALI',
      'nazionali': 'CANALI NAZIONALI',
      'show': 'SHOW & SERIE',
      'generali': 'CANALI GENERALI',
      'sport': 'CANALI SPORT',
      'cinema': 'CANALI CINEMA',
      'documentari': 'DOCUMENTARI & LIFESTYLE',
      'cucina': 'CUCINA & LIFESTYLE',
      'news': 'NEWS & METEO',
      'bambini': 'BAMBINI & RAGAZZI',
      'musica': 'MUSICA & RADIO',
      'preferiti': 'CANALI PREFERITI'
    };

    const subtitles = {
      'tutti': 'Visualizzazione di tutti i canali disponibili',
      'nazionali': 'Canali televisivi nazionali italiani',
      'show': 'Serie TV, show e intrattenimento',
      'generali': 'Canali di intrattenimento generale',
      'sport': 'Canali dedicati allo sport',
      'cinema': 'Film e contenuti cinematografici',
      'documentari': 'Documentari e programmi educativi',
      'cucina': 'Programmi di cucina e gastronomia',
      'news': 'Notizie, informazione e meteo',
      'bambini': 'Contenuti per bambini e ragazzi',
      'musica': 'Musica, radio e intrattenimento musicale',
      'preferiti': 'I tuoi canali preferiti salvati'
    };

    document.getElementById('filtered-mosaic-category-title').textContent = titles[categoryName] || 'CATEGORIA';
    document.getElementById('filtered-mosaic-category-subtitle').textContent = subtitles[categoryName] || 'Canali filtrati per categoria';
  }

  generateFilteredCards(categoryName) {
    const grid = document.getElementById('filtered-mosaic-grid');
    grid.innerHTML = '';
    this.filteredCards = [];

    const channels = document.querySelectorAll('.channel-item');
    const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');

    channels.forEach((channel, index) => {
      const channelNumber = channel.dataset.number;
      const channelCategory = channel.dataset.category;
      const channelName = channel.querySelector('.channel-name-main').textContent;
      const channelLogo = channel.querySelector('.channel-logo').src;
      
      // Salta il canale di configurazione
      if (channelNumber === '100') return;
      
      // Applica il filtro
      let shouldShow = false;
      
      if (categoryName === 'tutti') {
        shouldShow = true;
      } else if (categoryName === 'preferiti') {
        shouldShow = favorites.includes(channelNumber);
      } else {
        shouldShow = channelCategory === categoryName;
      }
      
      if (!shouldShow) return;
      
      // ===== MODIFICA PRINCIPALE: Usa il programma per l'orario selezionato =====
      const channelData = this.epgData.get(channelNumber);
      const program = this.getProgramAtTime(channelData, channelNumber, this.currentTimeOffset);
      
      const card = document.createElement('div');
      card.className = 'filtered-mosaic-card';
      card.dataset.channelNumber = channelNumber;
      card.dataset.channelIndex = index;
      
      // ===== VERIFICA SE IL PROGRAMMA È FUTURO =====
      const isFuture = this.isProgramFuture(program, channelNumber);
      if (isFuture) {
        card.classList.add('future-program');
      }
      
      const progress = this.calculateProgress(program, channelNumber);
      const progressText = program ? 
        `${this.formatTime(program.start, channelNumber)} - ${this.formatTime(program.end, channelNumber)}` :
        'Orario non disponibile';
      
      card.innerHTML = `
        <div class="filtered-mosaic-card-header">
          <img src="${channelLogo}" alt="${channelName}" class="filtered-mosaic-channel-logo" 
               onerror="this.style.display='none'">
          <div class="filtered-mosaic-channel-info">
            <div class="filtered-mosaic-channel-name">${channelName}</div>
            <div class="filtered-mosaic-channel-number">Canale ${channelNumber}</div>
          </div>
        </div>
        
        <div class="filtered-mosaic-program-poster">
          ${program && program.poster ? 
            `<img src="${program.poster}" alt="Poster programma" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.parentElement.innerHTML='<div style=\\'display: flex; align-items: center; justify-content: center; height: 100%; color: rgba(255,255,255,0.5); font-size: 14px;\\'>Immagine non disponibile</div>'">` :
            '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: rgba(255,255,255,0.5); font-size: 14px;">Immagine non disponibile</div>'
          }
        </div>
        
        <div class="filtered-mosaic-program-info">
          <div class="filtered-mosaic-program-title">
            ${program ? program.title : 'Programma non disponibile'}
          </div>
          <div class="filtered-mosaic-program-time">${progressText}</div>
          
          <div class="filtered-mosaic-progress-container">
            <div class="filtered-mosaic-progress-bar">
              <div class="filtered-mosaic-progress-fill" style="width: ${progress}%"></div>
            </div>
            <div class="filtered-mosaic-progress-text">${progress}% completato</div>
          </div>
        </div>
      `;
      
      // ===== EVENT LISTENER MODIFICATO PER GESTIRE PROGRAMMI FUTURI =====
      card.addEventListener('click', () => {
        if (isFuture && this.currentTimeOffset > 0) {
          // Mostra popup per programmi futuri
          this.showSchedulePopup(channelNumber, program);
        } else {
          // Comportamento normale per programmi correnti
          this.selectChannel(channelNumber);
        }
      });
      
      grid.appendChild(card);
      this.filteredCards.push(card);
    });

    // Se non ci sono canali per questa categoria
    if (this.filteredCards.length === 0) {
      grid.innerHTML = `
        <div style="color: white; text-align: center; padding: 50px; font-size: 18px; grid-column: 1 / -1;">
          Nessun canale disponibile per questa categoria
        </div>
      `;
    }
  }

  updateCategorySelection() {
    const categoryItems = document.querySelectorAll('.filtered-category-item');
    
    // Assicurati che l'indice sia valido
    if (this.selectedCategoryIndex < 0) {
      this.selectedCategoryIndex = 0;
    } else if (this.selectedCategoryIndex >= categoryItems.length) {
      this.selectedCategoryIndex = categoryItems.length - 1;
    }

    categoryItems.forEach((item, index) => {
      item.classList.toggle('focused', index === this.selectedCategoryIndex);
    });
    
    // Scroll alla categoria selezionata
    if (categoryItems[this.selectedCategoryIndex]) {
      categoryItems[this.selectedCategoryIndex].scrollIntoView({
        behavior: 'smooth',
        block: 'center'
      });
    }
  }

  updateCardSelection() {
    if (this.filteredCards.length === 0) return;
    
    // Assicurati che l'indice sia valido
    if (this.selectedCardIndex < 0) {
      this.selectedCardIndex = 0;
    } else if (this.selectedCardIndex >= this.filteredCards.length) {
      this.selectedCardIndex = this.filteredCards.length - 1;
    }

    this.filteredCards.forEach((card, index) => {
      card.classList.toggle('selected', index === this.selectedCardIndex);
    });
    
    // Scroll alla card selezionata
    if (this.filteredCards[this.selectedCardIndex]) {
      this.filteredCards[this.selectedCardIndex].scrollIntoView({
        behavior: 'smooth',
        block: 'center',
        inline: 'center'
      });
    }
  }

  // ✅ MODIFICATO: Gestione navigazione principale con supporto popup
  navigate(direction) {
    if (!this.isActive) return;

    // ✅ NUOVO: Gestione navigazione nel popup
    if (this.navigationMode === 'popup') {
      if (direction === 'up' || direction === 'down') {
        this.navigatePopupButtons(direction);
      }
      return;
    }

    if (this.navigationMode === 'categories') {
      this.navigateCategories(direction);
    } else if (this.navigationMode === 'cards') {
      this.navigateCards(direction);
    } else if (this.navigationMode === 'time') {
      this.navigateTimeButtons(direction);
    }
  }

  navigateCategories(direction) {
    const categoryItems = document.querySelectorAll('.filtered-category-item');
    
    switch (direction) {
      case 'up':
        if (this.selectedCategoryIndex > 0) {
          this.selectedCategoryIndex--;
        } else {
          this.selectedCategoryIndex = categoryItems.length - 1;
        }
        break;
        
      case 'down':
        if (this.selectedCategoryIndex < categoryItems.length - 1) {
          this.selectedCategoryIndex++;
        } else {
          this.selectedCategoryIndex = 0;
        }
        break;
        
      case 'right':
        // Passa alla navigazione delle card
        this.navigationMode = 'cards';
        this.updateCardSelection();
        return;
    }
    
    this.updateCategorySelection();
  }

  // ✅ MODIFICATO: Navigazione card con gestione tasti 4 e 5
  navigateCards(direction) {
    if (this.filteredCards.length === 0) return;
    
    // ===== GESTIONE FRECCE SINISTRA/DESTRA =====
    if (direction === 'left' || direction === 'right') {
      // Se siamo nella prima colonna e andiamo a sinistra, torna alle categorie
      const grid = document.getElementById('filtered-mosaic-grid');
      const gridRect = grid.getBoundingClientRect();
      const firstCard = this.filteredCards[0];
      
      if (firstCard) {
        const cardRect = firstCard.getBoundingClientRect();
        const cardWidth = cardRect.width;
        const gridStyle = window.getComputedStyle(grid);
        const gap = parseInt(gridStyle.gap) || 20;
        
        const availableWidth = gridRect.width;
        const cols = Math.floor((availableWidth + gap) / (cardWidth + gap));
        const currentCol = this.selectedCardIndex % cols;
        
        if (direction === 'left' && currentCol === 0) {
          // Torna alla navigazione delle categorie
          this.navigationMode = 'categories';
          this.updateCategorySelection();
          return;
        }
      }
      
      // Navigazione orizzontale tra le card
      this.navigateCardsHorizontal(direction);
      return;
    }
    
    // Navigazione verticale tra le card
    this.navigateCardsVertical(direction);
  }

  // ✅ NUOVO: Navigazione orizzontale tra le card
  navigateCardsHorizontal(direction) {
    const grid = document.getElementById('filtered-mosaic-grid');
    const gridRect = grid.getBoundingClientRect();
    const firstCard = this.filteredCards[0];
    
    if (!firstCard) return;
    
    const cardRect = firstCard.getBoundingClientRect();
    const cardWidth = cardRect.width;
    const gridStyle = window.getComputedStyle(grid);
    const gap = parseInt(gridStyle.gap) || 20;
    
    const availableWidth = gridRect.width;
    const cols = Math.floor((availableWidth + gap) / (cardWidth + gap));
    const rows = Math.ceil(this.filteredCards.length / cols);
    
    const currentRow = Math.floor(this.selectedCardIndex / cols);
    const currentCol = this.selectedCardIndex % cols;
    
    let newIndex = this.selectedCardIndex;
    
    if (direction === 'left') {
      if (currentCol > 0) {
        newIndex = this.selectedCardIndex - 1;
      } else {
        // Vai alla fine della riga precedente
        if (currentRow > 0) {
          const prevRowLastIndex = Math.min(this.filteredCards.length - 1, (currentRow * cols) - 1);
          newIndex = prevRowLastIndex;
        } else {
          // Vai all'ultima card dell'ultima riga
          newIndex = this.filteredCards.length - 1;
        }
      }
    } else if (direction === 'right') {
      if (currentCol < cols - 1 && this.selectedCardIndex + 1 < this.filteredCards.length) {
        newIndex = this.selectedCardIndex + 1;
      } else {
        // Vai all'inizio della riga successiva
        if (currentRow < rows - 1) {
          newIndex = (currentRow + 1) * cols;
          if (newIndex >= this.filteredCards.length) {
            newIndex = this.filteredCards.length - 1;
          }
        } else {
          // Vai alla prima card
          newIndex = 0;
        }
      }
    }
    
    newIndex = Math.max(0, Math.min(this.filteredCards.length - 1, newIndex));
    
    if (newIndex !== this.selectedCardIndex) {
      this.selectedCardIndex = newIndex;
      this.updateCardSelection();
    }
  }

  // ✅ NUOVO: Navigazione verticale tra le card
  navigateCardsVertical(direction) {
    const grid = document.getElementById('filtered-mosaic-grid');
    const gridRect = grid.getBoundingClientRect();
    const firstCard = this.filteredCards[0];
    
    if (!firstCard) return;
    
    const cardRect = firstCard.getBoundingClientRect();
    const cardWidth = cardRect.width;
    const gridStyle = window.getComputedStyle(grid);
    const gap = parseInt(gridStyle.gap) || 20;
    
    const availableWidth = gridRect.width;
    const cols = Math.floor((availableWidth + gap) / (cardWidth + gap));
    const rows = Math.ceil(this.filteredCards.length / cols);
    
    const currentRow = Math.floor(this.selectedCardIndex / cols);
    const currentCol = this.selectedCardIndex % cols;
    
    let newIndex = this.selectedCardIndex;
    
    if (direction === 'up') {
      if (currentRow > 0) {
        newIndex = Math.max(0, this.selectedCardIndex - cols);
      } else {
        const lastRowStartIndex = (rows - 1) * cols;
        const targetIndex = lastRowStartIndex + currentCol;
        if (targetIndex >= this.filteredCards.length) {
          newIndex = this.filteredCards.length - 1;
        } else {
          newIndex = targetIndex;
        }
      }
    } else if (direction === 'down') {
      if (currentRow < rows - 1) {
        const targetIndex = this.selectedCardIndex + cols;
        if (targetIndex < this.filteredCards.length) {
          newIndex = targetIndex;
        } else {
          newIndex = this.filteredCards.length - 1;
        }
      } else {
        newIndex = currentCol;
        if (newIndex >= this.filteredCards.length) {
          newIndex = 0;
        }
      }
    }
    
    newIndex = Math.max(0, Math.min(this.filteredCards.length - 1, newIndex));
    
    if (newIndex !== this.selectedCardIndex) {
      this.selectedCardIndex = newIndex;
      this.updateCardSelection();
    }
  }

  // ✅ NUOVO: Gestione navigazione temporale con tasti 4 e 5
  handleTimeNavigation(direction) {
    if (direction === 'prev') {
      this.navigateTime(-1);
    } else if (direction === 'next') {
      this.navigateTime(1);
    }
  }

  selectCurrentItem() {
    // ✅ NUOVO: Gestione selezione nel popup
    if (this.navigationMode === 'popup') {
      this.selectCurrentPopupButton();
      return;
    }

    if (this.navigationMode === 'categories') {
      // Seleziona la categoria corrente
      const categoryItems = document.querySelectorAll('.filtered-category-item');
      const selectedCategory = categoryItems[this.selectedCategoryIndex];
      if (selectedCategory) {
        const categoryName = selectedCategory.dataset.filterCategory;
        this.selectCategory(categoryName);
      }
    } else if (this.navigationMode === 'cards') {
      // ===== GESTIONE SELEZIONE CARD MODIFICATA =====
      if (this.filteredCards[this.selectedCardIndex]) {
        const channelNumber = this.filteredCards[this.selectedCardIndex].dataset.channelNumber;
        const channelData = this.epgData.get(channelNumber);
        const program = this.getProgramAtTime(channelData, channelNumber, this.currentTimeOffset);
        
        // Verifica se il programma è futuro
        const isFuture = this.isProgramFuture(program, channelNumber);
        
        if (isFuture && this.currentTimeOffset > 0) {
          // Mostra popup per programmi futuri
          this.showSchedulePopup(channelNumber, program);
        } else {
          // Comportamento normale per programmi correnti
          this.selectChannel(channelNumber);
        }
      }
    }
  }

  selectChannel(channelNumber) {
    // Chiudi il mosaico
    this.closeMosaic();
    
    // Seleziona il canale
    const channel = document.querySelector(`[data-number="${channelNumber}"]`);
    if (channel) {
      const channels = document.querySelectorAll('.channel-item');
      const index = Array.from(channels).indexOf(channel);
      selectChannel(index);
      changeVideo(index);
    }
  }

  startProgressUpdates() {
    // 🚀 MODIFICA: Aggiorna solo le barre di progresso, NON ricarica i dati EPG
    this.updateInterval = setInterval(() => {
      if (this.isActive) {
        this.updateProgressBars();
      }
    }, 30000);
  }

  stopProgressUpdates() {
    if (this.updateInterval) {
      clearInterval(this.updateInterval);
      this.updateInterval = null;
    }
  }

  updateProgressBars() {
    // 🚀 MODIFICA: Aggiorna solo le barre di progresso usando i dati EPG esistenti
    this.filteredCards.forEach(card => {
      const channelNumber = card.dataset.channelNumber;
      const channelData = this.epgData.get(channelNumber);
      const program = this.getProgramAtTime(channelData, channelNumber, this.currentTimeOffset);
      
      if (program) {
        const progress = this.calculateProgress(program, channelNumber);
        const progressFill = card.querySelector('.filtered-mosaic-progress-fill');
        const progressText = card.querySelector('.filtered-mosaic-progress-text');
        
        if (progressFill) {
          progressFill.style.width = progress + '%';
        }
        if (progressText) {
          progressText.textContent = progress + '% completato';
        }
      }
    });
  }

  // 🚫 RIMOSSO: Non più necessario l'aggiornamento periodico automatico
  // startPeriodicUpdate() { ... }

  // 🆕 NUOVO METODO: Forza il ricaricamento manuale dei dati EPG (se necessario)
  async forceReloadEPG() {
    console.log('🔄 Ricaricamento manuale dei dati EPG per mosaico filtrato...');
    this.epgData.clear();
    this.epgLoaded = false;
    await this.loadEPGDataOnce();
    
    if (this.isActive) {
      this.updateCategoryCounts();
      this.generateFilteredCards(this.currentFilter);
      this.updateCardSelection();
      console.log('✅ Mosaico filtrato aggiornato con nuovi dati EPG');
    }
  }
}

// 🚀 Inizializza i sistemi quando il DOM è pronto
document.addEventListener('DOMContentLoaded', () => {
  window.mosaicSystem = new MosaicSystem();
  window.filteredMosaicSystem = new FilteredMosaicSystem();
});

// Inizializza i sistemi
const setupSystem = new SetupSystem();
const pinAuth = new PinAuthSystem();
const mosaicSystem = new MosaicSystem();


    // ===== RESTO DEL CODICE ORIGINALE =====
    let channels = document.querySelectorAll('.channel-item');
    let categories = document.querySelectorAll('.category-item');
    let selectedChannelIndex = 0;
    let selectedCategoryIndex = 0;
    let scrollInterval = null;
    let hideTimeout;
    let skyPanel = document.getElementById('sky-panel');
    let menuTrigger = document.getElementById('menu-trigger');
    let isMenuOpen = false;
    let preventChannelShow = false;
    let mouseTimer;
    let currentCategory = 'tutti';
    let navigationMode = 'channels';
    let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
    let favoritesMode = false;

    // Mappe per il riconoscimento vocale
    const categoryMap = {
      'nazionali': ['nazionali', 'nazionale'],
      'show': ['show', 'serie', 'show e serie'],
      'generali': ['generali', 'generale'],
      'sport': ['sport', 'sportivi', 'sportivo'],
      'cinema': ['cinema', 'film', 'movie'],
      'documentari': ['documentari', 'documentario'],
      'cucina': ['cucina', 'cucine', 'cuciniamo'],
      'news': ['news', 'notizie', 'meteo'],
      'bambini': ['bambini', 'bambino', 'ragazzi', 'cartoni'],
      'musica': ['musica', 'radio'],
      'tutti': ['tutti', 'tutto', 'tutti i canali'],
      'preferiti': ['preferiti', 'preferito', 'salvati']
    };

    const channelMap = {
      '101': ['rai 1', 'rai uno', 'rai1', '101'],
      '102': ['rai 2', 'rai due', 'rai2', '102'],
      '103': ['rai 3', 'rai tre', 'rai3', '103'],
      '104': ['rete 4', 'rete quattro', 'rete4', '104'],
      '105': ['canale 5', 'canale cinque', 'canale5', '105'],
      '106': ['italia 1', 'italia uno', 'italia1', '106'],
      '107': ['la7', 'la 7', '107'],
      '108': ['flix', '108'],
      '109': ['flix', 'flix animation', '109'],
      '117': ['bry', 'bry natura', '117'],
      '118': ['geo', 'geographic', '118'],
      '119': ['tv8', 'tv 8', '119'],
      '120': ['nove', '9', '120'],
      '121': ['gambero', 'gambero rosso', '121'],
      '122': ['20 mediaset', 'venti mediaset', '115'],
      '123': ['rai 4', 'rai quattro', '123'],
      '124': ['rai premium', 'rai premium', '124'],
      '125': ['27 twentyseven', '27 mediaset', '125'],
      '126': ['la5', 'la 5', '126'],
      '127': ['Real Time', 'RealTime', '127'],
      '128': ['La7d', 'La 7d', '128'],
      '129': ['Mediaset Extra', 'Extra', '129'],
      '130': ['Regia 1 gf', 'Gf regia 1', '130'],
      '131': ['Regia 2 gf', 'Gf regia 2', '131'],
      '132': ['Top crime', 'Topcrime', '132'],
      '133': ['Warner TV', 'WarnerTV', '133'],
      '134': ['Dmax', 'D max', '134'],
      '135': ['Italia2', 'Mediaset italia 2', '135'],
      '136': ['Rai4k', 'Rai 4k', '136'],
      '137': ['Giallo', 'giallo', '137'],
      '138': ['Cielo', 'Cielo', '138'],
      '139': ['FoodNetwork', 'Food Network', '139'],
      '140': ['HGTV', 'Home & Garden', '140'],
      '141': ['TV2000', 'tv 2000', '141'],
      '144': ['Mr.bean', 'mr.bean', '144'],
      '150': ['bry sport', 'sport', '150'],
      '152': ['sport italia', 'sportitalia', '152'],
      '200': ['premiere cinema', 'cinema', '200'],
      '215': ['Rakuten azione', 'azione', '215'],
      '216': ['Rakuten commedia', 'commedia', '216'],
      '217': ['Rakuten dramma', 'dramma', '217'],
      '218': ['Rakuten film top', 'film top', '218'],
      '219': ['Rakuten family', 'family', '219'],
      '220': ['iris', '220'],
      '221': ['Cine34', 'cine 34', '221'],
      '222': ['Rai Movie', 'rai movie', '222'],
      '223': ['Duri a Morire', 'Duri a Morire', '223'],
      '300': ['focus', '300'],
      '301': ['Geographic', '301'],
      '302': ['Bry natura', 'Natura', '302'],
      '303': ['Explore Channel', 'Explore', '303'],
      '304': ['FoodNetwork', 'Food', '304'],
      '305': ['HGTV', 'Home & Garden', '305'],
      '306': ['Motortrend', 'Motor trend', '306'],
      '307': ['Gambero rosso', 'Gambero', '307'],
      '308': ['Explore Channel +1', 'Explore +1', '308'],
      '400': ['sky tg24', 'sky', 'tg24', '400'],
      '401': ['Tgcom24', 'tgcom', '24', '401'],
      '402': ['Rai news 24', 'Rai news', '24', '402'],
      '403': ['Euronews', 'Euro news', '403'],
      '404': ['Sicilia 242', '242', '404'],
      '405': ['bry meteo', 'meteo', '405'],
      '501': ['boing', '501'],
      '502': ['K2', 'k2', '502'],
      '503': ['Rai Gulp', 'gulp', '503'],
      '504': ['Rai Yoyo', 'yoyo', '504'],
      '505': ['Frisbee', '505'],
      '506': ['Cartoonito', 'cartoon', '506'],
      '507': ['Super', '507'],
      '508': ['Play Junior', 'Play giunior', 'playjunior', 'play junior', '508'],
      '509': ['Play Junior+1', 'Play giunior +1', '509'],
      '510': ['Play Channel', 'Play channel', 'playchannel', 'play channel', '510'],
      '511': ['Play Channel +1', 'Play channel +1', '511'],
      '512': ['Mr.bean animato', 'bean animato', '512'],
      '600': ['deejay tv', 'deejay', '600'],
      '601': ['Rtl1025', 'Rtl 102.5', '601'],
      '602': ['Radio italia', 'Radioitalia', '602'],
      '603': ['R101', 'R 101', '603'],
      '604': ['Rds', 'RDS', '604'],
      '605': ['BryMusic', 'Bry Music', '605'],
      '606': ['Bry Music Anni90', 'Music Anni 90', '606'],
      '607': ['Radio m2o', 'M2o', '607'],
      '608': ['Radio Freccia', 'Freccia', '608'],
      '609': ['Radio Bruno', 'Bruno', '609'],
      '610': ['Radio Studio+', 'Studio+', '610'],
      '700': ['Tris', 'Tris siracusa', '700'],
      '701': ['Sicilia 242', 'Sicilia242', '701'],
      '100': ['configurazione', '100']
    };

    // Funzioni per gestire i preferiti
    function toggleFavorite(starElement) {
      event.stopPropagation();
      const channelItem = starElement.closest('.channel-item');
      const channelNumber = channelItem.dataset.number;
      
      if (favorites.includes(channelNumber)) {
        favorites = favorites.filter(fav => fav !== channelNumber);
        starElement.textContent = '☆';
        starElement.classList.add('empty');
        showFavoriteNotification('Canale tolto dai preferiti');
      } else {
        favorites.push(channelNumber);
        starElement.textContent = '★';
        starElement.classList.remove('empty');
        showFavoriteNotification('Canale aggiunto ai preferiti');
      }
      
      localStorage.setItem('favorites', JSON.stringify(favorites));
      
      if (currentCategory === 'preferiti') {
        filterChannelsByCategory('preferiti');
      }
      
      // Aggiorna i contatori nel mosaico filtrato se è attivo
      if (filteredMosaicSystem.isActive) {
        filteredMosaicSystem.updateCategoryCounts();
        if (filteredMosaicSystem.currentFilter === 'preferiti') {
          filteredMosaicSystem.generateFilteredCards('preferiti');
          filteredMosaicSystem.updateCardSelection();
        }
      }
    }

    function toggleCurrentChannelFavorite() {
      const currentChannel = channels[selectedChannelIndex];
      if (currentChannel) {
        const star = currentChannel.querySelector('.favorite-star');
        if (star) {
          toggleFavorite(star);
        }
      }
    }

    function loadFavorites() {
      channels.forEach(channel => {
        const channelNumber = channel.dataset.number;
        const star = channel.querySelector('.favorite-star');
        if (favorites.includes(channelNumber)) {
          star.textContent = '★';
          star.classList.remove('empty');
        }
      });
    }

    // Funzione per mostrare la notifica dei preferiti
    function showFavoriteNotification(message) {
      const notification = document.getElementById('favorites-notification');
      const notificationText = document.getElementById('notification-text');
      const notificationIcon = document.getElementById('notification-icon');
      
      // Rimuovi eventuali timeout precedenti
      if (window.favoriteNotificationTimeout) {
        clearTimeout(window.favoriteNotificationTimeout);
      }
      
      // Imposta il messaggio e l'icona
      notificationIcon.textContent = '⭐';
      notificationText.textContent = message;
      notification.classList.remove('favorites-mode');
      
      // Mostra la notifica
      notification.classList.add('show');
      
      // Nascondi dopo 3 secondi
      window.favoriteNotificationTimeout = setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    // Funzioni per gestire il menu
    function openMenu() {
      isMenuOpen = true;
      skyPanel.classList.add('active');
      document.getElementById('fullscreen-btn').classList.add('visible');
      resetHideTimeout();
    }

    function closeMenu() {
      isMenuOpen = false;
      skyPanel.classList.remove('active');
      document.getElementById('fullscreen-btn').classList.remove('visible');
      clearTimeout(hideTimeout);
    }

    function toggleMenu() {
      if (isMenuOpen) {
        closeMenu();
      } else {
        openMenu();
      }
    }

    // MODIFICA: Funzione per mostrare il trigger solo al passaggio del mouse
    function showTrigger() {
      menuTrigger.classList.add('visible');
      clearTimeout(mouseTimer);
      mouseTimer = setTimeout(() => {
        if (!isMenuOpen) {
          menuTrigger.classList.remove('visible');
        }
      }, 3000);
    }

    function resetHideTimeout() {
      clearTimeout(hideTimeout);
      hideTimeout = setTimeout(() => {
        if (isMenuOpen && !preventChannelShow) {
          closeMenu();
        }
      }, 10000);
    }

    // MODIFICA: Funzione per verificare se ci sono elementi aperti
    function hasOpenElements() {
      return mosaicSystem.isActive || filteredMosaicSystem.isActive || isMenuOpen || isPinInputActive || numericSelector.isActive;
    }

    // Event listeners
    document.addEventListener('mousemove', (e) => {
      if (e.isTrusted) {
        showTrigger();
        if (isMenuOpen) {
          resetHideTimeout();
        }
      }
    });

    document.addEventListener('click', (e) => {
      if (e.isTrusted && isMenuOpen) {
        resetHideTimeout();
      }
    });

    menuTrigger.addEventListener('click', toggleMenu);
    document.getElementById('close-panel').addEventListener('click', closeMenu);

    // Gestione delle categorie
    function filterChannelsByCategory(category) {
      currentCategory = category;
      const allChannels = document.querySelectorAll('.channel-item');
      
      categories.forEach(item => {
        item.classList.remove('active');
        if (item.dataset.category === category) {
          item.classList.add('active');
        }
      });

      allChannels.forEach(channel => {
        if (category === 'tutti') {
          channel.style.display = 'flex';
        } else if (category === 'preferiti') {
          const channelNumber = channel.dataset.number;
          if (favorites.includes(channelNumber)) {
            channel.style.display = 'flex';
          } else {
            channel.style.display = 'none';
          }
        } else if (channel.dataset.category === category) {
          channel.style.display = 'flex';
        } else {
          channel.style.display = 'none';
        }
      });

      const titles = {
        'nazionali': 'CANALI NAZIONALI',
        'show': 'SHOW & SERIE',
        'generali': 'CANALI GENERALI',
        'sport': 'CANALI SPORT',
        'cinema': 'CANALI CINEMA',
        'documentari': 'DOCUMENTARI & LIFESTYLE',
        'news': 'NEWS & METEO',
        'bambini': 'BAMBINI & RAGAZZI',
        'musica': 'MUSICA & RADIO',
        'tutti': 'TUTTI I CANALI',
        'preferiti': 'CANALI PREFERITI'
      };
      
      document.querySelector('.channels-title').textContent = titles[category] || 'TUTTI I CANALI';

      const visibleChannels = Array.from(allChannels).filter(ch => ch.style.display !== 'none');
      if (visibleChannels.length > 0) {
        selectChannel(Array.from(allChannels).indexOf(visibleChannels[0]));
      }

      localStorage.setItem('currentCategory', category);
    }

    // Navigazione categorie
    function selectCategory(index) {
      if (index < 0 || index >= categories.length) return;
      
      categories.forEach(c => c.classList.remove('focused'));
      categories[index].classList.add('focused');
      selectedCategoryIndex = index;
      
      categories[index].scrollIntoView({ behavior: 'smooth', block: 'center' });
      
      if (isMenuOpen) resetHideTimeout();
    }

    function activateCategory() {
      const category = categories[selectedCategoryIndex].dataset.category;
      filterChannelsByCategory(category);
      navigationMode = 'channels';
      
      categories.forEach(c => c.classList.remove('focused'));
    }

    // Event listeners per categorie
    categories.forEach((item, index) => {
      item.addEventListener('click', () => {
        selectedCategoryIndex = index;
        activateCategory();
      });
    });

    // Gestione della selezione dei canali
    function selectChannel(index) {
      const visibleChannels = Array.from(channels).filter(ch => ch.style.display !== 'none');
      if (index < 0 || index >= channels.length) return;
      
      channels.forEach(c => c.classList.remove('selected'));
      channels[index].classList.add('selected');
      selectedChannelIndex = index;
      
      channels[index].scrollIntoView({ behavior: 'smooth', block: 'center' });
      
      if (isMenuOpen) resetHideTimeout();
    }

    function changeVideo(index) {
      const channel = channels[index];
      const url = channel.getAttribute('data-url');
      
      document.getElementById('loading-indicator').style.display = 'block';
      
      document.getElementById('iframe-player').src = url;
      const channelNumber = channel.getAttribute('data-number');
      localStorage.setItem('selectedChannel', channelNumber);
      
      // ✅ TRACCIA IL CAMBIO CANALE
      onlineTracker.updateCurrentChannel(channelNumber);
      
      setTimeout(() => {
        document.getElementById('loading-indicator').style.display = 'none';
      }, 2000);
    }

    function scrollChannels(direction, reset = true) {
      if (reset && isMenuOpen) {
        resetHideTimeout();
      }
      
      const visibleChannels = Array.from(channels).filter(ch => ch.style.display !== 'none');
      const currentVisibleIndex = visibleChannels.findIndex(ch => ch.classList.contains('selected'));
      
      if (direction === 'down' && currentVisibleIndex < visibleChannels.length - 1) {
        const nextChannel = visibleChannels[currentVisibleIndex + 1];
        const nextIndex = Array.from(channels).indexOf(nextChannel);
        selectChannel(nextIndex);
      } else if (direction === 'up' && currentVisibleIndex > 0) {
        const prevChannel = visibleChannels[currentVisibleIndex - 1];
        const prevIndex = Array.from(channels).indexOf(prevChannel);
        selectChannel(prevIndex);
      }
      
      changeVideo(selectedChannelIndex);
    }

    function scrollCategories(direction) {
      if (direction === 'right' && selectedCategoryIndex < categories.length - 1) {
        selectCategory(selectedCategoryIndex + 1);
      } else if (direction === 'left' && selectedCategoryIndex > 0) {
        selectCategory(selectedCategoryIndex - 1);
      }
    }

    // Event listeners per i controlli
    document.getElementById('scroll-up-btn').addEventListener('mousedown', (e) => {
      scrollChannels('up', e.isTrusted);
      scrollInterval = setInterval(() => scrollChannels('up', false), 150);
    });
    document.getElementById('scroll-up-btn').addEventListener('mouseup', () => clearInterval(scrollInterval));
    document.getElementById('scroll-up-btn').addEventListener('mouseleave', () => clearInterval(scrollInterval));

    document.getElementById('scroll-down-btn').addEventListener('mousedown', (e) => {
      scrollChannels('down', e.isTrusted);
      scrollInterval = setInterval(() => scrollChannels('down', false), 150);
    });
    document.getElementById('scroll-down-btn').addEventListener('mouseup', () => clearInterval(scrollInterval));
    document.getElementById('scroll-down-btn').addEventListener('mouseleave', () => clearInterval(scrollInterval));

   // ===== GESTIONE TASTIERA MODIFICATA CON NAVIGAZIONE FRECCE =====
document.addEventListener('keydown', (e) => {
  // Se si sta inserendo il PIN, blocca tutti i comandi tranne quelli necessari per il PIN
  if (isPinInputActive) {
    // Permetti solo tasti necessari per il PIN
    const allowedKeys = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'Backspace', 'Tab', 'Enter'];
    if (!allowedKeys.includes(e.key)) {
      e.preventDefault();
      return;
    }
    // Se è Enter e il PIN è completo, lascia che il sistema PIN gestisca
    if (e.key === 'Enter') {
      return;
    }
    // Per i tasti numerici, lascia che gli input PIN li gestiscano
    if (/^[0-9]$/.test(e.key)) {
      return;
    }
    // Per Backspace e Tab, lascia che gli input PIN li gestiscano
    if (e.key === 'Backspace' || e.key === 'Tab') {
      return;
    }
    e.preventDefault();
    return;
  }

  // ===== GESTIONE SELEZIONE NUMERICA =====
  
  // Tasti numerici - aggiungi alla selezione numerica se attiva
  if (/^[0-9]$/.test(e.key) && numericSelector.isActive) {
    const handled = numericSelector.addDigit(e.key);
    if (handled) {
      e.preventDefault();
      return;
    }
  }

  // Backspace - cancella ultimo numero nella selezione numerica
  if (e.key === 'Backspace' && numericSelector.isActive) {
    const handled = numericSelector.backspace();
    if (handled) {
      e.preventDefault();
      return;
    }
  }

  // Enter - forza il cambio canale immediato nella selezione numerica
  if (e.key === 'Enter' && numericSelector.isActive) {
    const handled = numericSelector.forceChannelChange();
    if (handled) {
      e.preventDefault();
      return;
    }
  }

  // ===== GESTIONE FRECCE MODIFICATA =====
  
  // ✅ MODIFICA PRINCIPALE: Freccia SU attiva/disattiva modalità numerica
  if (e.key === 'ArrowUp' && !hasOpenElements()) {
    numericSelector.toggleMode();
    e.preventDefault();
    return;
  }

  // ✅ MODIFICA PRINCIPALE: Freccia GIÙ non apre più il pannello dei canali
  if (e.key === 'ArrowDown' && !hasOpenElements()) {
    // Non fare nulla - la freccia giù non apre più il menu
    e.preventDefault();
    return;
  }

  // Resto della gestione tastiera normale (solo se non si sta inserendo il PIN)
  
  // Tasto 6 - Mosaico normale
  if (e.key === '6') {
    mosaicSystem.toggleMosaic();
    e.preventDefault();
    return;
  }

  // ✅ NUOVO: Tasto 7 - Mosaico filtrato
  if (e.key === '7') {
    filteredMosaicSystem.toggleMosaic();
    e.preventDefault();
    return;
  }

  // Gestione navigazione mosaico normale
  if (mosaicSystem.isActive) {
    if (e.key === 'ArrowLeft') {
      mosaicSystem.navigateMosaic('left');
      e.preventDefault();
      return;
    } else if (e.key === 'ArrowRight') {
      mosaicSystem.navigateMosaic('right');
      e.preventDefault();
      return;
    } else if (e.key === 'ArrowUp') {
      mosaicSystem.navigateMosaic('up');
      e.preventDefault();
      return;
    } else if (e.key === 'ArrowDown') {
      mosaicSystem.navigateMosaic('down');
      e.preventDefault();
      return;
    } else if (e.key === 'Enter') {
      mosaicSystem.selectCurrentCard();
      e.preventDefault();
      return;
    } else if (e.key === 'Escape') {
      mosaicSystem.closeMosaic();
      e.preventDefault();
      return;
    }
  }

  // ✅ NUOVO: Gestione navigazione mosaico filtrato con frecce direzionali
  if (filteredMosaicSystem.isActive) {
    if (e.key === 'ArrowLeft') {
      filteredMosaicSystem.navigate('left');
      e.preventDefault();
      return;
    } else if (e.key === 'ArrowRight') {
      filteredMosaicSystem.navigate('right');
      e.preventDefault();
      return;
    } else if (e.key === 'ArrowUp') {
      filteredMosaicSystem.navigate('up');
      e.preventDefault();
      return;
    } else if (e.key === 'ArrowDown') {
      filteredMosaicSystem.navigate('down');
      e.preventDefault();
      return;
    } else if (e.key === 'Enter') {
      filteredMosaicSystem.selectCurrentItem();
      e.preventDefault();
      return;
    } else if (e.key === 'Escape') {
      filteredMosaicSystem.closeMosaic();
      e.preventDefault();
      return;
    }
  }
  
  // Tasto 8 - Fullscreen
  if (e.key === '8') {
    toggleFullScreen();
    e.preventDefault();
    return;
  }

  // ✅ MODIFICATO: Tasto 4 - Navigazione temporale nel mosaico filtrato, altrimenti canale precedente
  if (e.key === '4') {
    if (filteredMosaicSystem.isActive) {
      filteredMosaicSystem.handleTimeNavigation('prev');
    } else if (favoritesMode) {
      scrollFavorites('up');
    } else {
      scrollChannels('up');
    }
    e.preventDefault();
    return;
  }

  // ✅ MODIFICATO: Tasto 5 - Navigazione temporale nel mosaico filtrato, altrimenti canale successivo
  if (e.key === '5') {
    if (filteredMosaicSystem.isActive) {
      filteredMosaicSystem.handleTimeNavigation('next');
    } else if (favoritesMode) {
      scrollFavorites('down');
    } else {
      scrollChannels('down');
    }
    e.preventDefault();
    return;
  }

  // MODIFICA: Gestione frecce destra/sinistra per navigazione canali (solo se modalità numerica non attiva)
  if (e.key === 'ArrowRight' && !hasOpenElements()) {
    if (favoritesMode) {
      scrollFavorites('down');
    } else {
      scrollChannels('down');
    }
    e.preventDefault();
    return;
  }

  if (e.key === 'ArrowLeft' && !hasOpenElements()) {
    if (favoritesMode) {
      scrollFavorites('up');
    } else {
      scrollChannels('up');
    }
    e.preventDefault();
    return;
  }

  // Tasto 2 - Restart
  if (e.key === '2') {
    rewindIframe();
    e.preventDefault();
    return;
  }

  // Tasto 3 - Preferiti
  if (e.key === '3') {
    toggleFavoritesMode();
    e.preventDefault();
    return;
  }

  // Tasto 1 - Aggiungi/Rimuovi dai preferiti
  if (e.key === '1') {
    toggleCurrentChannelFavorite();
    e.preventDefault();
    return;
  }

  // Tasto 9 per aprire/chiudere menu
  if (e.key === '9') {
    toggleMenu();
    e.preventDefault();
    return;
  }

  // ✅ MODIFICA: Tasto 0 per comando vocale (solo se modalità numerica non attiva)
  if (e.key === '0' && !numericSelector.isActive && !isPinInputActive) {
    if (recognition) {
      startVoiceRecognition();
    }
    e.preventDefault();
    return;
  }

  // ✅ MODIFICA: Gestione frecce quando i mosaici sono aperti
  if (mosaicSystem.isActive || filteredMosaicSystem.isActive) {
    // Nel mosaico, le frecce sono già gestite sopra, quindi non fare nient'altro
    return;
  }
  
  if (isMenuOpen) {
    resetHideTimeout();
    
    if (navigationMode === 'categories') {
      if (e.key === 'ArrowRight') {
        scrollCategories('right');
        e.preventDefault();
      } else if (e.key === 'ArrowLeft') {
        scrollCategories('left');
        e.preventDefault();
      } else if (e.key === 'Enter') {
        activateCategory();
        e.preventDefault();
      }
    } else if (navigationMode === 'channels') {
      if (e.key === 'ArrowDown') {
        scrollChannels('down');
        e.preventDefault();
      } else if (e.key === 'ArrowUp') {
        scrollChannels('up');
        e.preventDefault();
      } else if (e.key === 'ArrowLeft') {
        navigationMode = 'categories';
        selectCategory(selectedCategoryIndex);
        e.preventDefault();
      } else if (e.key === 'Enter') {
        changeVideo(selectedChannelIndex);
        e.preventDefault();
      }
    }
    
    if (e.key === 'Escape') {
      closeMenu();
      e.preventDefault();
    }
  }
  
  if (e.key === 'f' || e.key === 'F') {
    toggleFullScreen();
    e.preventDefault();
  }
});


    // Gestione modalità preferiti
    function toggleFavoritesMode() {
      if (!favoritesMode) {
        // Entra in modalità preferiti
        if (favorites.length > 0) {
          favoritesMode = true;
          showFavoritesNotification(true);
          const firstFavorite = document.querySelector(`[data-number="${favorites[0]}"]`);
          if (firstFavorite) {
            const index = Array.from(channels).indexOf(firstFavorite);
            selectChannel(index);
            changeVideo(index);
          }
        } else {
          // Se non ci sono preferiti, mostra un messaggio diverso
          showFavoritesNotification(true, true);
        }
      } else {
        // Esce dalla modalità preferiti
        favoritesMode = false;
        showFavoritesNotification(false);
        // Torna alla visualizzazione normale
        filterChannelsByCategory(currentCategory);
      }
    }

    // Funzione per mostrare le notifiche della modalità preferiti
    function showFavoritesNotification(isEntering, noFavorites = false) {
      const notification = document.getElementById('favorites-notification');
      const notificationText = document.getElementById('notification-text');
      const notificationIcon = document.getElementById('notification-icon');
      
      // Rimuovi eventuali timeout precedenti
      if (window.favoritesNotificationTimeout) {
        clearTimeout(window.favoritesNotificationTimeout);
      }
      
      if (isEntering) {
        if (noFavorites) {
          notification.classList.remove('favorites-mode');
          notificationIcon.textContent = '⚠️';
          notificationText.textContent = 'Nessun canale nei preferiti. Aggiungi canali con il tasto ★';
        } else {
          notification.classList.add('favorites-mode');
          notificationIcon.textContent = '⭐';
          notificationText.textContent = `Modalità Preferiti Attivata - ${favorites.length} canali disponibili`;
        }
      } else {
        notification.classList.remove('favorites-mode');
        notificationIcon.textContent = '📺';
        notificationText.textContent = 'Modalità Normale - Tutti i canali disponibili';
      }
      
      // Mostra la notifica
      notification.classList.add('show');
      
      // Nascondi dopo 3 secondi
      window.favoritesNotificationTimeout = setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    function scrollFavorites(direction) {
      if (favorites.length === 0) return;
      
      const currentChannel = channels[selectedChannelIndex];
      const currentNumber = currentChannel.dataset.number;
      const currentFavIndex = favorites.indexOf(currentNumber);
      
      let nextFavIndex;
      if (direction === 'down') {
        nextFavIndex = (currentFavIndex + 1) % favorites.length;
      } else {
        nextFavIndex = (currentFavIndex - 1 + favorites.length) % favorites.length;
      }
      
      const nextFavoriteNumber = favorites[nextFavIndex];
      const nextFavoriteChannel = document.querySelector(`[data-number="${nextFavoriteNumber}"]`);
      
      if (nextFavoriteChannel) {
        const index = Array.from(channels).indexOf(nextFavoriteChannel);
        selectChannel(index);
        changeVideo(index);
      }
    }

    // Fullscreen
    function toggleFullScreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
          console.log(`Errore fullscreen: ${err.message}`);
        });
      } else {
        document.exitFullscreen();
      }
    }

    document.getElementById('fullscreen-btn').addEventListener('click', toggleFullScreen);

    // Click sui canali
    channels.forEach((channel, index) => {
      channel.addEventListener('click', () => {
        selectChannel(index);
        changeVideo(index);
      });
    });

    // Funzione rewind
    function rewindIframe() {
      document.getElementById("iframe-player").contentWindow.postMessage("rewind", "*");
    }

    document.getElementById('restart-btn').addEventListener('click', rewindIframe);

    // Riconoscimento vocale
    let recognition;
    let recognitionActive = false;

    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'it-IT';
      recognition.continuous = false;
      recognition.interimResults = false;

      function startVoiceRecognition() {
        recognitionActive = true;
        recognition.start();
        document.getElementById('voice-overlay').style.display = 'flex';
        document.getElementById('voice-text').textContent = 'Pronuncia il nome del canale o il numero';

        const autoResetTimer = setTimeout(() => {
          if (recognitionActive) {
            recognition.abort();
            resetVoiceRecognition();
          }
        }, 8000);

        recognition.onresult = (event) => {
          const spokenText = event.results[0][0].transcript.toLowerCase().trim();
          console.log('Riconosciuto:', spokenText);
          document.getElementById('voice-text').textContent = `Riconosciuto: ${spokenText}`;

          processVoiceCommand(spokenText);

          clearTimeout(autoResetTimer);
          setTimeout(() => {
            resetVoiceRecognition();
          }, 1500);
        };

        recognition.onend = () => {
          clearTimeout(autoResetTimer);
          resetVoiceRecognition();
        };

        recognition.onerror = (event) => {
          console.error('Errore riconoscimento vocale:', event.error);
          clearTimeout(autoResetTimer);
          resetVoiceRecognition();
        };
      }

      function processVoiceCommand(spokenText) {
        // Comando mosaico normale
        if (spokenText.includes('mosaico')) {
          mosaicSystem.toggleMosaic();
          return;
        }

        // ✅ NUOVO: Comando mosaico filtrato
        if (spokenText.includes('filtro') || spokenText.includes('filtri') || spokenText.includes('categoria')) {
          filteredMosaicSystem.toggleMosaic();
          return;
        }

        // Comandi di controllo player
        if (spokenText === "pausa") {
          document.getElementById("iframe-player").contentWindow.postMessage("pause", "*");
          return;
        } else if (spokenText === "riprendi") {
          document.getElementById("iframe-player").contentWindow.postMessage("play", "*");
          return;
        } else if (spokenText === "live") {
          document.getElementById("iframe-player").contentWindow.postMessage("live", "*");
          return;
        } else if (spokenText.includes("indietro")) {
          let match = spokenText.match(/indietro di (\d+)\s*(secondi|minuti)/);
          if (match) {
            let amount = parseInt(match[1]);
            if (match[2] === "minuti") amount *= 60;
            document.getElementById("iframe-player").contentWindow.postMessage({ action: "rewind", seconds: amount }, "*");
          } else {
            document.getElementById("iframe-player").contentWindow.postMessage("indietro", "*");
          }
          return;
        } else if (spokenText === "restart" || spokenText === "riavvia") {
          document.getElementById("iframe-player").contentWindow.postMessage("restart", "*");
          return;
        }

        // Gestione apertura categorie
        let categoryFound = false;
        for (const [categoryKey, categoryAliases] of Object.entries(categoryMap)) {
          for (const alias of categoryAliases) {
            if (spokenText.includes('apri') && spokenText.includes(alias) || 
                spokenText.includes('sezione') && spokenText.includes(alias)) {
              if (!isMenuOpen) openMenu();
              filterChannelsByCategory(categoryKey);
              categoryFound = true;
              break;
            }
          }
          if (categoryFound) break;
        }

        if (categoryFound) return;

        // Gestione selezione canali
        let channelFound = false;
        
        const numberMatch = spokenText.match(/\b(\d{3})\b/);
        if (numberMatch) {
          const channelNumber = numberMatch[1];
          const channel = document.querySelector(`[data-number="${channelNumber}"]`);
          if (channel) {
            const originalCategory = currentCategory;
            if (currentCategory !== 'tutti') {
              filterChannelsByCategory('tutti');
            }
            
            const index = Array.from(channels).indexOf(channel);
            selectChannel(index);
            changeVideo(index);
            channelFound = true;
            
            if (spokenText.includes('preferiti') || spokenText.includes('salva') || spokenText.includes('salvati')) {
              const star = channel.querySelector('.favorite-star');
              if (star && star.classList.contains('empty')) {
                toggleFavorite(star);
              }
            }
          }
        }

        if (!channelFound) {
          for (const [channelNumber, channelAliases] of Object.entries(channelMap)) {
            for (const alias of channelAliases) {
              if (spokenText.includes(alias)) {
                const channel = document.querySelector(`[data-number="${channelNumber}"]`);
                if (channel) {
                  const originalCategory = currentCategory;
                  if (currentCategory !== 'tutti') {
                    filterChannelsByCategory('tutti');
                  }
                  
                  const index = Array.from(channels).indexOf(channel);
                  selectChannel(index);
                  changeVideo(index);
                  channelFound = true;
                  
                  if (spokenText.includes('preferiti') || spokenText.includes('salva') || spokenText.includes('salvati')) {
                    const star = channel.querySelector('.favorite-star');
                    if (star && star.classList.contains('empty')) {
                      toggleFavorite(star);
                    }
                  }
                  break;
                }
              }
            }
            if (channelFound) break;
          }
        }

        if (!channelFound) {
          console.log("Comando non riconosciuto: " + spokenText);
        }
      }

      function resetVoiceRecognition() {
        recognitionActive = false;
        document.getElementById('voice-overlay').style.display = 'none';
        document.getElementById('voice-text').textContent = '';
      }

      document.getElementById('voice-btn').addEventListener('click', startVoiceRecognition);
    }

    // ✅ MODIFICATO: Gestione messaggi da iframe con supporto tasto 7
    window.addEventListener("message", function(event) {
      if (event.data && event.data.action) {
        if (event.data.action === "toggleFullscreen") {
          toggleFullScreen();
        } else if (event.data.action === "simulateClick") {
          const key = event.data.key;
          if (key === '3' && recognition && !isPinInputActive) {
            startVoiceRecognition();
          } else if (key === '2' && !isPinInputActive) {
            rewindIframe();
          } else if (key === '1' && !isPinInputActive) {
            toggleCurrentChannelFavorite();
          } else if (key === '4' && !isPinInputActive) {
            if (filteredMosaicSystem.isActive) {
              filteredMosaicSystem.handleTimeNavigation('prev');
            } else if (favoritesMode) {
              scrollFavorites('up');
            } else {
              scrollChannels('up');
            }
          } else if (key === '5' && !isPinInputActive) {
            if (filteredMosaicSystem.isActive) {
              filteredMosaicSystem.handleTimeNavigation('next');
            } else if (favoritesMode) {
              scrollFavorites('down');
            } else {
              scrollChannels('down');
            }
          } else if (key === '6' && !isPinInputActive) {
            mosaicSystem.toggleMosaic();
          } else if (key === '7' && !isPinInputActive) {
            // ✅ NUOVO: Gestione tasto 7 da iframe
            filteredMosaicSystem.toggleMosaic();
          }
        }
      }
    });

    // Inizializzazione
    window.onload = () => {
      menuTrigger.classList.remove('visible');
      document.getElementById('fullscreen-btn').classList.remove('visible');
    };

    // ===== FUNZIONI GLOBALI PER ACCESSO ALLE STATISTICHE =====
    window.getOnlineUsersCount = () => {
      return parseInt(document.getElementById('online-counter').textContent) || 0;
    };

    window.getChannelStats = () => {
      try {
        const statsText = document.getElementById('channel-stats').innerHTML;
        return statsText ? JSON.parse(statsText) : [];
      } catch (error) {
        console.error('Errore parsing statistiche canali:', error);
        return [];
      }
    };

    window.getRealTimeStats = async () => {
      if (onlineTracker) {
        return await onlineTracker.getRealTimeStats();
      }
      return { onlineUsers: 0, topChannels: [] };
    };

    // 🆕 NUOVE FUNZIONI GLOBALI: Per forzare il ricaricamento manuale dei dati EPG
    window.forceReloadMosaicEPG = () => {
      if (mosaicSystem) {
        mosaicSystem.forceReloadEPG();
      }
    };

    window.forceReloadFilteredMosaicEPG = () => {
      if (filteredMosaicSystem) {
        filteredMosaicSystem.forceReloadEPG();
      }
    };

    // Log delle statistiche ogni 5 minuti (solo per debug)
    setInterval(async () => {
      const stats = await window.getRealTimeStats();
      console.log('📊 Statistiche Real-Time:', stats);
    }, 5 * 60 * 1000); // 5 minuti
    
    
    
    // ===== FUNZIONI PER VISUALIZZARE STATISTICHE FIREBASE =====

// Funzione per visualizzare utenti online in tempo reale
window.showOnlineUsers = async () => {
  try {
    const activeUsers = await db.collection('onlineUsers')
      .where('isActive', '==', true)
      .get();

    console.log('👥 UTENTI ONLINE ATTUALMENTE:');
    console.log('Totale utenti online:', activeUsers.size);
    
    activeUsers.forEach(doc => {
      const userData = doc.data();
      console.log(`- ${userData.userName} (PIN: ${userData.userId}) - Canale: ${userData.currentChannel || 'N/A'}`);
    });
    
    return activeUsers.size;
  } catch (error) {
    console.error('❌ Errore recupero utenti online:', error);
    return 0;
  }
};

// Funzione per visualizzare statistiche canali più visti
window.showChannelStats = async () => {
  try {
    const stats = await db.collection('channelStats')
      .orderBy('totalViews', 'desc')
      .limit(10)
      .get();

    console.log('📊 TOP 10 CANALI PIÙ VISTI:');
    
    stats.forEach((doc, index) => {
      const data = doc.data();
      console.log(`${index + 1}. Canale ${data.channelNumber} - ${data.totalViews} visualizzazioni - ${data.currentViewers || 0} spettatori attuali`);
    });
    
    return stats.docs.map(doc => doc.data());
  } catch (error) {
    console.error('❌ Errore recupero statistiche canali:', error);
    return [];
  }
};

// Funzione per visualizzare tutte le statistiche insieme
window.showAllStats = async () => {
  console.log('📈 === STATISTICHE COMPLETE FIREBASE ===');
  
  const onlineCount = await window.showOnlineUsers();
  console.log('');
  await window.showChannelStats();
  
  console.log('');
  console.log('🔄 Per aggiornare le statistiche, richiama: showAllStats()');
  
  return {
    onlineUsers: onlineCount,
    channelStats: await window.showChannelStats()
  };
};

// Avvia monitoraggio automatico ogni 2 minuti
setInterval(async () => {
  const stats = await window.getRealTimeStats();
  console.log('📊 Aggiornamento automatico statistiche:', {
    utentiOnline: stats.onlineUsers,
    topCanali: stats.topChannels.slice(0, 3) // Mostra solo i primi 3
  });
}, 2 * 60 * 1000); // Ogni 2 minuti

    
</script>


</body>
</html>
