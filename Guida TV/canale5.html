<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guida TV</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        /* Banner */
        #banner {
            color: #fff;
            padding: 10px 20px;
            text-align: center;
            font-size: 20px;
            width: 100%;
            top: 0;
            left: 0;
            z-index: 10;
        }

        #clock {
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            margin-top: 5px;
        }

        /* Contenitore principale */
        #tv-guide {
            max-width: 1300px;
            margin-top: -100px;
            border-radius: 10px;
            overflow: hidden;
            width: 100%;
            position: relative;
            background: linear-gradient(0deg, rgb(15 26 45 / 0%) -0.02%, #22214e 24.88%, #150a23 49.79%, rgb(32 34 64) 74.7%, #43507b 99.6%);
        }

        /* Programmi */
        .program-item {
            padding: 30px;
            margin-bottom: 10px;
            background-color: #353c69;
            border-radius: 8px;
        }

        .program-item h3 {
            margin: 5px 0;
            color: #3498db;
            font-size: xx-large;
        }

        .program-item p {
            margin: 5px 0;
            color: #bbb;
            font-size: large;
        }

        .program-item .time {
            font-size: 17px;
            color: #1da676;
        }

        .program-item.now {
            background-color: #353c69eb;
        }

        .program-item img {
            max-width: 30%;
            border-radius: 8px;
            margin-top: 10px;
        }

        /* Progress bar */
        .progress-bar-container {
            margin-top: 20px;
            width: 100%;
        }

        progress {
            width: 100%;
            height: 20px;
            border-radius: 10px;
            background: linear-gradient(#ffffff42, #353c69);
            overflow: hidden;
            position: relative;
        }

        progress::-webkit-progress-value {
            background-color: #ffffffcc;
            border-radius: 10px;
        }

        progress::-webkit-progress-bar {
            background-color: #ffffff42;
        }

        #time-remaining {
            margin-top: 5px;
            font-size: 19px;
            color: #fff;
        }

        /* Icona del prossimo programma */
        .date-selector {
            position: absolute;
            right: 45px;
            top: 50%;
            transform: translateY(-50%);
        }

        .date-selector img {
            cursor: pointer;
            width: 40px;
            height: 40px;
            transition: transform 0.3s ease;
        }

        .date-selector img:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <!-- Barra con orologio -->
    <div id="tv-guide">
        <div id="banner">
            <div id="clock"></div>
        </div>
        <div id="current-program" class="program-list">
            <!-- Mostra il programma in onda -->
        </div>
        <div class="date-selector">
            <img src="https://i.ibb.co/cQPLbg5/keyboard-right-arrow-button-1-icon-icons-com-72690.png" alt="Vedi il prossimo programma" class="next-program-icon" onclick="showNextProgram()">
        </div>
    </div>

   <script>
    function updateClock() {
        const now = new Date();
        const options = { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        };
        const formattedDate = now.toLocaleDateString('it-IT', options);
        const formattedTime = now.toLocaleTimeString('it-IT', { 
            hour: '2-digit', 
            minute: '2-digit', 
            second: '2-digit', 
            hour12: false 
        });
        document.getElementById('clock').innerText = `${formattedDate} | ${formattedTime}`;
    }

    setInterval(updateClock, 1000);
    updateClock();

    let data = [];
    let currentProgramIndex = 0;
    let attemptCount = 0;
    let progressInterval;

    async function loadEPGData() {
        try {
            const url = "https://brymeteo.github.io/player/Guida%20TV/list.json";
            const response = await fetch(url);

            if (!response.ok) throw new Error('Errore nel caricamento dei dati');
            const epgData = await response.json();
            data = epgData.filter(channel => channel.name === 'Canale 5');

            if (data.length === 0) {
                showFallbackMessage();
            } else {
                showCurrentProgram();
            }
        } catch (error) {
            console.error('Errore:', error);
            showFallbackMessage();
        }
    }

    function showFallbackMessage() {
        const programList = document.getElementById('current-program');
        programList.innerHTML = `
            <div class="program-item now">
                <h3>Guida TV non disponibile</h3>
                <p>Al momento non possiamo mostrare la guida TV. Riprova pi√π tardi.</p>
                <img src="https://wips.plug.it/cips/tecnologia/cms/2021/06/nessun-segnale-tv.jpg" alt="Fallback Image">
            </div>
        `;

        clearInterval(progressInterval);
    }

    function showCurrentProgram() {
        const currentTime = new Date();
        const channel = data[0];
        const currentProgram = channel.programs.find(program => currentTime >= new Date(program.start) && currentTime <= new Date(program.end));

        if (currentProgram) {
            const programList = document.getElementById('current-program');
            programList.innerHTML = `
                <div class="program-item now">
                    <h3>${currentProgram.title}</h3>
                    <p>${currentProgram.description}</p>
                    <p class="time"><strong>Inizio Programma:</strong> ${new Date(currentProgram.start).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit', hour12: false })} <br><strong>Fine Programma:</strong> ${new Date(currentProgram.end).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit', hour12: false })}</p>
                    ${currentProgram.poster ? `<img src="${currentProgram.poster}" alt="${currentProgram.title} poster">` : `<p>Immagine non disponibile</p>`}
                    <div class="progress-bar-container">
                        <progress id="progress-bar" value="0" max="100"></progress>
                        <div id="time-remaining">Tempo rimanente: --</div>
                    </div>
                </div>
            `;
            currentProgramIndex = channel.programs.indexOf(currentProgram) + 1;
            updateProgressBar(currentProgram);
        } else {
            showFallbackMessage();
        }
    }

    function updateProgressBar(currentProgram) {
        const currentTime = new Date();
        const startTime = new Date(currentProgram.start);
        const endTime = new Date(currentProgram.end);
        const duration = endTime - startTime;
        const elapsed = currentTime - startTime;

        if (elapsed >= 0 && elapsed <= duration) {
            const progress = (elapsed / duration) * 100;
            const remainingTime = endTime - currentTime;
            const remainingMinutes = Math.ceil(remainingTime / (1000 * 60));

            document.getElementById('progress-bar').value = progress;
            document.getElementById('time-remaining').innerText = `Tempo rimanente: ${remainingMinutes} min`;
        }

        if (progressInterval) clearInterval(progressInterval);
        progressInterval = setInterval(() => updateProgressBar(currentProgram), 1000);
    }

    function showNextProgram() {
        const channel = data[0];
        const programList = document.getElementById('current-program');

        if (attemptCount < 2) {
            if (currentProgramIndex < channel.programs.length) {
                const nextProgram = channel.programs[currentProgramIndex];
                programList.innerHTML = `
                    <div class="program-item">
                        <h3>${nextProgram.title}</h3>
                        <p>${nextProgram.description}</p>
                        <p class="time"><strong>Inizio Programma:</strong> ${new Date(nextProgram.start).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit', hour12: false })} <br><strong>Fine Programma:</strong> ${new Date(nextProgram.end).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit', hour12: false })}</p>
                        ${nextProgram.poster ? `<img src="${nextProgram.poster}" alt="${nextProgram.title} poster">` : `<p>Immagine non disponibile</p>`}
                        <div class="progress-bar-container">
                            <progress id="progress-bar" value="0" max="100"></progress>
                            <div id="time-remaining">Tempo rimanente: --</div>
                        </div>
                    </div>
                `;
                currentProgramIndex++;
                attemptCount++;
                clearInterval(progressInterval);
            } else {
                programList.innerHTML = `<p>Non ci sono altri programmi disponibili.</p>`;
            }
        }

        if (attemptCount >= 2) {
            setTimeout(() => {
                showCurrentProgram();
                attemptCount = 0;
            }, 5000);
        }
    }

    loadEPGData();
</script>

</body>
</html>
